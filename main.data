precision mediump float;

varying vec4 varColor;
varying vec2 varTexcoord;
uniform sampler2D uTexture;

void main(){
  vec4 color = texture2D(uTexture, varTexcoord);
  gl_FragColor = color * varColor;
}

attribute vec2 vPosition;
attribute vec2 vTexcoord;
attribute vec4 vColor;

varying vec2 varTexcoord;
varying vec4 varColor;

uniform mat4 uProjection;
uniform mat4 uModel;
uniform mat4 uView;
uniform vec2 uTextureSize;


void main(){
  varColor = vColor;
  varTexcoord = vTexcoord / uTextureSize;

  vec4 position = uProjection * uModel * uView * vec4(vPosition.xy, 0.0, 1.0);
  position.z = 0.0;

  gl_Position = position;
}//
// Description : Array and textureless GLSL 2D simplex noise function.
//      Author : Ian McEwan, Ashima Arts.
//  Maintainer : stegu
//     Lastmod : 20110822 (ijm)
//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.
//               Distributed under the MIT License. See LICENSE file.
//               https://github.com/ashima/webgl-noise
//               https://github.com/stegu/webgl-noise
// 
precision mediump float;

vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v)
  {
  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0
                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)
                     -0.577350269189626,  // -1.0 + 2.0 * C.x
                      0.024390243902439); // 1.0 / 41.0
// First corner
  vec2 i  = floor(v + dot(v, C.yy) );
  vec2 x0 = v -   i + dot(i, C.xx);

// Other corners
  vec2 i1;
  //i1.x = step( x0.y, x0.x ); // x0.x > x0.y ? 1.0 : 0.0
  //i1.y = 1.0 - i1.x;
  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  // x0 = x0 - 0.0 + 0.0 * C.xx ;
  // x1 = x0 - i1 + 1.0 * C.xx ;
  // x2 = x0 - 1.0 + 2.0 * C.xx ;
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;

// Permutations
  i = mod289(i); // Avoid truncation effects in permutation
  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
		+ i.x + vec3(0.0, i1.x, 1.0 ));

  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m ;
  m = m*m ;

// Gradients: 41 points uniformly over a line, mapped onto a diamond.
// The ring size 17*17 = 289 is close to a multiple of 41 (41*7 = 287)

  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;

// Normalise gradients implicitly by scaling m
// Approximation of: m *= inversesqrt( a0*a0 + h*h );
  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );

// Compute final noise value at P
  vec3 g;
  g.x  = a0.x  * x0.x  + h.x  * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}

varying vec2 varTexcoord;
//varying vec4 varColor;
//varying vec3 varNormal;
varying vec3 varPos;

uniform float t;
uniform sampler2D uTexture;
//uniform vec3 uLight0;

void main(){

  vec4 color = texture2D(uTexture, varTexcoord, -1.0);
  //vec4 color = varColor;

  // fog
  const float LOG2 = 1.442695;
  float z = gl_FragCoord.z / gl_FragCoord.w;
  float density = 0.03;
  float fogFactor = exp2( -density * // -Density
            density * // Density
            z * 
            z * 
            LOG2 );
  //float  fogFactor = (1.0-z*0.02);
  //fogFactor = smoothstep(0.0, 0.5, fogFactor);

  //float volume = abs((cos(varPos.z/2.0+t*0.25) * sin(varPos.x/4.0+t*0.125)));
  //volume = smoothstep(0.2, 1.0, volume) * 0.5;
  float volume = clamp(snoise(vec2(varPos.x/16.0+t*0.1, varPos.z/8.0+t*0.2)), 0.0, 1.0) * 0.4; 
  //float volume = 0.0;
  //light
  // vec3 norm = normalize(varNormal);
  // vec3 lightDir = normalize(uLight0 - varPos);
  // float diff = max(dot(norm, lightDir), 0.0);
  // vec3 diffuse = diff * vec3(1.0);  // Light color
  // color = color * vec4(diffuse, 1.0);

  gl_FragColor = mix(vec4(1.0,1.0,1.0,1.0), color * (1.0-volume), 1.0);
}


vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v)
  {
  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0
                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)
                     -0.577350269189626,  // -1.0 + 2.0 * C.x
                      0.024390243902439); // 1.0 / 41.0
// First corner
  vec2 i  = floor(v + dot(v, C.yy) );
  vec2 x0 = v -   i + dot(i, C.xx);

// Other corners
  vec2 i1;
  //i1.x = step( x0.y, x0.x ); // x0.x > x0.y ? 1.0 : 0.0
  //i1.y = 1.0 - i1.x;
  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  // x0 = x0 - 0.0 + 0.0 * C.xx ;
  // x1 = x0 - i1 + 1.0 * C.xx ;
  // x2 = x0 - 1.0 + 2.0 * C.xx ;
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;

// Permutations
  i = mod289(i); // Avoid truncation effects in permutation
  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
		+ i.x + vec3(0.0, i1.x, 1.0 ));

  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m ;
  m = m*m ;

// Gradients: 41 points uniformly over a line, mapped onto a diamond.
// The ring size 17*17 = 289 is close to a multiple of 41 (41*7 = 287)

  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;

// Normalise gradients implicitly by scaling m
// Approximation of: m *= inversesqrt( a0*a0 + h*h );
  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );

// Compute final noise value at P
  vec3 g;
  g.x  = a0.x  * x0.x  + h.x  * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}

attribute vec3 vPosition;
attribute vec2 vTexcoord;
//attribute vec4 vColor;
//attribute vec3 vNormal;

varying vec2 varTexcoord;
//varying vec4 varColor;
//varying vec3 varNormal;
varying vec3 varPos;

uniform mat4 uProjection;
uniform mat4 uModel;
uniform mat4 uView;

void main(){
  //varNormal = mat3(uNormal) * vNormal;
  //varNormal = vNormal;
  //varPos = vec3(uModel * vec4(vPosition, 1.0));
  //vec4 color = vColor;

  vec4 world = uModel * vec4(vPosition,1.0);
  float z = mix(snoise(world.xz/16.0),snoise(world.xz/32.0), 0.75);
  vec4 position = uProjection * uView * world;
  position.y += z*3.0;

  //color = vColor;
  varPos = world.xyz;
  varTexcoord = vTexcoord;
  //varColor = color;

  gl_Position = position;
}precision mediump float;

varying vec4 varColor;

void main(){

  gl_FragColor = varColor;
}attribute vec3 vPosition;
attribute vec3 vNormal;
attribute vec2 vTexcoord;

varying vec4 varColor;

uniform mat4 uProjection;
uniform mat4 uModel;
uniform mat4 uView;
uniform sampler2D uTexture;

uniform vec3 uLight;
const vec4 black = vec4(0.1,0.0,0.2,1.0);
const vec4 white = vec4(1.0,0.8,0.5,1.0);

void main(){
  vec3 lightDir = normalize(uLight);
  float d = dot(vNormal, lightDir);
  float x = (d + 1.0) / 2.0;
  float y = vTexcoord.y;
  float offset = vTexcoord.x - 0.5;


  vec4 color = texture2D(uTexture, vec2(x+offset,y));

  varColor = color;
  //varColor = vec4(normalize(vNormal),1.0) + vec4(vColor*0.0);
  gl_Position = uProjection * uView * uModel * vec4(vPosition,1.0);
}

precision mediump float;

uniform mat4 uProjection;

varying vec4 varColor;
varying vec3 varPos;

const vec4 up = vec4(0.0,1.0,0.0,1.0);
const vec4 black = vec4(0.0,0.0,0.0,1.0);

void main(){
  vec4 c = varColor;
  vec4 pos = vec4(varPos.x, 1.0, varPos.z, 1.0);
  pos = pos * uProjection;
  pos = pos * (1.0/pos.w);
  pos = normalize(pos);

  float d = (dot(pos, up)+1.0)/2.0;
  c = mix(black, c, d);

  gl_FragColor = vec4(d,d,d,1.0);
}attribute vec3 vPosition;
attribute vec4 vColor;

uniform mediump mat4 uProjection;


varying vec4 varColor;
varying vec3 varPos;

void main(){
  varColor = vColor;
  varPos = vPosition;
  
  gl_Position = vec4(vPosition,1.0);
}

precision mediump float;

uniform sampler2D uTexture;
//uniform sampler2D uNoise;
uniform vec3 uFogColor;
uniform vec2 uTextureSize;

varying vec2 varTexcoord;
varying vec4 varColor;

float dither(float v, float m){
  v = m - floor(v*m);
  return clamp(mod(gl_FragCoord.x+m,v), 0.0, 1.0);
}

void main(){

  const float LOG2 = 1.442695;
  float z = gl_FragCoord.z / gl_FragCoord.w;
  float density = 0.03;
  float fogFactor = exp2( -density * // -Density
            density * // Density
            z * 
            z * 
            LOG2 );
  //z = z / 25.0;
  //float fogFactor = 1.0-z;
  //fogFactor = floor(fogFactor * 10.0) / 10.0;
  //fogFactor = dither(fogFactor, 32.0);
  // dither
  // float noise = texture2D(uNoise, gl_FragCoord.xy/255.0).x;
  // fogFactor = floor(smoothstep(0.4,0.6,noise+fogFactor)*2.0)/2.0;
  
  fogFactor = smoothstep(0.0,0.7,fogFactor);
  vec4 fogColor = vec4(uFogColor/255.0, 1.0);
  vec4 fac = varColor;
  vec4 color = texture2D(uTexture, varTexcoord/uTextureSize) * fac;

  if(color.a < 1.0) discard;

  //vec2 noisecoord = mod(varTexcoord, 32.0);
  //float noise = texture2D(uTexture, noisecoord/uTextureSize).r;
  //fogFactor = mix(noise,1.0,fogFactor);
  //fogFactor = floor(smoothstep(0.0,0.8,(fogFactor)*(noise+1.0)) * 4.0) / 4.0;
  
  gl_FragColor = mix(fogColor, color, fogFactor);
  //gl_FragColor = vec4(z,z,z,1.0);
}

attribute vec3 vPosition;
attribute vec2 vTexcoord;
attribute vec4 vColor;
attribute vec3 vOffset;
//attribute vec3 vNormal;

varying vec2 varTexcoord;
varying vec4 varColor;
//varying vec4 varColor;
//varying vec3 varNormal;
//varying vec3 varPos;

uniform mat4 uProjection;
uniform mat4 uModel;
uniform mat4 uView;
uniform sampler2D uTexture;

void main(){
  varTexcoord = vTexcoord;
  varColor = vColor;
  //vec2 uv = (vPosition.xz + 5.0) / 10.0;
  //float y = texture2D(uTexture, uv).x * 5.0;
  vec4 world = uModel * vec4(vPosition,1.0);
  world = world + vec4(vOffset, 0.0); 
  //world.y = y;
  gl_Position = uProjection * uView * world;
}import "graphics" for Renderer, Geometry, Mesh, UniformType, Shader, DiffuseMaterial, Colors, Texture, TextureFilters, BufferUsage, GraphicsBuffer, Attribute, VertexIndices
import "memory" for FloatVecAccessor, UShortAccessor, UByteVecAccessor, Buffer, BufferView, DataType, ListUtil
import "geometry" for AttributeType, GeometryData, GeometryWriter
import "math" for Vec2, Mat4

class Quad {

  static empty { EmptyQuad }

  a { _a }
  b { _b }
  c { _c }
  d { _d }
  w { _c[0] - _a[0] }
  h { _c[1] - _a[1] }
  x { _a[0] }
  y { _a[1] }

  construct new(x,y,w,h){
    _a = [x,y]
    _b = [x,y+h]
    _c = [x+w,y+h]
    _d = [x+w,y]
  }
  construct clone(q){
    _a = Vec2.clone(q.a)
    _b = Vec2.clone(q.b)
    _c = Vec2.clone(q.c)
    _d = Vec2.clone(q.d)
  } 

  set(x,y,w,h){
    Vec2.set(x,y,_a)
    Vec2.set(x,y+h,_b)
    Vec2.set(x+w,y+h,_c)
    Vec2.set(x+w,y,_d)
  }

  offset(x,y){
    var os = [x,y]
    Vec2.add(_a,os,_a)
    Vec2.add(_b,os,_b)
    Vec2.add(_c,os,_c)
    Vec2.add(_d,os,_d)
  }

  toString(){
    return [x,y,w,h]
  }
}

var EmptyQuad = Quad.new(0,0,0,0)

class AbstractBatch {
  
  transform { _transform }
  count { _size }
  positions { _positions }
  texcoords { _texcoords }
  texture { _texture }

  construct new(texture, size, positionComponents){
    _transform = Mat4.new()
    _texture = texture
    _size = size
    _positions = FloatVecAccessor.new(4*size,positionComponents)
    _texcoords = FloatVecAccessor.new(4*size,2)
    _indices = UShortAccessor.new(6*size)
    
    _texcoordsGBuffer = GraphicsBuffer.forVertices(_texcoords.bufferView, BufferUsage.Dynamic) 
    _positionsGBuffer = GraphicsBuffer.forVertices(_positions.bufferView, BufferUsage.Dynamic)
    _indicesGBuffer = GraphicsBuffer.forIndices(_indices.bufferView, BufferUsage.Dynamic)
    
    _positionAttribute = Attribute.fromAccessor(_positions, AttributeType.Position, false, _positionsGBuffer) 
    _texcoordsAttribute = Attribute.fromAccessor(_texcoords, AttributeType.Texcoord0, false, _texcoordsGBuffer) 
    _vertexIndices = VertexIndices.new(_indicesGBuffer, _indices.count, DataType.UShort)

    calculateIndices()
  }

  calculateIndices(){
    for(i in 0..._size){
      var vo = 4 * i
      var io = 6 * i
      _indices[io+0] = vo+0
      _indices[io+1] = vo+1
      _indices[io+2] = vo+2

      _indices[io+3] = vo+0
      _indices[io+4] = vo+2
      _indices[io+5] = vo+3
    }
    _dirty = true
  }

  setSource(n,s){
    s = s || Quad.empty
    var vo = 4 * n
    _texcoords[vo+0] = s.a
    _texcoords[vo+1] = s.b
    _texcoords[vo+2] = s.c
    _texcoords[vo+3] = s.d
    _dirty = true
  }

  setTarget(n,t){
    t = t || Quad.empty
    var vo = 4 * n
    _positions[vo+0] = t.a
    _positions[vo+1] = t.b
    _positions[vo+2] = t.c
    _positions[vo+3] = t.d
    _dirty = true
  }

  update(){
    if(_dirty){
      _positionsGBuffer.subDataView(_positions.bufferView)
      _texcoordsGBuffer.subDataView(_texcoords.bufferView)
      _indicesGBuffer.subDataView(_indices.bufferView)
      _dirty = false
    }
  }

  draw(){
    draw(_size)
  }

  setUniforms(){
    Renderer.setUniformTexture(UniformType.Texture0, 0, _texture)
    Renderer.setUniformMat4(UniformType.Model, _transform)
  }

  enableAttributes(){
    Renderer.enableAttribute(_positionAttribute)
    Renderer.enableAttribute(_texcoordsAttribute)
  }

  draw(amnt){
    update()
    setUniforms()
    enableAttributes()
    Renderer.drawIndices(_vertexIndices, amnt*6)
  }

}

class SpriteBatch is AbstractBatch {

  construct new(texture, size){
    super(texture, size, 2)
    _colors = UByteVecAccessor.new(4*size,4)
    _colorsGBuffer = GraphicsBuffer.forVertices(_colors.bufferView, BufferUsage.Dynamic)
    _colorsAttribute = Attribute.fromAccessor(_colors, AttributeType.Color, true, _colorsGBuffer) 
    _dirty = false
  }

  setSprite(n, s, t){
    setTarget(n,t)
    setSource(n,s)
    setColor(n, Colors.White)
  }

  setSprite(n, s, t, c){
    setTarget(n,t)
    setSource(n,s)
    setColor(n, c)
  }

  setColor(n,c){
    c = c || Colors.Transparent
    var vo = 4 * n
    _colors[vo+0] = c
    _colors[vo+1] = c
    _colors[vo+2] = c
    _colors[vo+3] = c
    _dirty = true
  }

  setOpacity(n,o){
    var vo = 4 * n
    var c = _colors[vo+0]
    c[3] = o
    _colors[vo+0] = c
    _colors[vo+1] = c
    _colors[vo+2] = c
    _colors[vo+3] = c
  }
  
  update(){
    super.update()
    if(_dirty){
      _colorsGBuffer.subDataView(_colors.bufferView)
      _dirty = false
    }
  }

  setUniforms(){
    super.setUniforms()
    Renderer.setUniformVec2(UniformType.TextureSize, [texture.width,texture.height])
  }

  enableAttributes(){
    super.enableAttributes()
    Renderer.enableAttribute(_colorsAttribute)
  }

}

class Tileset{
  
  tileWidth { _tw }
  tileHeight { _th }

  construct new(w,h,tw,th){
    _w = w.floor
    _h = h.floor
    System.print([_w,_h])
    _tw = tw.floor
    _th = th.floor
    calculateQuads()
  }

  calculateQuads(){
    _quads = []
    for(y in 0..._h){
      for(x in 0..._w){
        _quads.add(Quad.new(x*_tw,y*_th,_tw, _th))
      }
    }
  }

  [x,y] {
    return _quads[y*_w+x]
  }

  [i] {
    return _quads[i]
  } 
}

class Tilemap is SpriteBatch {

  width {_w}
  height {_h}
  pixelWidth {_w*_tw}
  pixelHeight {_h*_th}
  tileWidth {_tw}
  tileHeight {_th}
  texture {_texture}

  construct new(texture,w,h,tw,th){
    super(texture,w.floor*h.floor)
    _texture = texture
    _w = w.floor
    _h = h.floor
    _tw = tw
    _th = th
    var q = Quad.new(0,0,0,0)
    for(y in 0..._h){
      for(x in 0..._w){
        q.set(x*tw, y*th, tw, th)
        super.setTarget(y*_w+x,q)
      }
    }
  }

  [x,y]=(quad) {
    super.setSource(y*_w+x,quad)
    super.setColor(y*_w+x,Colors.White)
  }

  [i]=(quad) {
    super.setSource(i,quad)
    super.setColor(i,Colors.White)
  }

  fill(fn){
    for(y in 0..._h){
      for(x in 0..._w){
        super.setSource(y*_w+x,fn.call(x,y))
      }
    }
  }
}class Pipeline {
  construct new(children){
    _children = children
  }

  start(){
    for(c in _children){ c.start() }
  }

  update(){
    for(c in _children){ c.update() }
  }
}class Assert {
  static equal(actual, expected){
    if(actual != expected){
      Fiber.abort("%(actual) was expected to be %(expected)")
    }
  }

  static error(fn){
    var f = Fiber.new {
      fn.call()
    }
    var e = f.try()
    if(!e){
      Fiber.abort("Expected error")
    }
  }

  static defined(actual){
    if(actual == null){
      Fiber.abort("Expected value to be defined")
    }
  }

  static elementsEqual(actual, expected){
    if(actual.count != expected.count){
      Fiber.abort("Expected list count %(expected.count) but got %(actual.count)")
    }

    for (i in 0...actual.count) {
      if(actual[i] != expected[i]){
        Fiber.abort("Expected element %(i) to be %(expected[i]) but got %(actual[i])")
      }
    }
  }

  static contains(seq, val){
    return seq.contains(val)
  }
}

class Augur {
  static describe(desc, fn){
    if(!__suites){
      __suites = []
    }
    var suite = Suite.new(desc)
    __suites.add(suite)
    __suite = suite
    fn.call()
  }

  static it(desc, fn) {
    __suite.addTest(desc, fn)
  }

  static beforeAll(fn){
    __suite.beforeAll(fn)
  }

  static beforeEach(fn){
    __suite.beforeEach(fn)
  }

  static afterAll(fn){
    __suite.afterAll(fn)
  }

  static afterEach(fn){
    __suite.afterEach(fn)
  }

  static run(){
    var res = __suites.reduce([0,0]) {|a,s| 
      var r = s.run()
      a[0] = a[0] + r[0]
      a[1] = a[1] + r[1]
      return a
    }
    System.print("[AUGUR] Finishes running tests. %(res[0]) successful. %(res[1]) failed.")
  }
}

class Suite {
  construct new(desc){
    _name = desc
    _tests = []
  }

  addTest(name, fn){
    _tests.add(TestFunc.new(name, fn))
  }

  beforeAll(fn){
    _beforeAll = fn
  }

  beforeEach(fn){
    _beforeEach = fn
  }

  afterAll(fn){
    _afterAll = fn
  }

  afterEach(fn){
    _afterEach = fn
  }

  run(){
    System.print("[AUGUR] Running Suite <%(_name)>")
    var totalSuc = 0
    var totalFail = 0
    if(_beforeAll) { _beforeAll.call() }
    for (test in _tests) {
        if(_beforeEach) { _beforeEach.call() }
        var success = test.run(_name)
        if(success) { 
          totalSuc = totalSuc+1 
        } else { 
          totalFail = totalFail+1 
        }
        if(_afterEach) { _afterEach.call() }
    }
    if(_afterAll) { _afterAll.call() }
    return [totalSuc, totalFail]
  }
}

class TestFunc {
  construct new(desc, fn){
    _desc = desc
    _fn = fn
  }

  run(suite){    
    //_fn.call() 
    var fiber = Fiber.new { 
      _fn.call() 
    }
    var before = System.clock
    var error = fiber.try()
    var time = System.clock - before
    var state
    var success = false 
    if(error){
      state = "[ERROR: %(error)]"
    } else {
      success = true
      state = "[SUCCESS]"
    }

    System.print("[AUGUR] %(state) %(suite) %(_desc) (%(time)s)")
    return success
  }

}
import "math" for Math, Mat4, Vec3
import "graphics" for Renderer, UniformType

class Camera {
  enable() {
    Renderer.setUniformMat4(UniformType.Projection, getProjection())
    Renderer.setUniformMat4(UniformType.View, getView())
  }
}

class OrthograficCamera is Camera {
  construct new(){
    _projection = Mat4.new()
    _view = Mat4.new()
    _pDirty = true
    //_vDirty = true
  }

  getProjection(){
    if(_pDirty){
      _projection.ortho()
      _pDirty = false
    }
    return _projection
  }

  getView(){
    return _view
  }

  move(x,y){
    _view.translate(x,y,0)
  }

  scale(x,y){
    _view.scale(x,y)
  }

  rotate(r){
    _view.rotateZ(z)
  }

  reset(){
    _view.identity()
  }
}

class PerspectiveCamera is Camera {
  
  fov { Math.deg(_fov) }
  fov=(v) { 
    _pDirty = true
    _fov = Math.rad(v) 
  }

  near { _near }
  near=(v) { 
    _pDirty = true
    _near = v 
  }

  far { _far }
  far=(v) {
    _pDirty = true
    _far = v
  }

  construct new(){
    _projection = Mat4.new()
    _fov = Math.rad(45)
    _near = 0.1
    _far = 100
    _pDirty = true
  }
  
  getProjection(){
    if(_pDirty){
      _projection.perspective(_fov, _near, _far)
      _pDirty = false
    }
    return _projection
  }

  zoom(v){
    _fov = _fov + Math.rad(v)
    _pDirty = true
  }
}

class PointAtCamera is PerspectiveCamera {
  construct new(){
    super()
    _position = [0,1,2]
    _target = [0,0,0]
    _up = [0,1,0]
    _viewDirty = true
    _view = Mat4.new()
  }

  getTarget(v3){
    Vec3.copy(_target, v3)
  }

  setTarget(x,y,z){
    Vec3.set(x,y,z,_target)
    _viewDirty = true
  }

  setTarget(v3){
    Vec3.copy(v3,_target)
    _viewDirty = true
  }

  moveTarget(x,y,z){
    Vec3.add(_target, x,y,z,_target)
    _viewDirty = true
  }

  moveTarget(v3){
    Vec3.add(_target, v3 ,_target)
    _viewDirty = true
  }

  getPosition(v3){
    Vec3.copy(_position, v3)
  }

  setPosition(x,y,z){
    Vec3.set(x,y,z,_position)
    _viewDirty = true
  }

  setPosition(v3){
    Vec3.copy(v3,_position)
    _viewDirty = true
  }

  movePosition(x,y,z){
    Vec3.add(_position, x,y,z,_position)
    _viewDirty = true
  }

  movePosition(v3){
    Vec3.add(_position, v3,_position)
    _viewDirty = true
  }

  setUp(x,y,z){
    Vec3.set(x,y,z,_up)
    _viewDirty = true
  }

  setUp(v3){
    Vec3.copy(v3,_up)
    _viewDirty = true
  }

  getView(){
    if(_viewDirty){
      _view.lookAt(_position, _target, _up)
      _viewDirty = false
    }
    return _view
  }
}

class OrbitCamera is PointAtCamera {
  
  phi { Math.deg(_phi) }
  phi=(v) { 
    _phi = Math.rad(v)
    _dirty = true
  }
  theta { Math.deg(_theta) }
  theta=(v) { 
    _theta = Math.rad(v) 
    _dirty = true
  }
  radius { _rad }
  radius=(v) { 
    _rad = v
    _dirty = true 
  }

  construct new(){
    super()
    _dirty = true
    _position = [0,0,0]
    _target = [0,0,0]
    _phi = Math.rad(90)
    _theta = 0
    _rad = 1
  }
  
  getView(){
    if(_dirty){
      super.getTarget(_target)
      _position[0] = _rad * _phi.sin * _theta.cos
      _position[1] = _rad * _phi.cos
      _position[2] = _rad * _phi.sin * _theta.sin
      Vec3.add(_position,_target,_position)
      super.setPosition(_position)
      _dirty = false
    }
    return super.getView()
  }

  phi(v){
    _phi = _phi + Math.rad(v)
    _dirty = true
  }

  theta(v){
    _theta = _theta + Math.rad(v)
    _dirty = true
  }

  radius(v){
    _rad = _rad + v
    _dirty = true
  }

  setTarget(x,y,z){
    super.setTarget(x,y,z)
    _dirty = true
  }

  setTarget(v3){
    super.setTarget(v3)
    _dirty = true
  }

}

class FlyCamera is PointAtCamera {

  yaw { Math.deg(_yaw) }
  pitch { Math.deg(_pitch) }
  yaw=(v) { 
    _yaw = Math.rad(v)
    _dirty = true 
  }
  pitch=(v) { 
    if(v > 89.9) { 
      _pitch = Math.rad(89.9) 
    } else if(v < -89.9) { 
      _pitch = Math.rad(-89.9) 
    } else { 
      _pitch = Math.rad(v) 
    } 
    _dirty = true
  }

  construct new(){
    super()
    _worldUp = [0,1,0]
    _yaw = Math.rad(270)
    _pitch = Math.rad(0)

    _front = Vec3.zero()
    _right = Vec3.zero()
    _tmp = Vec3.zero()
    _dirty = true
  }

  moveForward(amnt){
    Vec3.mulV(_front, amnt, _tmp)
    super.movePosition(_tmp)
    super.moveTarget(_tmp)
    _dirty = true
  }

  pitch(p){
    _pitch = _pitch + Math.rad(p)
    _dirty = true
  }

  yaw(y){
    _yaw = _yaw + Math.rad(y)
    _dirty = true
  }

  moveRight(amnt){
    Vec3.mulV(_right, amnt, _tmp)
    super.movePosition(_tmp)
    super.moveTarget(_tmp)
    _dirty = true
  }

  getView(){
    if(_dirty){
      _front[0] = _yaw.cos * _pitch.cos
      _front[1] = _pitch.sin
      _front[2] = _yaw.sin * _pitch.cos
      
      Vec3.normalize(_front, _front)
      super.getPosition(_tmp)
      Vec3.add(_tmp, _front, _tmp)
      super.setTarget(_tmp)

      Vec3.crossn(_front, _worldUp, _right)    
      Vec3.crossn(_right, _front, _tmp)
      super.setUp(_tmp)
      _dirty = false
    }
    return super.getView()
  }
}import "platform" for Application,Event

class Component {
  
  construct new(parent){
    _parent = parent
    _children = []
    _channels = {}
    _parent.addChild(this) 
  }

  construct new(){
    _parent = null
    _children = []
    _channels = {}
  }

  init(){
    for(c in _children){
      c.init()
    }
  }

  start(){
    for(c in _children){
      c.start()
    }
  }

  update(){
    for(c in _children){
      c.update()
    }
  }

  addChild(c){
    _children.add(c)
  }

  publishChannel(id, c){
    _parent.addChannel(id,c)
  }

  addChannel(id, c){
    _channels[id] = c
  }

  getChannel(id){
    var c = _channels[id]
    if(c) return c
    var val = _parent ? _parent.getChannel(id) : null
    if(val == null){
      Fiber.abort("Channel not found " + id)
    }
    return val
  }
}

class RootComponent is Component {
  construct new(){
    super()
    Application.on(Event.Init){|a| this.init() }
    Application.on(Event.Load){|a| this.start() }
    Application.on(Event.Update){|a| this.update() }
  }


}

class Channel {

  value { _value }
  generation { _generation }

  construct new(initial){
    _value = initial
    _generation = 0
  }

  setValue(v){
    _value = v
    _generation = _generation + 1
  }
}class Container {
  
  construct new() {
    _registry = {}
    _factories = {}
  }
  
  register(type){
    _factories[type.toString] = Fn.new { type.new() }
  }

  registerFactory(type, factory){
    _factories[type.toString] = factory
  }

  registerInstance(type, inst){
    _registry[type.toString] = inst
  }

  resolve(name){
    if(!_registry.containsKey(name.toString)){
      if(_factories[name.toString] == null) Fiber.abort("Cannot resolve " + name.toString)

      _registry[name.toString] = _factories[name.toString].call(this)
    }

    return _registry[name.toString]
  }

  resolveAll(list) { list.map{|x| resolve(x)}.toList }
}

var GlobalContainer = Container.new() class Ringbuffer {

  construct new(capacity){
    _data = List.filled(capacity, null)
    _capacity = capacity
    _front = 0
    _back = 0
    _count = 0
  }

  count { _count }

  isEmpty { _count == 0 }

  enqueue(v){
    if(_count == _capacity) Fiber.abort("Ringbuffer capacity exceeded")
    _data[_front] = v
    _front = (_front+1) % _capacity
    _count = _count+1
  }

  dequeue(){
    if(isEmpty) return null
    var v = _data[_back]
    _back = (_back+1) % _capacity
    _count = _count-1
    return v
  }

}import "io" for File, SeekOrigin, Path
import "2d" for Quad, SpriteBatch
import "graphics" for Texture


class Text is SpriteBatch {
  construct new(text, font, width){
    super(font.pages[0], text.count)
    _text = text
    _font = font
    _width = width
    format()
  }

  format(){
    var x = 0
    var y = _font.base
    var target = Quad.clone(Quad.empty)
    var i = 0
    for(c in _text.codePoints){
      var char = _font[c]
      if(char){
        var source = char.quad
        target.set(x+char.offset[0], y+char.offset[1], char.quad.w, char.quad.h)
        super.setSprite(i,source, target)
        x = x + char.xadvance
        i = i + 1
      }
      if(x > _width || c == 10 /*LF*/){
        x = 0
        y = y + _font.lineHeight
      }
    }
  }
}

class BMFont {

  size { _size }
  name { _name }
  lineHeight { _lineHeight }
  base { _base }
  pages { _pages }

  construct fromFile(path){
    var file = File.open(path, "rb")
    var magic = file.read(3)
    if(magic != "BMF"){
      Fiber.abort("Not a valid BMFont file")
    }
    var version = file.readUByte()
    while(file.pos()<file.length()){
      var block = file.readUByte()
      var length = file.readUInt()
      if(block == 1){ 
        parseInfo(file, length)
      } else if(block == 2){
        parseCommon(file, length)
      } else if(block == 3){
        parsePages(file,length, Path.getFolder(path))
      } else if(block == 4){
        parseChars(file, length)
      } else if(block == 5){
        parseKernings(file, length)
      }else{ 
        Fiber.abort("Unknown block %(block)") 
      }
    }
  }

  parseInfo(f, l){
    _size = f.readShort()
    var options = f.readUByte()
    var charSet = f.readUByte()
    var stretchH = f.readUShort()
    var aa = f.readUByte()
    var padding = [f.readUByte(), f.readUByte(), f.readUByte(), f.readUByte()]
    var spacing = [f.readUByte(), f.readUByte()]
    var outline = f.readUByte()
    _name = f.readString(l-14)
  }

  parseCommon(f,l){
    _lineHeight = f.readUShort()
    _base = f.readUShort()
    var scale = [f.readUShort(),f.readUShort()]
    var numPages = f.readUShort()
    var bitField = f.readUByte()
    var channels = [f.readUByte(),f.readUByte(),f.readUByte(),f.readUByte()] 
  }

  parsePages(f,l, folder){
    _pages = f.readString(l).split("\0").map{|f| Texture.fromFile(folder + "/" + f) }.toList
  }

  parseChars(f,l){
    _chars = {}
    var count = l/20
    for(i in 0...count){
      var char = BMChar.fromStream(f)
      _chars[char.id] = char 
    }
  }

  parseKernings(f,l){
    var kernings = {}
    var count = l/10
    for(i in 0...count){
      var from = f.readUInt()
      var to = f.readUInt()
      var amount = f.readShort()
      if(!kernings[from]) kernings[from] = {}
      kernings[from][to] = amount
    }
  }

  [id] {
    return _chars[id]
  }

  getKerning(from, to){
    if(kernings[from]){
      return kernings[from][to] || 0
    }
    return 0
  }

}

class BMChar {

  id { _id }
  quad { _quad }
  offset { _offset }
  xadvance { _xadvance }
  page { _page }
  channel { _channel }

  construct fromStream(f){
    _id = f.readUInt()
    _quad = Quad.new(f.readUShort(), f.readUShort(), f.readUShort(), f.readUShort())
    _offset = [f.readShort(), f.readShort()]
    _xadvance = f.readShort()
    _page = f.readUByte()
    _channel = f.readUByte()
  }
}import "memory" for Buffer, BufferView, DataType, Accessor, ListUtil

class AttributeType {
  static Unknown { 0 }
  static Position { 1 }
  static Color { 2 }
  static Normal { 3 }
  static Tangent { 4 }
  static Texcoord0 { 5 }
  static Texcoord1 { 6 }
  static Offset { 7 }
}

class GeometryWriter {

  vertexOffset { _vertexOffset }
  indexOffset { _indexOffset }

  construct new(accessors, indices) {
    _accessors = accessors
    _numAccessors = accessors.count
    _indices = indices
    _vertexOffset = 0
    _indexOffset = 0
  }

  vertex(vs){
    for(i in 0..._numAccessors){
      _accessors[i][_vertexOffset] = vs[i]
    }
    _vertexOffset = _vertexOffset +1
  }
  tri(a,b,c){
    _indices[_indexOffset] = a
    _indices[_indexOffset+1] = b
    _indices[_indexOffset+2] = c
    _indexOffset = _indexOffset + 3
  }
}

class GeometryData {
  
  static merge(seq){

    // Attributes
    var vBufferSize = seq.reduce(0) {|a,gd| a + gd.combinedVertexSize()}
    var vBuffer = Buffer.new(vBufferSize)
    var vView = BufferView.new(vBuffer)
    // TODO: Check that all GDs have matching attributes
    var refItem = seq.take(1).toList[0]
    var acc

    var newAccessors = {}
    var stride = refItem.vertexSize()
    

    var offset = 0

    for(attrType in refItem){
      acc = refItem[attrType]
      if(acc.numComponents == 1){
        var ctor = Accessor.constructorForType(acc.componentType)
        newAccessors[attrType] = ctor.fromBufferView(vView, stride, offset)
      } else {
        var ctor = Accessor.constructorForVecType(acc.componentType)
        newAccessors[attrType] = ctor.fromBufferView(vView, acc.numComponents, stride, offset)
      }
      offset = offset + (acc.numComponents * DataType.size(acc.componentType))

      var accessorOffset = 0
      for(gd in seq){
        var oldAcc = gd[attrType]
        var newAcc = newAccessors[attrType]

        for(i in 0...oldAcc.count){
          newAcc[accessorOffset+i] = oldAcc[i]
        }

        accessorOffset = accessorOffset + oldAcc.count
      }
    }
    
    // Indices
    var iBufferSize = seq.reduce(0) {|a,gd| a + gd.indexSize() }
    var iBuffer = Buffer.new(iBufferSize)
    var iView = BufferView.new(iBuffer)

    var indexOffset = 0
    var vertexOffset = 0
    var indices = Accessor.constructorForType(refItem.indices.componentType).fromBufferView(iView, 0, 0)
    for(gd in seq){
      for(i in 0...gd.indices.count){
        indices[indexOffset + i] = gd.indices[i] + vertexOffset
      }
      indexOffset = indexOffset + gd.indices.count
      vertexOffset = vertexOffset + gd.positions.count
    }
    return GeometryData.new(newAccessors, indices)
  }

  indices { _indices }
  count { _attributes.count }
  colors { this[AttributeType.Color] }
  positions { this[AttributeType.Position] }
  texcoords { this[AttributeType.Texcoord0] }
  
  construct new(attributes, indices){
    _attributes = attributes
    _indices = indices
  }

  construct clone(geoData){
    var visited = []
    var generated = []
    var newAttr = {}

    for(key in geoData){
      var oldAcc = geoData[key]
      var idx = ListUtil.indexOf(visited, oldAcc.bufferView)
      var view
      if(idx == -1){
        var buffer = Buffer.fromBufferView(oldAcc.bufferView)
        view = BufferView.new(buffer)
        generated.add(view)
        visited.add(oldAcc.bufferView)
      } else {
        view = generated[idx]
      }

      if(oldAcc.numComponents == 1){
        newAttr[key] = Accessor.constructorForType(oldAcc.componentType).fromBufferView(view, oldAcc.stride, oldAcc.offset)
      } else {
        newAttr[key] = Accessor.constructorForVecType(oldAcc.componentType).fromBufferView(view, oldAcc.numComponents, oldAcc.stride, oldAcc.offset)
      }
    }

    var iBuffer = Buffer.fromBufferView(geoData.indices.bufferView)
    var iView = BufferView.new(iBuffer)
    var indices = Accessor.constructorForType(geoData.indices.componentType).fromBufferView(iView, 0, 0)
    
    _attributes = newAttr
    _indices = indices
  }

  [acc] { _attributes[acc] }

  iterate(val) { _attributes.keys.iterate(val) }
  iteratorValue(val) { _attributes.keys.iteratorValue(val) }

  combinedVertexSize(){
    return _attributes.values.reduce(0) {|a,acc| a + acc.numComponents * DataType.size(acc.componentType) * acc.count}
  }

  vertexSize(){
    return _attributes.values.reduce(0) {|a,acc| a + acc.numComponents * DataType.size(acc.componentType) }
  }

  indexSize(){
    return _indices.count * DataType.size(_indices.componentType)
  }

  transform(attrKey, t){
    var a = _attributes[attrKey]
    if(a.numComponents != 3){
      Fiber.abort("Transform can only be applied to vec3")
    }
    var v3
    for(i in 0...a.count){
      v3 = a[i]
      t.mulVec3(v3)
      a[i] = v3
    }
  }
}import "json" for Json
import "io" for File
import "image" for Image
import "memory" for ListUtil, Buffer, BufferView, Float32Array, Accessor, DataType, ByteVecAccessor, UByteVecAccessor, ShortVecAccessor, UShortVecAccessor, IntVecAccessor, UIntVecAccessor, FloatVecAccessor, ByteAccessor, UByteAccessor, ShortAccessor, UShortAccessor, IntAccessor, UIntAccessor, FloatAccessor
import "geometry" for GeometryData, AttributeType
import "graphics" for Geometry, Mesh, Texture, DiffuseMaterial, Node
import "stream" for StreamReader
import "math" for Mat4

class Gltf {

  static numComponents(str){
    if(str == "VEC3") return 3
    if(str == "VEC2") return 2
    if(str == "VEC4") return 4
    if(str == "SCALAR") return 1
    if(str == "MAT3") return 9
    if(str == "MAT2") return 4
    if(str == "MAT4") return 16
    return 1
  }

  static attributeType(str){
    if(str == "POSITION") return AttributeType.Position
    if(str == "COLOR_0") return AttributeType.Color
    if(str == "NORMAL") return AttributeType.Normal
    if(str == "TANGENT") return AttributeType.Tangent
    if(str == "TEXCOORD_0") return AttributeType.Texcoord0
    if(str == "TEXCOORD_1") return AttributeType.Texcoord1
    return 0    
  }

  meshes { _meshes }
  accessors { _accessors }
  textures { _textures }
  materials { _materials }
  nodes { _nodes }
  scenes { _scenes }
  images { _images }

  construct fromFile(filename){
    if(filename.endsWith(".gltf")){
      loadGltf(filename)
    } else if(filename.endsWith(".glb")){
      loadGlb(filename)
    } 
  }

  loadGlb(filename){
    _buffer = Buffer.fromFile(filename)
    _reader = StreamReader.new(_buffer)
    var magic = _reader.readString(4)
    if(magic != "glTF"){
      Fiber.abort("Not a GLB file")
    }
    var version = _reader.readUInt()
    var size = _reader.readUInt()

    var len = _reader.readUInt()
    var type = _reader.readString(4)
    _json = Json.parse(_reader.readString(len))
    len = _reader.readUInt()
    type = _reader.readString(4)

    _buffers = [BufferView.new(_buffer, _reader.offset, len)]

    loadAssets()

    _json = null
  }

  loadGltf(filename){
    var file = File.open(filename, "rb")
    var content = file.readToEnd()
    file.close()
    _json = Json.parse(content)
    
    getFolder(filename)
    
    loadBuffers()
    loadAssets()

    _json = null
  }

  loadAssets(){
    loadViews()
    loadImages()
    loadTextures()
    loadMaterials()
    loadAccessors()
    loadMeshes()
    loadNodes()
    loadScenes()
  }

  getFolder(filename){
    filename = filename.replace("\\","/")
    var frags = filename.split("/")
    frags.removeAt(-1)
    _folder = frags.join("/")
  }

  loadImages(){
    _images = []
    if(_json["images"] == null) return

    for (image in _json["images"]) {
      if(image["uri"]){
        _images.add(Image.fromFile(_folder + "/" + image["uri"]))
      } else {
        var img = Image.fromBufferView(_views[image["bufferView"]])
        _images.add(img)
      }
    }
  }

  loadBuffers(){
    _buffers = []
    for(buffer in _json["buffers"]){
      var buffer = Buffer.fromFile(_folder + "/" + buffer["uri"])
      var view = BufferView.new(buffer, 0, buffer.size)
      _buffers.add(view)
    }
  }

  loadTextures(){
    _textures = []

    if(_json["textures"] == null) return

    for(texture in _json["textures"]){
      _textures.add(GltfTexture.fromJson(_images[texture["source"]], texture))
    }
  }

  loadViews(){
    _views = []
    for(view in _json["bufferViews"]){
      var buffer = _buffers[view["buffer"]]
      var offset = view["byteOffset"]
      var size = view["byteLength"]
      var stride = view["stride"] || 0
      _views.add(BufferView.fromBufferView(buffer, offset, size))
    }
  }

  loadAccessors(){
    _accessors = []
    for(acc in _json["accessors"]){
      loadAccessor(acc)
    }
  }

  loadAccessor(json){
    var view = _views[json["bufferView"]]
    var componentType = json["componentType"]
    var numComponents = Gltf.numComponents(json["type"])
    var accessor = null
    // TODO: Get stride and offset
    if(numComponents == 1){
      accessor = Accessor.constructorForType(componentType).fromBufferView(view, 0, 0)
    } else {
      accessor = Accessor.constructorForVecType(componentType).fromBufferView(view, numComponents, 0, 0)
    }
    _accessors.add(accessor)
  }

  loadMeshes(){
    _meshes = []
    for(mesh in _json["meshes"]){
      var primitives = []
      for(prim in mesh["primitives"]){
        primitives.add(GltfPrimitive.fromJson(this,prim))
      }
      _meshes.add(GltfMesh.fromJson(this, primitives, mesh))
    }    
  }

  loadMaterials(){
    _materials = []

    if(_json["materials"] == null) return

    for(material in _json["materials"]){
      var mat = GltfMaterial.fromJson(_textures, material)
      _materials.add(mat)
    }
  }

  loadNodes(){
    _nodes = []

    if(_json["nodes"] == null) return

    for(node in _json["nodes"]){
      _nodes.add(GltfNode.fromJson(this, node))
    }
  }

  loadScenes(){
    _scenes = []

    if(_json["scenes"] == null) return

    for(scene in _json["scenes"]){
      _scenes.add(GltfScene.fromJson(this, scene))
    }
  }

  scene(name){
    return ListUtil.first(_scenes) {|e| e.name == name }
  }

  node(name){
    return ListUtil.first(_nodes) {|e| e.name == name }
  }

  mesh(name){
    return ListUtil.first(_meshes) {|e| e.name == name }
  }
}

class GltfTexture {

  source { _source }

  construct fromJson(imageSrc, json) {
    _source = imageSrc
  }  

  toGraphicsTexture(){
    return Texture.fromImage(_source)
  }
}

class GltfPrimitive {

  material { _material }
  geometryData { _gd }

  construct fromJson(gltf, json){
    var indices = gltf.accessors[json["indices"]]
    //var material = _materials[prim["material"]]
    var attributes = {}
    for(key in json["attributes"].keys){
      var aType= Gltf.attributeType(key)
      attributes[aType] =  gltf.accessors[json["attributes"][key]]
    }
    _gd = GeometryData.new(attributes,indices)

    var i = json["material"]
    if(i) _material = gltf.materials[i]
  }

  toGeometry(){
    return Geometry.new(_gd)
  }

}

class GltfMesh {
  
  name { _name }
  primitives { _primitives }

  construct fromJson(gltf, primitives, json){
    _primitives = primitives
    _name = json["name"]
  }

  toGraphicsMeshes(){
    return _primitives.map {|x| Mesh.new(x.toGeometry(), x.material ? x.material.toGraphicsMaterial() : null) }.toList
  }
}

class GltfMaterial {
  
  diffuse { _diffuse }
  
  construct fromJson(textures, json){
    _diffuse = textures[json["pbrMetallicRoughness"]["baseColorTexture"]["index"]]
  }

  toGraphicsMaterial(){
    return DiffuseMaterial.new(_diffuse.toGraphicsTexture())
  }
  
}

class GltfNode {

  transform { _transform }
  mesh { _mesh }
  name { _name }

  construct fromJson(gltf, json){
    _transform = parseTransform(json)
    var i = json["mesh"] 
    if(i) _mesh = gltf.meshes[i]
    _name = json["name"]
  }

  parseTransform(json){
    var m = Mat4.new()

    var s = json["scale"]
    var r = json["rotation"]
    var t = json["translation"]

    if(t) m.translate(t[0], t[1], t[2])
    if(r) m.rotateQuat(r[0], r[1], r[2], r[3])
    if(s) m.scale(s[0], s[1], s[2])

    return m
  }

  toGraphicsNodes(){
    if(_mesh){
      return _mesh.toGraphicsMeshes().map{|m| Node.new(m, _transform)}.toList
    }
    return []
  }
}

class GltfScene {

  name { _name }
  nodes { _nodes }

  construct fromJson(gltf, json){
    _name = json["name"]
    _nodes = json["nodes"].map {|i| gltf.nodes[i]}.toList
  }

  toGraphicsMeshes() {
    return _nodes.reduce([]) {|p,c|  
      c.toGraphicsMeshes().each {|m| p.add(m)}
      return p
    }.toList
  }
}import "image" for Image
import "math" for Vec3, Mat4, Math
import "io" for File
import "geometry" for AttributeType
import "memory" for MapUtil

class Colors {
  static init() {
    __transparent = [0,0,0,0]
    __white = [255,255,255,255]
    __grey = [128,128,128,255]
    __darkgrey = [64,64,64,255]
    __red = [255,0,0,255]
    __green = [0,255,0,255]
    __blue = [0,0,255,255]
    __black = [0,0,0,255]
  }
  static White {__white}
  static Grey {__grey}
  static DarkGrey {__darkgrey}
  static Red {__red}
  static Green {__green}
  static Blue {__blue}
  static Transparent { __transparent }
  static Black { __black }
}

class UniformType {
  static Model { 0 }
  static View { 1 }
  static Projection { 2 }
  static Normal { 3 }
  static Texture0 { 5 }
  static Texture1 { 6 }
  static Texture2 { 7 }
  // reserved
  static Light0 { 12 }
  // reserved
  static Time { 16 }
  static TextureSize { 17 }
  static FogColor { 18 }
}

class TextureFilters {
  static Nearest { 0x2600 }
  static Linear { 0x2601 }
  static NearestMipmapNearest { 0x2700 }
  static LinearMipmapNearest { 0x2701 }
  static NearestMipmapLinear { 0x2702 }
  static LinearMipmapLinear { 0x2703 }
}

class TextureWrap {
  static Repeat { 0x2901 }
  static Clamp { 0x812F }
  static Mirrored { 0x8370 }
}

var DefaultTextureOptions = {
  "mipmaps": true,
  "minFilter": TextureFilters.LinearMipmapLinear,
  "magFilter": TextureFilters.Linear,
  "wrapS": TextureWrap.Repeat,
  "wrapT": TextureWrap.Repeat
}

foreign class Texture {

  width { width() }
  height { height() }

  construct fromImage(img){
    image(img)
    init(DefaultTextureOptions)
  }

  construct fromImage(img, options){
    image(img)
    init(MapUtil.merge(DefaultTextureOptions, options))
  }

  construct fromFile(path){
    var img = Image.fromFile(path)
    image(img)
    init(DefaultTextureOptions)
  }

    construct fromFile(path, options){
    var img = Image.fromFile(path)
    image(img)
    init(MapUtil.merge(DefaultTextureOptions, options))
  }

  init(options){
    magFilter(options["magFilter"])
    minFilter(options["minFilter"])
    wrap(options["wrapS"], options["wrapT"])
    if(options["mipmaps"]){
      createMipmaps()
      minFilter(TextureFilters.LinearMipmapLinear)
    }
  }

  foreign magFilter(filter)
  foreign minFilter(filter)
  foreign wrap(s,t)
  foreign createMipmaps()
  foreign width()
  foreign height()

  // private
  foreign image(img)
}

class BufferUsage {
  static Static { 0x88E4 }
  static Dynamic { 0x88E8 }
  static Stream { 0x88E0 }
}

foreign class GraphicsBuffer {
  construct forVertices(view){
    init(view.buffer, view.offset, view.size, false, BufferUsage.Static)
  }

  construct forVertices(view, usage){
    init(view.buffer, view.offset, view.size, false, usage)
  }

  construct forIndices(view){
    init(view.buffer, view.offset, view.size, true, BufferUsage.Static)
  }

  construct forIndices(view, usage){
    init(view.buffer, view.offset, view.size, true, usage)
  }

  //private
  foreign init(buffer, offset, size, isIndexBuffer, usage)
  foreign subData(buffer, offset, size, targetOffset)
  subDataView(view){
    subData(view.buffer, view.offset, view.size, 0)
  }

}

foreign class InternalAttribute {
  construct new(graphicsBuffer, attrType, numComp, dataType, normalized, stride, offset){}
}

class Attribute {

  internal { _internal }

  construct new(graphicsBuffer, attrType, numComp, dataType, normalized, stride, offset){
    _graphicsBuffer = graphicsBuffer
    _internal = InternalAttribute.new(graphicsBuffer, attrType, numComp, dataType, normalized, stride, offset)
  }

  construct fromAccessor(accessor, attrType, normalized, gBuffer){
    _graphicsBuffer = gBuffer
    _internal = InternalAttribute.new(gBuffer, attrType, accessor.numComponents, accessor.componentType, normalized, accessor.stride, accessor.offset) 
  }
}

foreign class InternalVertexIndices {
  construct new(graphicsBuffer, count, componentType){}
}

class VertexIndices {

  internal { _internal }

  construct new(graphicsBuffer, count, componentType){
    _internal = InternalVertexIndices.new(graphicsBuffer, count, componentType)
    _buffer = graphicsBuffer
  }
}

//Regex
// Find: #define GL_([A-Z,_,2]+)\s+(.+)
// Replace: static $1 { $2 }

class RendererFeature {
  static Texture2d { 0x0DE1 }
  static CullFace { 0x0B44 }
  static Blend { 0x0BE2 }
  static Dither { 0x0BD0 }
  static StencilTest { 0x0B90 }
  static DepthTest { 0x0B71 }
  static ScissorTest { 0x0C11 }
  static PolygonOffsetFill { 0x8037 }
  static SampleAlphaToCoverage { 0x809E }
  static SampleCoverage { 0x80A0 }
}

class RendererBlendFunc {
  static Zero { 0 }
  static One { 1 }
  static SrcColor { 0x0300 }
  static OneMinusSrcColor { 0x0301 }
  static SrcAlpha { 0x0302 }
  static OneMinusSrcAlpha { 0x0303 }
  static DstAlpha { 0x0304 }
  static OneMinusDstAlpha { 0x0305 }
  static DstColor { 0x0306 }
  static OneMinusDstColor { 0x0307 }
  static SrcAlphaSaturate { 0x0308 }
}

class Renderer {
  static shader{ __shader }
  foreign static getErrors()
  foreign static setViewport(x,y,w,h)
  foreign static setBackgroundColor(r,g,b)
  foreign static enableAttributeInternal(attr)
  static enableAttribute(attr) { 
    if(attr == null) Fiber.abort("Attribute is null")
    Renderer.enableAttributeInternal(attr.internal) 
  }
  foreign static drawIndicesInternal(indices)
  foreign static drawIndicesInternal(indices, count)
  static drawIndices(indices) { 
    if(indices == null) Fiber.abort("Indices are null")
    Renderer.drawIndicesInternal(indices.internal) 
  }
  static drawIndices(indices,count) { 
    if(indices == null) Fiber.abort("Indices are null")
    Renderer.drawIndicesInternal(indices.internal, count) 
  }
  foreign static setUniformMat4(type, mat4)
  foreign static setShaderInternal(shaderInt)
  static setShader(shader) { 
    __shader = shader
    Renderer.setShaderInternal(shader.internal) 
  }
  foreign static setUniformTexture(type, unit, texture)
  foreign static setUniformVec3(type, vec3)
  foreign static setUniformVec2(type, vec2)
  foreign static setUniformFloat(type, f)

  foreign static toggleFeature(feature,bool)
  foreign static blendFunc(src, dst)

  static checkErrors(){
    var errors = Renderer.getErrors()
    if(errors.count > 0){
      Fiber.abort(errors.join(", "))
    }
  }

  static set2d(){
    if(__shader != Shader.default2d){
      Renderer.toggleFeature(RendererFeature.Blend, true)
      Renderer.toggleFeature(RendererFeature.CullFace, false)
      Renderer.toggleFeature(RendererFeature.DepthTest, false)
      Renderer.setShader(Shader.default2d)
      __shader = Shader.default2d
    }
  }

  static set3d(){
    if(__shader != Shader.default3d){
      Renderer.toggleFeature(RendererFeature.Blend, false)
      Renderer.toggleFeature(RendererFeature.CullFace, true)
      Renderer.toggleFeature(RendererFeature.DepthTest, true)
      Renderer.setShader(Shader.default3d)
      __shader = Shader.default3d
    }
  }
}

class Geometry { 
  
  construct new(geometryData){
    var views = []
    var buffers = []
    _attributes = []
    
    var indexOf = Fn.new {|list,item|
      for(i in 0...list.count){
        if(list[i] == item){
          return i
        }
      }
      return -1
    }

    for(key in geometryData){
      var accessor = geometryData[key]
      var gBuffer
      var view = accessor.bufferView
      var index = indexOf.call(views,view) 
      if(index != -1){
        gBuffer = buffers[index] 
      } else {
        gBuffer = GraphicsBuffer.forVertices(view)
        buffers.add(gBuffer)
        views.add(view)
      }
      var attribute = Attribute.fromAccessor(accessor, key, accessor.normalized, gBuffer)
      _attributes.add(attribute)
    }  

    var indexAccessor = geometryData.indices
    var indexBuffer = GraphicsBuffer.forIndices(indexAccessor.bufferView)
    _index = VertexIndices.new(indexBuffer, indexAccessor.count, indexAccessor.componentType)
  }

  draw(){
    for(a in _attributes){
      Renderer.enableAttribute(a)
    }
    Renderer.drawIndices(_index)
  }
}

class Node {

  mesh { _mesh }
  mesh=(v) { _mesh = v }
  transform { _transform }

  construct new(mesh, transform){
    _mesh = mesh
    _transform = transform
  }

  draw(){
    Renderer.setUniformMat4(UniformType.Model, _transform)
    if(_mesh) _mesh.draw()
  }
}

class Mesh {

  geometry { _geometry }

  construct new(geometry, material){
    _geometry = geometry
    _material = material
  }

  draw(){
    if(_material) _material.use()
    _geometry.draw()
  }
}

class DiffuseMaterial {
  construct new(texture){
    _texture = texture
  }

  use(){
    Renderer.setUniformTexture(UniformType.Texture0, 0, _texture)
  }
}

foreign class InternalShader {
  construct new(vertexSrc, fragmentSrc){}
  foreign bindAttribute(type, name)
  foreign bindUniform(type, name)
}

class Shader {

  static default2d {
    if(!__default2d){
      var mapping = {
        "attributes": {
          "vPosition": AttributeType.Position,
          "vTexcoord": AttributeType.Texcoord0,
          "vColor": AttributeType.Color
        },
        "uniforms": {
          "uTexture": UniformType.Texture0,
          "uProjection": UniformType.Projection,
          "uModel": UniformType.Model,
          "uView": UniformType.View,
          "uTextureSize": UniformType.TextureSize
        }
      }
      __default2d = Shader.fromFiles("./shaders/2d.vertex.glsl","./shaders/2d.fragment.glsl", mapping)
    }
    return __default2d
  }

  static default3d {
    if(!__default3d){
      var mapping = {
        "attributes": {
          "vPosition": AttributeType.Position,
          "vColor": AttributeType.Color,
          "vTexcoord": AttributeType.Texcoord0,
          "vNormal": AttributeType.Normal
        },
        "uniforms": {
          "uProjection": UniformType.Projection,
          "uModel": UniformType.Model,
          "uView": UniformType.View,
          "uTexture": UniformType.Texture0,
          "uLight0": UniformType.Light0,
          "uNormal": UniformType.Normal,
          "t": UniformType.Time
        }
      } 
      __default3d = Shader.fromFiles("./shaders/3d.vertex.glsl","./shaders/3d.fragment.glsl", mapping)
    }
    return __default3d
  }

  internal { _internal }

  construct new(vertexSrc, fragmentSrc, mapping){
    _internal = InternalShader.new(vertexSrc, fragmentSrc)
    init(mapping)
  }

  construct fromFiles(vertexPath, fragmentPath, mapping){
    var vsrc = File.open(vertexPath, "rb").readToEnd()
    var fsrc = File.open(fragmentPath, "rb").readToEnd()

    _internal = InternalShader.new(vsrc, fsrc)
    init(mapping)
  }

  init(mapping){

    if(mapping.containsKey("attributes")){
      for(key in mapping["attributes"].keys){
        _internal.bindAttribute(mapping["attributes"][key], key)
      }
    }
    if(mapping.containsKey("uniforms")){
      for(key in mapping["uniforms"].keys){
        _internal.bindUniform(mapping["uniforms"][key], key)
      }
    }
  }

  enable(){
    Renderer.setShader(this)
  }

}





import "camera" for OrbitCamera
import "platform" for Keyboard, Application, Event
import "math" for Vec2

class CameraHelpers {
  static OrbitCameraKeyboardInput(cam, speed){
    if(Keyboard.isDown("up")){
      cam.phi(-speed)
    }
    if(Keyboard.isDown("down")){
      cam.phi(speed)
    }
    if(Keyboard.isDown("left")){
      cam.theta(speed)
    }
    if(Keyboard.isDown("right")){
      cam.theta(-speed)
    }
    if(Keyboard.isDown("w")){
      cam.radius(-speed*0.5)
    }
    if(Keyboard.isDown("s")){
      cam.radius(speed*0.5)
    }

  }

  static OrbitCameraMouseInput(cam, speed){
    var mouse = [0,0]
    var move = false

    Application.on(Event.Mousemotion){|args|
      if(move){
        var dx = args[1] - mouse[0]
        var dy = args[2] - mouse[1]
        cam.phi(-dy/10)
        cam.theta(dx/10)
      }
      mouse[0] = args[1]
      mouse[1] = args[2]
    }
    Application.on(Event.Mousebuttondown){|args|
      move = true
    }
    Application.on(Event.Mousebuttonup){|args|
      move = false
    }    
  }

  static FlyCameraKeyboardInput(cam, speed){
    if(Keyboard.isDown("up")){
      cam.pitch(speed)
    }
    if(Keyboard.isDown("down")){
      cam.pitch(-speed)
    }
    if(Keyboard.isDown("left")){
      cam.yaw(-speed)
    }
    if(Keyboard.isDown("right")){
      cam.yaw(speed)
    }
    if(Keyboard.isDown("w")){
      cam.moveForward(speed*0.1)
    }
    if(Keyboard.isDown("s")){
      cam.moveForward(-speed*0.1)
    }
    if(Keyboard.isDown("a")){
      cam.moveRight(-speed*0.1)
    }
    if(Keyboard.isDown("d")){
      cam.moveRight(speed*0.1)
    }

  }
}

import "graphics" for Shader, UniformType, Colors
import "geometry" for AttributeType, GeometryData, GeometryWriter
import "memory" for DataType, Buffer, BufferView, FloatVecAccessor, UByteVecAccessor, UShortAccessor
import "math" for Vec3, Math

class HexData is GeometryData {
  
  positions { _positions }
  colors { _colors }
  
  construct new(count, hexSize){
    var vertexSize = DataType.size(DataType.Float) * 6 + DataType.size(DataType.UByte) * 4
    var hexagonSize = vertexSize * (6+6*4+1)
    var buffer = Buffer.new(hexagonSize * count)
    var view = BufferView.new(buffer)
    var accessors = {
      AttributeType.Position: FloatVecAccessor.fromBufferView(view, 3, vertexSize,0),
      AttributeType.Normal: FloatVecAccessor.fromBufferView(view, 3, vertexSize, DataType.size(DataType.Float) * 3),
      AttributeType.Color: UByteVecAccessor.fromBufferView(view, 4, vertexSize, DataType.size(DataType.Float) * 6)
    }

    var hexagonIndices = 6*3+6*2*3
    var indices = UShortAccessor.new(hexagonIndices*count)

    super(accessors, indices)
    
    _positions = this[AttributeType.Position]
    _colors = this[AttributeType.Color]
    _colors.normalized = true
    _normals = this[AttributeType.Normal]
    
    _w = 2 * hexSize
    _h = 3.sqrt * hexSize
    _size = hexSize
    _position = [0,0,0]
    _normal = [0,0,0]
    _vs = [_position, Colors.White, _normal]
    _writer = GeometryWriter.new([_positions, _colors, _normals], indices)
  }

  flatHexCorner(i){
    var angle = Math.rad(60*i)
    _position[0] = _size * angle.cos
    _position[2] = _size * angle.sin
  }

  sideNormal(i){
    var angle = Math.rad((60*i)+30)
    _normal[0] = angle.cos
    _normal[1] = 0
    _normal[2] = angle.sin
  }

  writeVertex(){
    _writer.vertex(_vs)
  }

  writeTri(a,b,c){
    _writer.tri(a,b,c)
  }

  writeCap(x,z,height){
    // normal
    Vec3.set(0,1,0,_normal)
    // center
    Vec3.set(x,height,z, _position)
    writeVertex()
    // cap
    for(i in 1..6){
      flatHexCorner(6-i)
      Vec3.add(_position, x, 0, z, _position)
      writeVertex()
      writeTri(_o,_o+i,_o+(i%6)+1)
    }
  }

  setColor(color){
    _vs[1] = color
  }

  writeSide(i){
    sideNormal(6-i)
    
    var a = _writer.vertexOffset
    Vec3.copy(positions[_o+i], _position)
    writeVertex()

    var b = _writer.vertexOffset
    _position[1] = 0
    writeVertex()
    
    var c = _writer.vertexOffset
    Vec3.copy(positions[_o+(i%6)+1], _position)
    writeVertex()
    
    var d = _writer.vertexOffset
    _position[1] = 0
    //vs[1] = Colors.DarkGrey
    writeVertex()

    writeTri(a,b,c)
    writeTri(b,d,c) 
  }

  addHexagon(x,z,height, color){
    z = z*_h + (x%2 == 1 ? _h/2 : 0)
    x = x * (0.75*_w)
    var v3 = _vs[0]
    var writer = _writer
    var vs = _vs

    setColor(color)
    _o = _writer.vertexOffset
    writeCap(x,z,height)

    if(height == 0) return
    
    // sides
    for(i in 1..6){
      writeSide(i)
    }
  }
}

class Hexaglott {
  static createShader(){
    var mapping = {
      "attributes": {
        "vPosition": AttributeType.Position,
        //"vColor": AttributeType.Color,
        "vNormal": AttributeType.Normal,
        "vTexcoord": AttributeType.Texcoord0
      },
      "uniforms": {
        "uProjection": UniformType.Projection,
        "uModel": UniformType.Model,
        "uView": UniformType.View,
        "uLight": UniformType.Light0,
        "uTexture": UniformType.Texture0
      }
    }
    
    return Shader.fromFiles("./shaders/hexaglott.vertex.glsl","./shaders/hexaglott.fragment.glsl", mapping)
  }
  static createMaterial(){
    return HexaglottMaterial.new()
  }
}

class HexaglottMaterial {
  construct new(){}
  use(){}
}

foreign class Image {  
  construct new(width, height){
    allocate(width, height)
  }
  construct fromBuffer(buf){
    buffer(buf, 0, buffer.size)
  }
  construct fromBufferView(view){
    buffer(view.buffer, view.offset, view.size)
  }
  construct fromFile(path){
    load(path)
  }

  width { getWidth() }
  height { getHeight() }

  //private 
  foreign load(path)
  foreign buffer(buffer, offset, size)
  foreign allocate(width, height)

  // public
  foreign put(imgData, sx, sy, sw, sh, dx, dy)
  put(imgData){
    put(imgData, 0, 0, imgData.width, imgData.height)
  }
  put(imgData, dx, dy){
    put(imgData, 0, 0, imgData.width, imgData.height, dx, dy)
  }
  foreign setPixel(x, y, r, g, b, a)
  foreign setPixel(x, y, vec4)
  foreign getPixel(x, y, vec4)
  foreign getPixelInt(x,y)
  foreign save(filename)

  foreign getWidth()
  foreign getHeight()
}class Path {
  static getFolder(filename){
    filename = filename.replace("\\","/")
    var frags = filename.split("/")
    frags.removeAt(-1)
    return frags.join("/")
  }
}

class SeekOrigin {
  static Start { 0 }
  static Current { 1 }
  static End { 2 }
}

foreign class File { 
  construct open(path, mode) {}
  foreign length()
  foreign close() 
  foreign read(size)
  foreign readString(size)
  foreign pos()
  foreign readUByte() 
  foreign readByte() 
  foreign readUShort()
  foreign readShort()
  foreign readUInt()
  foreign readInt()
  foreign readFloat()
  foreign readDouble()
  foreign seek(offset, origin)
  readToEnd(){
    return read(length())
  }
}
class Json {
  static parse(string) {
    return JsonParser.new(string).parse()
  }
}

class Tokens {
  static Undefined { 0 }
  static Object { 1 }
  static Array { 2 }
  static String { 3 }
  static Null { 4 }
  static Number { 5 }
  static Bool { 6 }
}

foreign class JsonParser {
    
  construct new(string){

  }

  parse(){
    nextToken()
    while(getToken() == Tokens.Undefined){
      nextToken()
    }
    return parseToken(getToken())
  }

  parseToken(token){
    if(token == Tokens.Object){
      return parseObject()
    } else if(token == Tokens.Array){
      return parseArray()
    } else {
      return getValue()
    }
  }

  parseObject(){
    var obj = {}
    for (i in 0...getChildren()) {
      nextToken()
      var key = getValue()
      nextToken()
      obj[key] = parseToken(getToken())
    }
    return obj
  }

  parseArray(){
    var arr = []
    for (i in 0...getChildren()) {
      nextToken()
      arr.add(parseToken(getToken()))
    }
    return arr
  }

  foreign getValue()
  foreign getToken()
  foreign nextToken()
  foreign getChildren()  
}class Math {
  static rad(deg){ deg * 0.01745329252 }
  static deg(rad){ rad / 0.01745329252 }
  static min(a,b) { a < b ? a : b }
  static max(a,b) { a < b ? b : a }
  static clamp(low,high,val) { Math.min(Math.max(val, low), high) }
}

class Vec2 {

  static zero(dst){
    dst[0] = 0
    dst[1] = 0
  }

  static zero(){
    return [0,0]
  }

  static copy(a,b){
    b[0] = a[0]
    b[1] = a[1] 
  }

  static clone(a){
    return [a[0],a[1]]
  }

  static add(a,b,dest){
    dest[0] = a[0] + b[0]
    dest[1] = a[1] + b[1]
  }

  static add(a,x,y,dest){
    dest[0] = a[0] + x
    dest[1] = a[1] + y
  }

  static addV(a,v,dest){
    dest[0] = a[0] + v
    dest[1] = a[1] + v
  }

  static sub(a,b,dest){
    dest[0] = a[0] - b[0]
    dest[1] = a[1] - b[1]
  }

  static set(x,y, dest){
    dest[0] = x
    dest[1] = y
  }

  static floor(src,dst){
    dst[0] = src[0].floor
    dst[1] = src[1].floor
  }

  static frac(src,dst){
    dst[0] = src[0] - src[0].floor
    dst[1] = src[1] - src[1].floor
  }

  static mul(a,b,dst){
    dst[0] = a[0] * b[0]
    dst[1] = a[1] * b[1]
  }

  static mulV(a,v,dst){
    dst[0] = a[0] * v
    dst[1] = a[1] * v
  }

  static sign(src,dst){
    dst[0] = src[0] > 0 ? 1 : (src[0] < 0 ? -1 : 0)
    dst[1] = src[1] > 0 ? 1 : (src[1] < 0 ? -1 : 0)
  }

}



class Vec4 {
  static create(x,y,z,w){
    return [x,y,z,w]
  }

  static zero(dst){
    dst[0] = 0
    dst[1] = 0
    dst[2] = 0
    dst[3] = 0
  }

  static copy(src, dst){
    dst[0] = src[0] 
    dst[1] = src[1] 
    dst[2] = src[2] 
    dst[3] = src[3] 
  }

  static zero(){
    return [0,0,0,0]
  }

  static add(a,b,dst){
    dst[0] = a[0]+b[0]
    dst[1] = a[1]+b[1]
    dst[2] = a[2]+b[2]
    dst[3] = a[3]+b[3]
  }

  static divV(a,v,dst){
    dst[0] = a[0]/v
    dst[1] = a[1]/v
    dst[2] = a[2]/v
    dst[3] = a[3]/v
  }

  static mulV(a,v,dst){
    dst[0] = a[0]*v
    dst[1] = a[1]*v
    dst[2] = a[2]*v
    dst[3] = a[3]*v
  }

  static equals(a,b){
    return a[0] == b[0] &&
    a[1] == b[1] &&
    a[2] == b[2] &&
    a[3] == b[3]
  }

  static set(x,y,z,w,dst){
    dst[0] = x 
    dst[1] = y 
    dst[2] = z 
    dst[3] = w 
  }

  static clampV(src,v,dest){
    dest[0] = Math.min(src[0],v)
    dest[1] = Math.min(src[1],v)
    dest[2] = Math.min(src[2],v)
    dest[3] = Math.min(src[3],v)
  }
}

class Vec3 {
  static zero(dst){
    dst[0] = 0
    dst[1] = 0
    dst[2] = 0
  }

  static zero(){
    return [0,0,0]
  }

  static clone(src){
    return [src[0],src[1],src[2]]
  }

  static one(dst){
    dst[0] = 1
    dst[1] = 1
    dst[2] = 1
  }

  static create(x,y,z){
    return [x,y,z]
  }

  static set(x,y,z,dst){
    dst[0] = x
    dst[1] = y
    dst[2] = z
  }

  static set(src,dst){
    dst[0] = src[0]
    dst[1] = src[1]
    dst[2] = src[0]
  }

  static copy(src,dst){
    dst[0] = src[0]
    dst[1] = src[1]
    dst[2] = src[2]
  }

  static add(v1,v2,dst){
    dst[0] = v1[0] + v2[0]
    dst[1] = v1[1] + v2[1]
    dst[2] = v1[2] + v2[2]
  }

  static add(v1,x,y,z,dst){
    dst[0] = v1[0] + x
    dst[1] = v1[1] + y
    dst[2] = v1[2] + z
  }

  static mul(a,b,dst){
    dst[0] = a[0] * b[0]
    dst[1] = a[1] * b[1]
    dst[2] = a[2] * b[2]
  }

  static mulV(a, v, dst){
    dst[0] = a[0] * v
    dst[1] = a[1] * v
    dst[2] = a[2] * v
  }

  static div(a,b,dst){
    dst[0] = a[0] / b[0]
    dst[1] = a[1] / b[1]
    dst[2] = a[2] / b[2]
  }

  static divV(a, v, dst){
    dst[0] = a[0] / v
    dst[1] = a[1] / v
    dst[2] = a[2] / v
  }

  static sub(v1, v2, dst){
    dst[0] = v1[0] - v2[0]
    dst[1] = v1[1] - v2[1]
    dst[2] = v1[2] - v2[2]
  }

  static extract(all, offset, dst){
    dst[0] = all[offset + 0]
    dst[1] = all[offset + 1]
    dst[2] = all[offset + 2]
  }

  static insert(src, offset, all){
    all[offset+0] = src[0]
    all[offset+1] = src[1]
    all[offset+2] = src[2]
  }

  static norm(v){
    return Vec3.norm2(v).sqrt
  }

  static cross(a,b,dest){
    var a0 = a[0]
    var a1 = a[1]
    var a2 = a[2]
    var b0 = b[0]
    var b1 = b[1]
    var b2 = b[2]
    dest[0] = a1 * b2 - a2 * b1
    dest[1] = a2 * b0 - a0 * b2
    dest[2] = a0 * b1 - a1 * b0
  }

  static crossn(a,b,dest){
    cross(a,b,dest)
    normalize(dest,dest)
  }

  static norm2(v){
    return Vec3.dot(v,v)
  }

  static normalize(v, d) {
    var norm = Vec3.norm(v)

    if (norm == 0.0) {
      d[0] = 0
      d[1] = 0
      d[2] = 0
      return
    }

    Vec3.scale(v, 1.0 / norm, d)
  }

  static scale(v,s,d){
    d[0] = v[0] * s 
    d[1] = v[1] * s 
    d[2] = v[2] * s 
  }

  static dot(a,b){
    return a[0] * b[0] + a[1] * b[1] + a[2] * b[2]
  }

  static distance2(a,b){
    return (a[0] - b[0]).pow(2) + (a[1] - b[1]).pow(2) + (a[2] - b[2]).pow(2)
  }

  static distance(a,b){
    return distance2(a,b).sqrt
  }
}

foreign class Mat4 {
  construct new(){
    identity()
  }
  construct clone(m){
    copy(m)
  }
  foreign identity()
  foreign translate(x,y,z)
  foreign rotateX(v)
  foreign rotateY(v)
  foreign rotateZ(v)
  foreign rotateQuat(a,b,c,d)
  foreign scale(x,y,z)
  foreign copy(m)
  foreign mul(m)
  foreign mulVec3(v3)
  foreign project(v3)
  foreign unproject(v3)
  foreign lookAt(eye, target, up)
  foreign invert()
  foreign transpose()
  foreign perspective(fov, near, far)
  foreign ortho()
}

class Noise {
  foreign static seed(seed)
  foreign static perlin2d(x,y,freq,depth)
}
class MapUtil {
  static merge(from, to){
    for(k in from.keys){
      if(!to.containsKey(k)){
        to[k] = from[k]
      }
    }
    return to
  }
}

class ListUtil {
  static indexOf(list, item) {
    for(i in 0...list.count){
      if(list[i] == item){
        return i
      }
    }
    return -1
  }

  static selectMany(list,fn){
    return list.reduce([]) {|p,c|
      var l =fn.call(c).toList
      p = p + l
      return p 
    }
  }

  static first(list, fn){
    for(e in list){
      if(fn.call(e)) return e
    }
  }

  static filter(list, fn){
    var l = []
    for(e in list){
      if(fn.call(e)){
        l.add(e)
      }
    }
    return l
  }

  static mapUnique(list, fn){
    var visited = []
    var generated = []
    var out = []
    
    for(el in visited){
      var index = ListUtil.indexOf(visited,el)
      if(index == -1){
        var newItem = fn.call(el)
        generated.add(newItem)
        visited.add(el)
        out.add(newItem)
      } else {
        out.add(generated[index])
      }
    }

    return out
  }
}

class Grid {

  width { _w }
  height { _h }
  count { _data.count }

  construct new(w,h, def, seed){
    init(w,h,def,seed)
  }

  construct new(w,h, def){
    init(w,h,def,null)
  }

  construct new(w,h){
    init(w,h,null, null)
  }

  init(w,h,default,seed){
    _w = w
    _h = h
    _default = default
    _seed = seed
    _neighbours = List.filled(4, null)
    clear()
  }

  clear(){
    _data = List.filled(_w*_h, _seed)
  }

  [i] {
    return _data[i]
  }

  [i]=(v) {
    _data[i] = v
  }

  [x,y] {
    if(isOutOfBounds(x,y)) return _default
    return _data[y*_w+x]
  }

  [x,y]=(v) {
    if(isOutOfBounds(x,y)) return
    _data[y*_w+x] = v
  }

  isOutOfBounds(x,y){
    return y < 0 || y >= _h || x < 0 || x >= _w
  }

  neighbours(x,y){
    //if((x<0||x>=_w)||(y<0||y>=_h)) Fiber.abort("Argument out of range")
    //up
    _neighbours[0] = this[x+1,y] 
    _neighbours[1] = this[x-1,y]
    _neighbours[2] = this[x,y-1] 
    _neighbours[3] = this[x,y+1] 
    return _neighbours 
  }

  iterate(val) { _data.iterate(val)  }
  iteratorValue(val) { _data.iteratorValue(val) }

  fill(fn) {
    for(y in 0..._h){
      for(x in 0..._w){
        this[x,y] = fn.call(x,y)
      }
    }
  }

  forEachXY(fn){
    for(y in 0..._h){
      for(x in 0..._w){
        fn.call(x,y,this[x,y])
      }
    }
  }

  subGrid(x,y,w,h){
    var grid = Grid.new(w,h,_default,_seed)
    this.forEachXY {|ox,oy,v|
      grid[ox+x,oy+y] = v
    }
    return grid
  }
}

class BufferView {

  buffer { _buffer }
  offset { _offset }
  size { _size }

  construct fromBufferView(view, offset, size){
    _buffer = view.buffer
    offset = offset + view.offset
    if(_buffer.size < offset+size){
      Fiber.abort("View outside buffer bounds")
    }
    _offset = offset
    _size = size
  }

  construct new(buffer, offset, size){
    _buffer = buffer
    if(_buffer.size < offset+size){
      Fiber.abort("View outside buffer bounds")
    }
    _offset = offset
    _size = size
  }
  construct new(buffer){
    _buffer = buffer
    _offset = 0
    _size = buffer.size
  }
}

class Float32Array is BufferView {

  length { _length }
  count { _length }
  
  [i] { buffer.readFloat(offset+i*4) }
  [i]=(val) { buffer.writeFloat(offset+i*4, val) }

  construct new(length){
    var buffer = Buffer.new(length*4)
    super(buffer)
    _length = length
  }
  construct new(buffer, offset, size){
    if(size%4 != 0){
      Fiber.abort("Size must be aligned")
    }
    super(buffer, offset, size)
    _length = size/4
  }

  iterate(val) { val == null ? 0 : ( val >= _length-1 ? false : val+1)  }
  iteratorValue(val) { buffer.readFloat(offset+val*4) }
}

foreign class Buffer {
  construct new(size){
    init_allocate(size)
  }
  construct fromBuffer(buffer){
    init_copy(buffer, 0, buffer.size)
  }
  construct fromBufferView(view){
    init_copy(view.buffer, view.offset, view.size)
  }

  construct fromFile(path){
    init_load(path)
  }

  size { getSize() }

  foreign init_load(path)
  foreign init_allocate(size)
  foreign init_copy(buffer, offset, size)

  foreign getSize()

  foreign copyFrom(buffer, srcOffset, srcSize, dstOffset)
  foreign readString(offset, size)
  foreign readByte(offset)
  foreign readShort(offset)
  foreign readInt(offset)
  foreign readUByte(offset)
  foreign readUShort(offset)
  foreign readUInt(offset)
  foreign readFloat(offset)
  foreign readDouble(offset)
  foreign readByteVec(offset, v)
  foreign readShortVec(offset, v)
  foreign readIntVec(offset, v)
  foreign readUByteVec(offset, v)
  foreign readUShortVec(offset, v)
  foreign readUIntVec(offset, v)
  foreign readFloatVec(offset, v)
  foreign readDoubleVec(offset, v)

  foreign writeByte(offset, v)
  foreign writeShort(offset, v)
  foreign writeInt(offset, v)
  foreign writeUByte(offset, v)
  foreign writeUShort(offset, v)
  foreign writeUInt(offset, v)
  foreign writeFloat(offset, v)
  foreign writeDouble(offset, v)
  foreign writeByteVec(offset, v)
  foreign writeShortVec(offset, v)
  foreign writeIntVec(offset, v)
  foreign writeUByteVec(offset, v)
  foreign writeUShortVec(offset, v)
  foreign writeUIntVec(offset, v)
  foreign writeFloatVec(offset, v)
  foreign writeDoubleVec(offset, v)
}

class DataType {
  
  static Byte { 0x1400 }
  static UByte { 0x1401 }
  static Short { 0x1402 }
  static UShort { 0x1403 }
  static Int { 0x1404 }
  static UInt { 0x1405 }
  static Float { 0x1406 }
  static Double { 0x14FF }

  static size(type){
    if(type == DataType.Byte || type == DataType.UByte) return 1
    if(type == DataType.Short || type == DataType.UShort) return 2
    if(type == DataType.Int || type == DataType.UInt || type == DataType.Float) return 4
    if(type == DataType.Double) return 8
  }
}

class Accessor {

  static constructorForVecType(type){
    if(type == DataType.Byte) return ByteVecAccessor
    if(type == DataType.UByte) return UByteVecAccessor
    if(type == DataType.Short) return ShortVecAccessor
    if(type == DataType.UShort) return UShortVecAccessor
    if(type == DataType.Int) return IntVecAccessor
    if(type == DataType.UInt) return UIntVecAccessor
    if(type == DataType.Float) return FloatVecAccessor
  }

  static constructorForType(type){
    if(type == DataType.Byte) return ByteAccessor
    if(type == DataType.UByte) return UByteAccessor
    if(type == DataType.Short) return ShortAccessor
    if(type == DataType.UShort) return UShortAccessor
    if(type == DataType.Int) return IntAccessor
    if(type == DataType.UInt) return UIntAccessor
    if(type == DataType.Float) return FloatAccessor
  }


  bufferView { _bufferView }
  count { _count }
  componentType { _componentType }
  numComponents { _numComponents }
  stride { _stride }
  offset { _offset }
  normalized { _normalized }
  normalized=(v) { _normalized = v }
  

  construct fromBufferView(bufferView, numComponents, stride, offset, dataType) {
    init(bufferView, dataType, numComponents, stride, offset)
  }

  construct new(count, numComponents, dataType){
    var b = Buffer.new(DataType.size(dataType)*numComponents*count)
    var v = BufferView.new(b)
    init(v, dataType, numComponents, 0, 0)
  }

  init(bufferView, componentType, numComponents, stride, offset){
    _normalized = false
    _bufferView = bufferView
    _componentType = componentType
    _numComponents = numComponents
    _stride = stride == 0 ? numComponents * DataType.size(componentType) : stride
    if(bufferView.size % _stride != 0){
      Fiber.abort("BufferView size is not aligned with stride")
    }
    _count = bufferView.size / _stride
    _offset = offset
    _value = []
    for(i in 0..._numComponents){
      _value.add(0)
    }
  }

  [i] { getVal(_bufferView.buffer, elementOffset(i), _value) }
  [i]=(v) { setVal(_bufferView.buffer, elementOffset(i), v) }

  iterate(val) { val == null ? 0 : ( val >= _count-1 ? false : val+1)  }
  iteratorValue(val) { getVal(_bufferView.buffer, elementOffset(val), _value) }

  elementOffset(i){
    return _bufferView.offset + (_stride * i) + _offset
  }
}

class ByteAccessor is Accessor {
  construct new(count){ super(count, 1, DataType.Byte) }
  construct fromBufferView(bufferView, stride, offset) { super(bufferView, 1, stride, offset, DataType.Byte) }
  getVal(b,o,v) { 
    return b.readByte(o) 
  }
  setVal(b,o,v) { b.writeByte(o,v) }
}

class UByteAccessor is Accessor {
  construct new(count){ super(count, 1, DataType.UByte) }
  construct fromBufferView(bufferView, stride, offset) { super(bufferView, 1, stride, offset, DataType.UByte) }
  getVal(b,o,v) { 
    return b.readUByte(o) 
  }
  setVal(b,o,v) { b.writeUByte(o,v) }
}

class ShortAccessor is Accessor {
  construct new(count){ super(count, 1, DataType.Short) }
  construct fromBufferView(bufferView, stride, offset) { super(bufferView, 1, stride, offset, DataType.Short) }
  getVal(b,o,v) { 
    return b.readShort(o) 
  }
  setVal(b,o,v) { b.writeShort(o,v) }
}

class UShortAccessor is Accessor {
  construct new(count){ super(count, 1, DataType.UShort) }
  construct fromBufferView(bufferView, stride, offset) { super(bufferView, 1, stride, offset, DataType.UShort) }
  getVal(b,o,v) { 
    return b.readUShort(o) 
  }
  setVal(b,o,v) { b.writeUShort(o,v) }
}

class IntAccessor is Accessor {
  construct new(count){ super(count, 1, DataType.Int) }
  construct fromBufferView(bufferView, stride, offset) { super(bufferView, 1, stride, offset, DataType.Int) }
  getVal(b,o,v) { 
    return b.readInt(o) 
  }
  setVal(b,o,v) { b.writeInt(o,v) }
}

class UIntAccessor is Accessor {
  construct new(count){ super(count, 1, DataType.UInt) }
  construct fromBufferView(bufferView, stride, offset) { super(bufferView, 1, stride, offset, DataType.UInt) }
  getVal(b,o,v) { 
    return b.readUInt(o) 
  }
  setVal(b,o,v) { b.writeUInt(o,v) }
}

class FloatAccessor is Accessor {
  construct new(count){ super(count, 1, DataType.Float) }
  construct fromBufferView(bufferView, stride, offset) { super(bufferView, 1, stride, offset, DataType.Float) }
  getVal(b,o,v) { 
    return b.readFloat(o) 
  }
  setVal(b,o,v) { b.writeFloat(o,v) }
}

class ByteVecAccessor is Accessor {
  construct new(count, numComponents){ super(count, numComponents, DataType.Byte) }
  construct fromBufferView(bufferView, numComponents, stride, offset) { super(bufferView, numComponents, stride, offset, DataType.Byte) }
  getVal(b,o,v) { 
    b.readByteVec(o,v)
    return v 
  }
  setVal(b,o,v) { b.writeByteVec(o,v) }
}

class UByteVecAccessor is Accessor {
  construct new(count, numComponents){ super(count, numComponents, DataType.UByte) }
  construct fromBufferView(bufferView, numComponents, stride, offset) { super(bufferView, numComponents, stride, offset, DataType.UByte) }
  getVal(b,o,v) { 
    b.readUByteVec(o,v)
    return v 
  }
  setVal(b,o,v) { b.writeUByteVec(o,v) }
}

class ShortVecAccessor is Accessor {
  construct new(count, numComponents){ super(count, numComponents, DataType.Short) }
  construct fromBufferView(bufferView, numComponents, stride, offset) { super(bufferView, numComponents, stride, offset, DataType.Short) }
  getVal(b,o,v) { 
    b.readShortVec(o,v)
    return v 
  }
  setVal(b,o,v) { b.writeShortVec(o,v) }
}

class UShortVecAccessor is Accessor {
  construct new(count, numComponents){ super(count, numComponents, DataType.UShort) }
  construct fromBufferView(bufferView, numComponents, stride, offset) { super(bufferView, numComponents, stride, offset, DataType.UShort) }
  getVal(b,o,v) { 
    b.readUShortVec(o,v)
    return v 
  }
  setVal(b,o,v) { b.writeUShortVec(o,v) }
}

class IntVecAccessor is Accessor {
  construct new(count, numComponents){ super(count, numComponents, DataType.Int) }
  construct fromBufferView(bufferView, numComponents, stride, offset) { super(bufferView, numComponents, stride, offset, DataType.Int) }
  getVal(b,o,v) { 
    b.readIntVec(o,v)
    return v 
  }
  setVal(b,o,v) { b.writeIntVec(o,v) }
}

class UIntVecAccessor is Accessor {
  construct new(count, numComponents){ super(count, numComponents, DataType.UInt) }
  construct fromBufferView(bufferView, numComponents, stride, offset) { super(bufferView, numComponents, stride, offset, DataType.UInt) }
  getVal(b,o,v) { 
    b.readUIntVec(o,v)
    return v 
  }
  setVal(b,o,v) { b.writeUIntVec(o,v) }
}

class FloatVecAccessor is Accessor {
  construct new(count, numComponents){ super(count, numComponents, DataType.Float) }
  construct fromBufferView(bufferView, numComponents, stride, offset) { super(bufferView, numComponents, stride, offset, DataType.Float) }
  getVal(b,o,v) { 
    b.readFloatVec(o,v)
    return v 
  }
  setVal(b,o,v) { b.writeFloatVec(o,v) }
}
import "graphics" for Shader, Renderer, Colors, RendererBlendFunc

class Severity {
  static Off { 0 }
  static Error { 1 }
  static Warning { 2 }
  static Info { 3 }
  static Debug { 4 }
}

class Module {
  static Core { 1 }
  static Graphics { 2 }
  static Json { 3 }
  static Wren { 4 }
  static Platform { 5 }
  static Renderer { 6 }
  static Image { 7 }
}

class Application {  

  static args { __args }

  foreign static logLevel(severity)
  foreign static logLevel(module, severity)
  foreign static quit()
  foreign static pollEvent(out)
  foreign static loadModuleInternal(module, file)

  static loadModule(module, file){
    Fiber.new{ 
      Application.loadModuleInternal(module, file) 
    }.call()
  }

  static onUpdate(callback){
    on(Event.Update, callback)
  }

  static onInit(callback){
    on(Event.Init, callback)
  }

  static onLoad(callback){
    on(Event.Load, callback)
  }

  static on(event, fn){
    __handlers = __handlers || {}
    __handlers[event] = __handlers[event] || [] 
    __handlers[event].add(fn)
  }

  static dispatchEvent(type, args){
    var handlerList = __handlers[type]
    
    if(handlerList){
      for(handler in handlerList){
        handler.call(args)
      }
    }
  }

  static update(delta) { 
    while(Application.pollEvent(__eventArgs)){
      var type = __eventArgs[0]
      dispatchEvent(type,__eventArgs)
      
      if(__eventArgs[0] == Event.Quit) Application.quit()       
    }
    __updateArgs[1] = delta
    dispatchEvent(Event.Update, __updateArgs)
  }

  static init(args){
    __eventArgs = [null,null,null,null,null,null,null]
    Mouse.init()
    __args = args
    Colors.init()
    __updateArgs = [Event.Update, 0]
    
    dispatchEvent(Event.Init, [Event.Init])
  }

  static load(){
    Renderer.blendFunc(RendererBlendFunc.SrcAlpha, RendererBlendFunc.OneMinusSrcAlpha)
    Renderer.set3d()
    
    dispatchEvent(Event.Load, [Event.Load])

    System.gc()
  }
}

class Window {
  foreign static config(w,h,title)
}

class Keyboard {
  foreign static isDown(key)
}

class Mouse {

  static init(){
    __pos = [0,0]
  }

  static position {
    Mouse.getPosition(__pos) 
    return __pos
  }

  foreign static getPosition(vec2)
  foreign static setPosition(x,y)
}

class Event {
    static getName(n){
      if(n == Event.Quit) return "Quit"
      if(n == Event.Terminating) return "Terminating"
      if(n == Event.Lowmemory) return "Lowmemory"
      if(n == Event.Willenterbackground) return "Willenterbackground"
      if(n == Event.Didenterbackground) return "Didenterbackground"
      if(n == Event.Willenterforeground) return "Willenterforeground"
      if(n == Event.Didenterforeground) return "Didenterforeground"
      if(n == Event.Displayevent) return "Displayevent"
      if(n == Event.Windowevent) return "Windowevent"
      if(n == Event.Syswmevent) return "Syswmevent"
      if(n == Event.Keydown) return "Keydown"
      if(n == Event.Keyup) return "Keyup"
      if(n == Event.Textediting) return "Textediting"
      if(n == Event.Textinput) return "Textinput"
      if(n == Event.Keymapchanged) return "Keymapchanged"
      if(n == Event.Mousemotion) return "Mousemotion"
      if(n == Event.Mousebuttondown) return "Mousebuttondown"
      if(n == Event.Mousebuttonup) return "Mousebuttonup"
      if(n == Event.Mousewheel) return "Mousewheel"
      if(n == Event.Joyaxismotion) return "Joyaxismotion"
      if(n == Event.Joyballmotion) return "Joyballmotion"
      if(n == Event.Joyhatmotion) return "Joyhatmotion"
      if(n == Event.Joybuttondown) return "Joybuttondown"
      if(n == Event.Joybuttonup) return "Joybuttonup"
      if(n == Event.Joydeviceadded) return "Joydeviceadded"
      if(n == Event.Joydeviceremoved) return "Joydeviceremoved"
      if(n == Event.Controlleraxismotion) return "Controlleraxismotion"
      if(n == Event.Controllerbuttondown) return "Controllerbuttondown"
      if(n == Event.Controllerbuttonup) return "Controllerbuttonup"
      if(n == Event.Controllerdeviceadded) return "Controllerdeviceadded"
      if(n == Event.Controllerdeviceremoved) return "Controllerdeviceremoved"
      if(n == Event.Controllerdeviceremapped) return "Controllerdeviceremapped"
      if(n == Event.Fingerdown) return "Fingerdown"
      if(n == Event.Fingerup) return "Fingerup"
      if(n == Event.Fingermotion) return "Fingermotion"
      if(n == Event.Dollargesture) return "Dollargesture"
      if(n == Event.Dollarrecord) return "Dollarrecord"
      if(n == Event.Multigesture) return "Multigesture"
      if(n == Event.Clipboardupdate) return "Clipboardupdate"
      if(n == Event.Dropfile) return "Dropfile"
      if(n == Event.Droptext) return "Droptext"
      if(n == Event.Dropbegin) return "Dropbegin"
      if(n == Event.Dropcomplete) return "Dropcomplete"
      if(n == Event.Audiodeviceadded) return "Audiodeviceadded"
      if(n == Event.Audiodeviceremoved) return "Audiodeviceremoved"
      if(n == Event.Sensorupdate) return "Sensorupdate"
      if(n == Event.Rendertargetsreset) return "Rendertargetsreset"
      if(n == Event.Renderdevicereset) return "Renderdevicereset"
      if(n == Event.Init) return "Init"
      if(n == Event.Load) return "Load"
      if(n == Event.Update) return "Update"

    }

    // Wren-Only
    static Init { 0x1 }
    static Load { 0x2 }
    static Update { 0x3 }

    static Quit { 0x100 } 
    static Terminating { 0x101 }        
    static Lowmemory { 0x102 }          
    static Willenterbackground { 0x103 } 
    static Didenterbackground { 0x104 } 
    static Willenterforeground { 0x105 } 
    static Didenterforeground { 0x106 } 
    /* Display Events */
    static Displayevent { 0x150 }  
    /* Window Events */
    static Windowevent { 0x200 } 
    static Syswmevent { 0x201 }             
    /* Keyboard Events */
    static Keydown { 0x300 } 
    static Keyup { 0x301 }                  
    static Textediting { 0x302 }            
    static Textinput { 0x303 }              
    static Keymapchanged { 0x304 }          
    /* Mouse Events */
    static Mousemotion { 0x400 } 
    static Mousebuttondown { 0x401 }        
    static Mousebuttonup { 0x402 }          
    static Mousewheel { 0x403 }             
    /* Joystick Events */
    static Joyaxismotion { 0x600 } 
    static Joyballmotion { 0x601 }          
    static Joyhatmotion { 0x602 }           
    static Joybuttondown { 0x603 }          
    static Joybuttonup { 0x604 }            
    static Joydeviceadded { 0x605 }         
    static Joydeviceremoved { 0x606 }       
    /* Game Controller Events */
    static Controlleraxismotion { 0x650 } 
    static Controllerbuttondown { 0x651 }          
    static Controllerbuttonup { 0x652 }            
    static Controllerdeviceadded { 0x653 }         
    static Controllerdeviceremoved { 0x654 }       
    static Controllerdeviceremapped { 0x655 }      
    /* Touch Events */
    static Fingerdown { 0x700 }
    static Fingerup { 0x701 }
    static Fingermotion { 0x702 }
    /* Gesture Events */
    static Dollargesture { 0x800 }
    static Dollarrecord { 0x801 }
    static Multigesture { 0x802 }
    /* Clipboard Events */
    static Clipboardupdate { 0x900 } 
    /* Drag And Drop Events */
    static Dropfile { 0x1000 } 
    static Droptext { 0x1001 }                 
    static Dropbegin { 0x1002 }                
    static Dropcomplete { 0x1003 }             
    /* Audio Hotplug Events */
    static Audiodeviceadded { 0x1100 } 
    static Audiodeviceremoved { 0x1101 }        
    /* Sensor Events */
    static Sensorupdate { 0x1200 }     
    /* Render Events */
    static Rendertargetsreset { 0x2000 } 
    static Renderdevicereset { 0x2001 } 
}class StreamReader {

  offset { _offset }

  construct new(stream){
    _stream = stream
    _offset = 0
  }

  readByte(){
    var v = _stream.readByte(_offset)
    seekRel(1)
    return v
  }

  readUByte(){
    var v = _stream.readUByte(_offset)
    seekRel(1)
    return v
  }

  readShort(){
    var v = _stream.readShort(_offset)
    seekRel(2)
    return v
  }

  readUShort(){
    var v = _stream.readUShort(_offset)
    seekRel(2)
    return v
  }

  readInt(){
    var v = _stream.readInt(_offset)
    seekRel(4)
    return v
  }

  readUInt(){
    var v = _stream.readUInt(_offset)
    seekRel(4)
    return v
  }

  readFloat(){
    var v = _stream.readFloat(_offset)
    seekRel(4)
    return v
  }

  readDouble(){
    var v = _stream.readDouble(_offset)
    seekRel(8)
    return v
  }

  readString(size){
    var v = _stream.readString(_offset, size)
    seekRel(size)
    return v
  }

  seekRel(o){
    _offset = _offset + o
  }

  seek(o){
    _offset = o
  }
}class GeoTransform {
  construct new(mesh){
    _gd = mesh.geometryData
    _image = mesh.material.diffuse.source
    _pixelCoord = [0,0]
    _pixel = [0,0,0,0]
    _colors = UByteVecAccessor.new(_gd.positions.count,4)
    _colors.normalized = true
  }

  createGd(){
    for(i in 0..._gd.texcoords.count){
      var uv = _gd.texcoords[i]
      denormalizeUV(uv)
      _image.getPixel(_pixelCoord[0],_pixelCoord[1],_pixel)
      _colors[i] = _pixel
    }

    _gdNew = GeometryData.new({
      AttributeType.Position: _gd.positions,
      AttributeType.Color: _colors
    }, _gd.indices)
  }

  getMesh(transform){
    createGd()
    shadeFlat()
    return Mesh.new(Geometry.new(_gdNew), null, transform)
  }

  shadeFlat(){
    var indices = _gd.indices
    var pixel = [0,0,0,0]
    var black = [0,0,0,255]
    for(i in 0...(indices.count/3)){
      Vec4.zero(pixel)
      var div = 0
      var vi = i*3
      var ai = indices[vi]
      var bi = indices[vi+1]
      var ci = indices[vi+2]
      if(!Vec4.equals(_colors[ai], black)){        
        Vec4.add(pixel,_colors[ai], pixel)
        div = div + 1
      }
      if(!Vec4.equals(_colors[bi], black)){        
        Vec4.add(pixel,_colors[bi], pixel)
        div = div + 1
      }
      if(!Vec4.equals(_colors[ci], black)){        
        Vec4.add(pixel,_colors[ci], pixel)
        div = div + 1
      }
      if(div > 0){
        Vec4.divV(pixel, div, pixel)
        _colors[ai] = pixel
        _colors[bi] = pixel
        _colors[ci] = pixel
      }
    }
  }

  denormalizeUV(uv) {
    _pixelCoord[0] = (_image.width*uv[0]).floor
    _pixelCoord[1] = (uv[1]*_image.height).floor
  }
}import "platform" for Application, Keyboard, Window, Severity, Mouse, Event
import "graphics" for Renderer, Geometry, Mesh, UniformType, Shader, DiffuseMaterial, Colors, Texture, TextureFilters, BufferUsage, GraphicsBuffer, Attribute, VertexIndices
import "geometry" for AttributeType, GeometryData, GeometryWriter
import "math" for Mat4, Vec2, Math, Vec3, Vec4, Noise
import "camera" for PointAtCamera, FlyCamera, OrbitCamera, OrthograficCamera
import "hexaglott" for Hexaglott, HexData
import "memory" for FloatVecAccessor, UShortAccessor, UByteVecAccessor, Buffer, BufferView, DataType, ListUtil, Grid
import "image" for Image
import "helpers" for CameraHelpers
import "2d" for Quad, SpriteBatch, Tileset, Tilemap


class WfcMap{
  construct new(w,h,tiles){
    _grid = Grid.new(w,h)
    _tiles = tiles
  }

  setTile(x,y,tile){
    _grid[x,y] = tile
  }

  getPossible(x,y){
    var ns = _grid.neighbours(x,y)
    return ListUtil.filter(_tiles) {|t|
      return (ns[0] == null ? true : t.connectsTop(ns[0])) && (ns[1] == null ? true : t.connectsRight(ns[1])) && (ns[2] == null ? true : t.connectsBottom(ns[2])) && (ns[3] == null ? true : t.connectsLeft(ns[3])) 
    }
  }
}

class WfcTile {

  ul { _ul }
  u { _u }
  ur { _ur }
  r { _r }
  br { _br }
  b { _b }
  bl { _bl }
  l { _l }

  quad { _quad }
  id { _id }

  construct new(img, quad, id){
    _quad = quad
    _id = id

    _ul = Vec4.zero()
    img.getPixel(quad.a[0],quad.a[1], _ul)

    _u = Vec4.zero()
    img.getPixel(quad.a[0]+1,quad.a[1], _u)
    
    _ur = Vec4.zero()
    img.getPixel(quad.d[0]-1,quad.d[1], _ur)
    
    _r = Vec4.zero()
    img.getPixel(quad.c[0]-1,quad.c[1]-2, _r)

    _br = Vec4.zero()
    img.getPixel(quad.c[0]-1,quad.c[1]-1, _br)
    
    _b = Vec4.zero()
    img.getPixel(quad.c[0]-2,quad.c[1]-1, _b)

    _bl = Vec4.zero()
    img.getPixel(quad.b[0],quad.b[1]-1, _bl)
    
    _l = Vec4.zero()
    img.getPixel(quad.a[0],quad.a[1]+1, _l)
  }

  connectsTop(tile){
    return Vec4.equals(_ul, tile.bl) && Vec4.equals(_u, tile.b) && Vec4.equals(_ur, tile.br)
  }

  connectsBottom(tile){
    return Vec4.equals(_bl, tile.ul) && Vec4.equals(_b, tile.u) && Vec4.equals(_br, tile.ur)
  }

  connectsLeft(tile){
    return Vec4.equals(_ul, tile.ur) && Vec4.equals(_l, tile.r) && Vec4.equals(_bl, tile.br)
  }

  connectsRight(tile){
    return Vec4.equals(_ur, tile.ul) && Vec4.equals(_r, tile.l) && Vec4.equals(_br, tile.bl)
  }
}

class Cursor {

  position { _pos }

  construct new(tilemap, cursorTile){
    _tilemap = tilemap
    _pos = [0,0]
    _cursorTiles = Tilemap.new(tilemap.texture, 1,1,_tilemap.tileWidth,_tilemap.tileHeight)
    _cursorTiles.transform.copy(_tilemap.transform)
    _cursorTiles[0,0] = cursorTile
    setActive(true)
  }  

  setActive(b){
    if(b) _cursorTiles.setColor(0, [255,0,0,200])
    if(!b) _cursorTiles.setColor(0, [255,255,255,200])
  }

  move(x,y){    
    _pos[0] = Math.clamp(0,_tilemap.width-1,_pos[0]+x)
    _pos[1] = Math.clamp(0,_tilemap.height-1,_pos[1]+y)
    _cursorTiles.transform.copy(_tilemap.transform)
    _cursorTiles.transform.translate(3*_pos[0],3*_pos[1],0)
  }

  draw(){
    _cursorTiles.draw()
  }
}

class Wfc {
  construct new(){
    _camera = OrthograficCamera.new()
    _img = Image.fromFile("./assets/tileset.png")
    setupTileset()
    setupTilemap()
    setupCursors()
    setupSpecial()
    _mode = "map"
  }

  setupCursors(){
    Application.on(Event.Keydown){|args|
      if(!args[2]) input(args[1])
    }
    _setCursor = Cursor.new(_tilesetMap, _tileset[6,6]) 
    _mapCursor = Cursor.new(_tilemap, _tileset[6,6])
    _setCursor.setActive(false)
    _cursor = _mapCursor
  }

  setupTileset(){
    _tileset = Tileset.new(_img.width/3, _img.height/3, 3, 3)
    
    _txt = Texture.fromImage(_img, {"mipmaps": false, "magFilter": TextureFilters.Nearest, "minFilter": TextureFilters.Nearest})

    _tilesetMap = Tilemap.new(_txt, 4,8,3,3)
    _tilesetMap.transform.scale(16,16,1)
    _tilesetMap.transform.translate(1280/16-_tilesetMap.pixelWidth,0,0)
  }

  setupSpecial(){
    _wfcMap = WfcMap.new(16,16,[
      WfcTile.new(_img, _tileset[4,6],"1010"), 
      WfcTile.new(_img, _tileset[1,0],"0101"), 
      WfcTile.new(_img, _tileset[2,0],"1001"), 
      WfcTile.new(_img, _tileset[3,0],"1100"), 
      WfcTile.new(_img, _tileset[4,0],"0110"),
      WfcTile.new(_img, _tileset[5,0],"0011"),
      WfcTile.new(_img, _tileset[3,6],"0000")
    ])
    // for(i in 0..._tilemap.count){
    //   _tilemap[i] = Quad.empty
    // }
    updateTileset(_mapCursor.position[0],_mapCursor.position[1])
  }

  updateTileset(x,y){
    _special = _wfcMap.getPossible(x,y)
    for(i in 0..._tilesetMap.count){
      _tilesetMap[i] = i < _special.count ? _special[i].quad : Quad.empty
    }
  }

  setupTilemap(){
    _tilemap = Tilemap.new(_txt, 16,16, 3,3)
    _tilemap.transform.scale(16,16,1)
  }

  switchModes(){
    if(_mode == "map"){
      _mode = "set"
      _setCursor.setActive(true)
      _mapCursor.setActive(false)
      _cursor = _setCursor
    } else {
      _mode = "map"
      _setCursor.setActive(false)
      _mapCursor.setActive(true)
      _cursor = _mapCursor
    }
  }

  draw(){
    _camera.enable()
    //setUniforms()
    _tilesetMap.draw()
    _tilemap.draw()
    _setCursor.draw()
    _mapCursor.draw()
  }

  input(key){
    if(key == "Up") _cursor.move(0,-1) 
    if(key == "Down") _cursor.move(0,1)
    if(key == "Left") _cursor.move(-1,0)
    if(key == "Right") _cursor.move(1,0)
    if(key == "Return") {
      if(_mode == "set"){
        var setPos = _setCursor.position
        var mapPos = _mapCursor.position
        var offset = setPos[1]*_tilesetMap.width+setPos[0]
        if(offset >= _special.count){
          _tilemap[mapPos[0],mapPos[1]] = Quad.empty
          _wfcMap.setTile(mapPos[0],mapPos[1], null)
          Application.dispatchEvent("[wfc]set",[mapPos[0],mapPos[1],null])
        } else {
          Application.dispatchEvent("[wfc]set",[mapPos[0],mapPos[1],_special[offset].id])
          _tilemap[mapPos[0],mapPos[1]] = _special[offset].quad
          _wfcMap.setTile(mapPos[0],mapPos[1], _special[offset])
        }
      }
      switchModes()
    }
    if(_mode == "map"){
      updateTileset(_mapCursor.position[0],_mapCursor.position[1])
    }
    Application.dispatchEvent("[wfc]pos",_mapCursor.position)
  }
}PNG

   IHDR       *WmR   sRGB    gAMA  a   	pHYs    od  IDATx^	,iYv{gYa6aw 1F/A,a@ _pCbQ4&&{9{^gyN[UoWWwPEQEvww'3_aS|Yqc\u^vJl7>/9?vDV7p"~p"OQr`Y{?G_2q++k|=_#s0/~s<~syS@}}?xO=fp>yS|o76eh~/?!}(((2omu/y)(((jvIQQEQEQEQ<*((((((,xs\#7>Z(((23%Hwml8?>7)(((R|?u+^:s_(f^%\"O|o<OoW^l1Q?%7?ZUEQEQEQK)XJl6?M"K^TwwZ~#}ox|O?{]	S-'\W>qF(((0@dtY+_ei9@%i0t~h{;y`V?lGRhw}(((; &89hI)6>t/8gN|j49IFcs40Fbeku _h|kTL*?p
(((ap./Eyl5;4-hBiL'[cC|DR;6~jOK&'ps((((3k80k7-;+riGs]q-AkCtk{_'	0)NOk{/.lk|))((P {]`n\sS#_q?dL-,B(((9!TZ<nh wD|{{k{>5z{1E'&l\2P)(((y>::	5<8{_r7`y0Dp8R\Y.yp?n|(z~L^20T+LNAQEQEQE%&	7o!|+vwti4F.H x4QK.%W%EQEQEQm x>W9|K^[o7sE@9uWD{?*(((bk( V*EQEQEQ5XQEQEQEQ+E+((((((,((((((,(((W)8km)ecwg(lvsoenwIJEH)OsREQev8z^WJ~;S(J2EQ& Se;\ 80j(u`EQe`.l7 f`@fTEj=4+T(s-~]Z(dnj@XS(Jd .2)A[`hEQ nWu`EQe`K'9o_b8!EQj\+uk(Jmoh/XVlPEYHjra@XQE! }?_>??wH)?K)5~OKR*}]cVG9r@tR80(sk+E7q&(6mR(Q/~msfw``0TbS!(J8wb(Z	7/Z}-+vCF+]#Vs!PVEQ*'G(ly	%ow'G(UKZs!O:(2h7%4&^+!E;VIO*>((U1g\n@|uI(b7dt]q}<Cj(":EQE[Vl+,'!EQfMO(	oFf3e3%[4|)>&~M'/77xgsIO(F/P}hoowduG{^u_)[!5j1Bj(RJA+(%I8~`v`bb7dt](R0
VEQn@vjeuhk
0km+dd-QKd+d(3N.<]>`EQ8/+=-jn(pp6exQK,+vCF8t6nhEQ'5>+(7Th4~.~M0,xXVl!5efHEQ7;)>5I9tvEQUWzT_I58b7dt-(J\REQI KOlQI+b3F(J5i=Odw`EQEIf_VB]oz>S~PJKJ~uwpVt~OJX}eOA<":X59+8>5(d$25-fT_ 6t_w^g|nafL!E)Ig:(Mp7"{{Qh4zJub3F]?,+vCF+PTpv9:(XzRe~7 g__P``V/0dt]?,+vCF$'{*x:q+(E~s`IE^EkeF['_"b3F!5jefHaYRCQoW9%XQEQ_&(~]N>vu9bYRfJl!e#U:j:;
VEQb_oLu[R,!f$d]3,+6Cja3Xe(C  A (AL,Iy*K:aYRftCF7i<RCQAOS:(2T.jLBnB[!5efw]~nXIc3F,O"Zu`EQP~0ovTd_ s`Glr@wK^4%FZb7dt 6CvCF5b7dM:('9KFQUb+jh!546Cj	ub7dd {C+(sovKsgS9FQ',+vCF	kt,QA
VEQL4hu)Ye`n
Q',+vCF	!|.SBd_$H`u`EQ%Gf=f`IKu*2EeYR6XVQ]p=YF	SLdt+( ovf`IN^Zg~]J]3t,f,5j!5jefHE`S8(hZf~]PW6Y P+k9f$d]',+vCF	JZnP19tF2:(h7c7/M-h.[oCG`,	)ySJy0jOz}G;I\|"y+/'Cgq}duz#%[kHF":gLv5TpvT(bE}/ .,YL$~,./oYi9mYmn<J=i:(1_fOJOr2kBQ<d\*V[kQL%ykTb+2;dLM2(Pb8ojVJ2:YjY<TeQ\6UCjb7d<qikDgaC+,uHJOr2g~K*sHz0ClY26Jl!kenh%-?jSZQE{~S0oojh@/25\XVlTb!5efHz`YRJlPb:`EQfNDeNXHz`YR!!Q+u	b3F=],+vCF_n?EN+(,rW*uI(b+Rn"W2nR'![!efHz`*2ZY EQYoo+Uu7c~OIO3u9nEH&\4|Hm\9+'|Tp:EQ+Tde62I@jeR{/S5ttIY<YjY9jYmn5[!5j.Qn(M99[mWz2gI\6UT5[!fYFb7dt=0=}{W
VEooFn_N`,-H-+6Cj U3lYRJl!5jenPIDTpEQOUhT5!5jefHQC5b7dt0bwgMYXTpEQf,h7cWzY_L*kYRj,+p[_KQ5b-+6Cj 5b3F0=/TxePVE]rt`[!aSFXVl`iTUcYRXV.bY2:l=EQ7 KOB_*~s#eNEUc*Rj,+6CjCQ5`=9dt]L%6CF/0YZDhs`EQb,\7 NopL`IxR*xAa/Xa$No'q$[+r}G	7s?0.<;%4ZTgLWZQE)T{kjR'~N?5=T)nj3jFZ!5J!5R_!5!5L!9QVE{6+=	*ewi7#+FaTsD9;!Tb7d\YYyu`EQ]'!7 E`uv'taJb*eRRs'C*UefHJ0dQ5!5*b3Ek(2`ttY_ j)hJ0,+B*UeVHJQ),ng24Z<!5*b3((s'!n~]o-lYR:LudbYRZX'nQ,+vCFWenY&KhMGS(uCUZ4RRdH
TM9RXVlFQ)!5QVEQ22s_NRwaSJaYR:,+6CjTefH
`YRR,+6CjYLW:(0_I47#o!)w'%?T[R"j?#|'mdvP!K+_Gj/N}t^Fw*}7<R:'C*Uu'RB5!5J!5j+9QEQ*gq*+=Ioi,G`YR:,+6CjT!5b3FXVlF])!5S2Vj8EQ7 KOo$d[>
T[!*b+RElBjTefTefHJ] YR9:(QaWz~Sp%VkCn"Q!5b3FEXVlT
aY0vRIYPVE)MJOR/P`Xl!JLKeVHQ!5b3b3Fu	w'CFG2s;EQd_`4IJu'Q[!*b3FUXVlFXVlTpj(EQ8h73eVH*`v=
T!5*b3FUXVlFXVlwfbTpjh
(7 f`IBoj2o
V3t`->)rmR|]4}P[]kvK]NoP}bOJ	WeZQ%t_=B/N}tK)Q-~kHt&$,a$*)CNi9p4j,2/P *E Yu`H*pUOrXHW!5*jYmFX9@e"80 92:h,0d(3 ;t?s-`%!K[K*
T!5*b3F%XVlFP,+6CjT{fVEY`IB:/~t_@+q}eT!5b+RXVl	Tp
,+vCFW!5EQj	o
fMHyoJXVlT*O!5b3F%XVlL1llRX!TQ2ZQ"Ro~PU`T,+B*),RXVl`Yc*p}
]!+="BF+C-s$!jJ+5b3FXVl(JcYR|,+6
*IRLU`YR
\BF+%VwA_%yaRnDFOJ/XR1i{^N,z7|*nO5(Shz(5'76@
eR/{sr`hA$Jr\C=jh,7;2LKg@:V]4TKE5)_#4rLc1z(Jn,DWW)o|jpy3h45X8pqj2ww?7kUC5!F%9u
	NvVC&EI~B5TTh&j%pG(3jJ^j0 R!G<M OEXQF3q"\*jp4FJ.\!OESQCV)_29013sBy"*4YOnM	dE-o@jJ(, R\@BjKwc9,F~sR\W'Bj.!eI N;_/C! xrHxh6D4\Kf+4Fsh9
]QJ de5k0(\Tkhp49Y9jr42dcE`XWrQ%_9RpFo{TcD9M Gzt_+2>8,R4.v``X',BX!5:Q"|a`Hr'CFVH pt*SQV%=[!2SqQ"!5b7dtVrQ"OPH&tK5o:x +qPV(,+B*HScmMb3FXVl(%dHr].9X!%-Y7 KO<~unp^5)fss+'Et]Ag|V89V!IaKueHS:R/{$U_ 2Jj\"+/TQK8<i*r 1d0nJ_  *sjp,T` ]*A*Gr 1dcLUe~QjBx*d5Iu 1d9o~F58jR hpSC$jOz\4c@
VU
E58j7un ,D'QCDYqB5XPVfZD/Gid5Ijb__dTc,+ySqezll	d6;g~biLV3Y0T+d5xx*DBjS'VUnIQQ\rxX
Q
vRqXH_]4a!5J3,FY}^`R,`8/ Cc !1 rH~9_Q*E5XQEb3F)XVl(`YR,+6Cj=V]Y!{RR|IPUBQVETa*dH
T<!5Jb3F)XVl('CjefHRp}
=Z/+=PU`EQfrZD1Aj*R,+6CjeVHQ
!5J'+dtYXV.&CjZ	2@WY'zJs
p0	K0p%ab]5RW.
vZ~u"e/4$^&lW.z\	%hp=/UNs
3/ZI!ud5d5dfA8EVUB(l"\)RI03!
mVRxMu`HZV!5jYm(e2idRpTO(HrHRmi'[>h,=2h6DnM
akfXun]4e:jzCfC2fd5!gsH-QB7iPUm].D5|E:p^!3*2S!D
p-;j\.D5|jpSN"=H)!j$#Rn\oR
F5\Tkjp
L8T*d5dCt>e)Ur.z\iE~e&Kd)R6)ZDMuR`#B*	|!
@R# -Qs!/R``BjDf:~9? 8;0/ 8rH5.TRKRFPQyyjyN%Z+oe	dB[/4, VeasQq`H"1!T*+olM fHfHfHUss)t_eQVEIlaC!b3FJl(0B*9XVl(cYR$_ 7 `_EI6.o~bWJ~}}M^I^8"SQQg]H@/(^FWQLQ(\Cq`H"1VH"q3!lYm(+ol(+ol(+il(Z5~
	
VfS'C*eVH"Q$!5b3FXV.iaM*D*l(JI"Vhsh%)[!5b3FJl(EbYRH,+6CjefH o3_E)`EQ+8>eVH
TOT*EbYRH,+6Cje2.65,=PU(JvVKPZL%T!5Tb+FaXVlT*EbYR#WNqpz`X ]WzQ`EQR#`5aEQjE-k
N**R%RsL%BjeVH0
Q$!5
b3FXVlHiSIgIXzQOBF+(LXeXQHzbp"
v}eDT~Ce
T!5
b+RaXVl(EbY2JN!g7 lSqoVGt70+nv,WD^7>En/^+
.9d5=
Q'W_&L|Jg+C}5'(Jju`P8cRdHbp3!5
!5
!5
a!(($MdH03VHE#EOs%aYRL%T!5
b3Fu$_ \zlZ!b7d {uI(2zbp"O*XXL%T[!Tb+F1XVlT*~Sp !b3FaXVV(%SY(p_/,OT*`YR0,+6CjefHT$M2bQ!b3TUEKI)YQTb+F1XVlT* S'C*efHb1A:a+dtaXVl(aY2ZQb3j>-gm(q
T!5Tb+F1XVl(!xQ!b7dtaXVV(ES$$(`*dH
T OT*rxi~2`YR,+6CjefHb(i$hR+SfOrWe[p+J(W(T#~%oNG^JDtOUZ+sw2iaEQ`Snx2FIJ`& V7/RR RR2ZQQ4p|VV%}b6VETJ`YR L%6!lET,+6CjenbQ!b7d`'2aaEQOXXQ S'C*eVH-2
+'^`YR ,+6CjenbQ !5y$Y@ZQZXQ`YR#l1T)W'p+@l!5
b3FXVl( `Y2,+vCF+L(ATp|ku`EKL%&~*?G{;XVl( `YR ,+6Cjenb"6VeNC*8>[cb:R#H'< Ao,+B*efHQ !b3FXVVD`dXJ(IH":>uH'+oot{IB\vCFefHQ !5b3FXV. J}/~bWJ~}Aun^?g:18W~D`EQD9eb/0> .Ke	|_-TS/pZPEEQf[DW
u`EQHr7QWz"o!X;R#oR#oR#oR 2 2 2ZL\]7KMXQ":>S7VVE7 KO$I7 _hefH7!5b3FXVlycYRCjf'~FMXQ<G:(SD?[b+RXVlycYR#o,+6Cjen8epLcVaEQL"XQdb1+[!rb3FXVlSycYR#o,+vCF/QE[-|K`EY(~0of#/PZB*efH+!5b7dtdycYRc&(LSM+PD~ ]Z`H
+!5rb3FXVlKycYR#o,+vCF_io-dQPga7LbID5XXQ@T_ 7X#p@rZGS=JSw{*VO%de-N]e_~#zkmI"lxNAL	*`u`E{fBoTjiz)j9qj\/&O0)3
TNRFoL9N#!&bi0cS#4XJ1PU</3
VV%&+l\gLIVC8ww@#(M@Wip|rf)o]a*XXQ+l\OsC-wdXR4Ms4avk!KeyKLOFaNaEFLaVj\Pay2:s_3m1WICvw*>~Se9i7|y<;R"6.{{
sAV0{*Sj\Po(sCUyj<5rRrRrH(7}T09f|QZD??{(Nj3JrFN4DR{h>2{E_48~Nc\.X
|W&(~OiPi"KC.M5uR$7}wj0?Rd4nv4ad:_EkpjpT"Tp2+U:W7wO0[	R{E>a?j I<Iv$s^YY5XJ[D9:"Uyg:i,!g!<_;8;Pfvw'8XuT"`u`EW*Ii!0@`wz%\E;n620aN~5Y9|u10gBOm<Yj
UUQ$!R$IB4?~Wd2S68S$X_tX*KJ~jju[)Y<xh*XQ0UU*GcCZx=&xnWoH)xT`37 GgRyg$srtMSd3^QM[+l$e$yW}bw`~)*+ql9m68LmR/Yh&F0zaVR+R(jjJAS[k52`]Byp|?Cfs?-%Ljp|_aY7}G>1U`$[Me)_~%M#`9f0|-K)?kHV$slav^Ye\+0elR[m*XXQj~ECIc|E4xpJ3D,f	lQ\l
Dsj"s\TpR+r#j17<<22k0t0P[|bQ`Gd#.avls~1f]a
VV# -h 3F-O~_~wPWZDWox'tsZ'RA7Zn[^'L?_RaB/EJ!;1_?))EvbxnA,I)_e1!?XS68ow!! S~/xBCC!> ~E}x||BR/nF{?rC9"58,:1b{Mw?A31M8Wh.[D?>g3i)[<A	s^LW0C"OK'~8`K!)%b?[ZiMFLgT{a><59"L6Y1S/+F34 PVa~c
~XWQ z0
x!}e~M=St|w	nmc8mmMIWF^"=s{]sRNXjmb6oj$9\r*XXQ*g_m(U[8{q:J)s8W[gV%&L^y6/pC7	'OgRGK&&~]LU0%eA(8;V*<qt )_-S8Gh0P~Z8Zd8>QG6>9s?&:b}BGCv9/.9:O^qj2QzMW_(NTzo|25_L2-K*70&/v^:&AJ~3@o$oR<D\(Za
VV2a7/:2VU2
k{FS3y[$YY[Ou48q>Igfm<sv58,H?G9yc^+T:K>WWQjE)zo|6dd8	fp&Mk$s:_	'EZjm/[+l6Nug.Y`u`E38(36uD!L2Bje%kp"8s,tYWkeM<U0R9UUybS56d[oc3i&	Ggcu8g53c3fyf&e9sN:s4`EQzo4oL|5;}2<LU2\JAIMnqR/f\|igK+ G(1U}{dr}D-/|i03Us7&r^X	O33ye8R3\a9N3J)\48-+JLr`_EQPot@c p%5&FaJ`aYhj/atMJ90G#-TV_m(5u&PIiQo)cH)S-dK|g>*%?IQbQg<33U8lJ
Lej2s9RZys!Tp!LsCScT)zSJ
Gi?*JM(-[)Q/Q3]W2\tZ8J	Dh0to=63D30+N}5~VU3!II$s%s8X}))af,M.'
$*J

p4uV$2<L92<i2>M
n@mM8M__+j<Oa
f8gVaVf((uo9li0&Lmqj%4W7}-ZS2+lyr:%G_p;OIOh
9WWQrzNvF:PsSL`&TEkj_
r8<5]<UA	l>1KJf0+ySN$~%>Sq~ySWPh7HGh00y=I,Jj^hM-zJ 1ydz_Z;'B4'B
28C	~4jYwn$X2CZ/hrxIg?kuBUTY#4,b:
R j2R}`KMf*a 64	3NvJuff*8__ELx/_`k0`U6t'~fj(j38)3d&T1__E)i;h02L5iaz&@LX5QuTKp/^N3*!aVe~eh;7j0#?CR
l]f2p&:PufDyyXWQEQ'S4]re3=-jVfTg9HOuV|x**@9Z (Ji`&HDp	&4EkpufM20g_E*O*HLF/BH33M[Dgo-~8Eh;`$sFajR4[[S48o~l2c>;=87m%u~XJDW@:2] Un5z*8kp"f(\3 K)~IfSY6(ySg^%7` YS-fe8S-jJjud~55o]Cf%\39#%"R3P02WR	|>WWJzf,65a` 3pUW3,3j5o(|{+CkR
"i0PfU5jp|*jC'E9G8Pa.zpe;S~#YuIW5jpL
m]m*Xrr3Wd7?,IJS=x)i`.$b@p\Jjuk*xH530+KmKS'I0+uoRU
%%324k0SpUW3$g8VTTTSTs?OBQaVf,)}zR`aK,2l@	Yd8	W5jpL
V^@s 2<$)8femSg^LRJK`iz}_q>Nma)CUb2`u`%# x5_O9NHJYYR"P32te8<X+VfTgYL+u#_m.hIfYgV_^*DENw !	3jLR8~\}XJ[R<dRJML2wJk#DA2UCXQjN
gD9pB5mJ)wNJPUsgWWBE'2L0}'K\	1eX5Q9jFe@ G|3,30((!~BNq/Dia`F5xH5L+sLA\ ER_$X7"6H)3i3e0j0<sDhpAJC+K ~\sA'*AbB
(ANmVg3+3Goz ]?D{AI9{UU7WipXlt+O.{z8n:;yeKRWRm~[DkshEJrNp5,\Jh0?R;p_=oaS"d8:6WXJh]o759j:s"Gz#xk(Qtvi$31eKJAD5x1ISgVt3'A7-tzA3ijtqqz2DHo{j%o?|B>y*f68im=hz7R_h]T:Rsj-~8yis==)X$sRbxQt
?R2`u|@j}JJ~sqgt%Pr"RRvsia<s45tD(I$b:?F`|].%?|TJi7~?H)!d,YhWUK ES'TzNS/*[1%qz2gK&5@T}[&l	)M=eHEi) !?3}D9H%,;K
z(E6Vk~+nk9&/~VoKiD*+R#iWHi*Y/_J)!'csR1rYB.?uh\KqyeS8Rv,>
{ERJN$s 3O%N230+n@FD4?}Wd q%}\	awE4'swH=EgNBOTXR\N,igLVVYO}w^5xp1+O&G30+[7&S4V.fL[jzj0k2Dk&Sg@TXL\Q=w:s5`u`evwE58)<;&YnfBfx)\S;I	>j03U'54PGW`S~8v,4"=.*20
`E)[R3[t\QaqZ9
b2OH5=?n)y.	,&&W|&`N[4h0ZHJvq:63;%b*tKYr:t4XXYUMjp(ONrM~W 8s*&a[D[qvfd)|wD5	I%Xn~rID*u	)MzN^AE:E>T:2C9jp%9w#RN/iY7@T}@	sVv}aSkpF,:iv:\$aIW?vs*XX)6~V5Q-ezoU%kp5$?Yd?M-"-\~rIGOq#A48E*XX]*OyE5|7]P-{7M>Vg>\0Fh]qW{2lueMxv58#1-:,;D9&b|CzK Xn~jp	ywvO
5030OBT_6T}Lj0SV[Qc<Cw4rmu2t[.Zj-h0Go<kPh4`J
^XI>xd(EITk\9|S4u.{3]kd.T&t8KlZMC)[m@K `za4`5g)8k;`^$+rD<`aOZ\pI,Lip'P<)-rkHU	EgW5"H&
<O3kmBW]<EW|2F
K<* (S$?\:<K7+I2IYCdCKB$gx[5#B2~~vD~w?	w7:mNz?sPe!v4[^?q y '~JJwJ48#u
B2~^KZ4~^j$hpoR
$=w75i]PF`n<\8O5ncnaza*8IO<();R@R?Kd7]}a\ip k0LIgr?[ay5dsa~0&^^i.&k0cYTgL7s_s	)e>:?PFW7WT')HhVIwn7;uH5wf8df:F%^@vri6`,/'PCi]2Q0)!:p`{%Jjp(?KR:x @U33T_vKj:7IIP`&~`/d0B^WY?g!L8G~?ZJ{RCOJ)	g-z>ZI*Iwrnj$yipM{x\Hc[_b7vd<SpDq wnE.57M|t.O	x~`Ffx3WV&r35WdZGkC}G~)2LY~G0W9GlFK81I&+4Us!/JhSR$9S|{	:l<:cegQmtQq2WjV;4Fj8i;?82Ifx276@TC1O8Low|7~_j@}!4{/t!(P."BG^{^jJ#'!`8FNc+_TIR>rj
s6UE~A5xD\aS|w4AJ`?z.r kG"wy0tLrF~1(<]*@h0j-G+.G58zj0G1t(z}6j00ih01OTA\@O2 lS58Vq`a{=.(q^NTdTh Ez[YWE<T.<^%S"*}uqSAtcj2pNN3Es| p(K4I5xn:q(N&L]bpG:	S.a^#qZ?'eO-p2ApX@;7&%( ;ntPa</m,-tu6(-Au`D:ZC|Q|!Fx+<Zve>hEWmV+&^ RRe);]To WyMDB?:~Q$Z;D+87tl~!x2SWtHx7vw4t[,cd8|q12?H/mGw(-\Q1B;w-Z%;c).xpcx_0Pb5iQ M06:|6[Zj ch kG}V8+vq];WG-~9=( cXb;jz"/,plBrKVvt]J`%E&4X}[dM_wg~9RfFXze*%.?5(ul<I7.]ms<x/gl#l@ Vm|W&=/[&>*V+b/ui7=%YRhMd)CZEg )K)=qQ!>2:<iw(6eZS)yj>wE^` j0e?pmV2`. ]pEw6Ce\#qExlnE<6`qQD'5 9n_Fpm2Ztk] 7k0t<;0|/x*N~*CFV|>nY2vvA`"oG]+S
t8 8](73}J9qmm[	Mt{;
 `u
|yGpp&C*e^3BeK&0P@wDeMw,w,DD$i!j$?ucezqJ8Z;H^[tP;TuMn *J FZXeC~Adysz_A~V.e:i:Xxyx2Op;FtlUrj58lfI58Hfgol8\&z\JQV5&m 6?c4][bu8~mP^Sg`spI($$&^{E4F2ftK$1<nT0K5.DqK/tEH"54>,[M(Kq[lU|eRe;eU^/Auh:ne ]n4m!{zf%p
0{4	-=\G=l\`qa_^	wIH*H-h|\8u	S!4
3<yO!+^E>+7)@G<sG:,\y)x/.e~]:q Q p 6EN1ib@f\jXe}1BCuxL5L`J\kH>ctzX7*&UipI\p|nm+Ak2Ya/dj8j02@T%t 2^`C2U_,&)K nvKCSX*Y4Ic^r3dpWLG''s`ih6Ii i%f9zmrQE2|lnp,x4})@M.w #pvi,o>g@AT(nOxl0F3C@YLR}i;35@oA<Iq|,;/8`WXq./q~y*2pZ,6]9@c$;`[S8cXu,y@8<Ww/-)M@RfDx,b4a0e]T0{+p]fM5x^-1/%aX^`Xq?9h05'"4Yor&/5rGNxiF\8
_Dc~evHe`8D6nr(jq3<V~5sL{L{RG/x/xSpwq`gX %7lQe*`I4'82+c7*:/{wHC)p_j$iuM"kv*E=X\2taeUX*p7ta1y,xFve3 H\V8 QqItj#oq^P8eYn54fTUH#},Gu&#Z
g5nqID*j'{j.b& %~QDVxK(tckDqgs{cHbH_r`Xai0PpW[)8q,Fs;7VX5mHxt@:PX*S}Hb)sBT3l`.~,}+WPf	"4O?qLF.Fe#j@v)[BIU2i%'i"k3Rz,I1	vyI#\h{zqWpC
 1\~x	^2^.+i4U>puG@3.9.Qnc/{Wp.@g8J
R
e^mv}it\0/1;ej

tn"+YZ280\s}fR)%dw&j|+8t,Z   w$SA 9QQ.yK`[  e<+C:Py	;eXtaeC.)V+XHpA8xh;wao{p%?;p8G'F8vPgpgR0;m.LkC<k@v1fK6=wq0l$Y;v+o\y#+\|t{di	^zvAh#K0@40cV?@ae}t`8oovOvO>spw3-]gOlU aV`n`Ne|{>Oe.FkoZS?C93+Fo QM'xS^eRg?uv&ok<t#o	!~3vi
oEm,I)nyk6;K%
aDM#Gp>z!vq8BM8lmFvF6r\^o,wV+VVVKX0EuM!:!	12i/f[b,9-{uT
{!Kbs=6'&a)cf)s^l_v)MlG?a.|mR2XZm:iah]<UX~9PVU8".:5vo6=wHI%@:,Z
h5'jyX
~cKdH'Zb>:Oe
nSn65tr/F[ k!i]3hn%-gY
t/*XK2.C$~`{t cr
X&R5.:9CwkqkO(G7y{<AtFP !^x3^X*a/3
2@gh[dD&44JCPF,&P/`@++.]5/$[RI4|" C$2K5&)?dx-RFZ+f; ^=/lyu]
@:plX@% ;4?nPgw7|^WKI%KGsCXJj
pZ
uQ|Ocq0lOZn41G_L6`p:T	8s1!Qp{xeXWlvf,KyX G!k`8BF#i1>Gh|n{gPYt7%e,taa,=;  oq]vsHk^&%XX_@c^_.AC:(?-%*;8NYv/H,t3Vw[cX&k``loLo
[N"z)}Y~og087E`gx
*%N.93i68)I X<{%N6;FS8j(q? '{2~/k_c|w$;^Zm,5WWKk+XY^YZ/P_x.lrNl]N.8(c?:T*}qlp ,uSW{d` 3	j00q2p UCxEuWZ;'ThxlX`^[8z[	1P)A
br.FL@7.zPq`I9fp:#n~iQd:0/(,x&J/]KlB~o]O}GP|"z')gx&H&xn0
0,0'6sU<PE_ZX_xmtGno<$vv1g2Cl5,]ZFy,HaE\cBQh0RE/oRr7`wvl<asiE{{`'@-B7E,mCBwP'%3v$nAu(W_;~qh;j4<C[Rp]jc[G~Kvg:+jsy]wX^Y_bjvjF]\i/~#,)!C3dGVo8yN;3{[{VR5/!n5vmF{hy2<bD-h3XB62:@5.%/dEOtP/JmG1p'M`x!:,,c+;xxO?J5>{Q8Y\s`W?	C	Xta!P`/;/oqkbwFx/"K K1Wl+05XV484|ZZ_&s[u7})M'Kcg0)rMZdRUv$vy
'@_BS<ph<Ec!#t1F&|hp?8Cv;uG&I|@[x[9B%x!Es_xm0J]Pwcee]YPH+<am678$x\+_vK5Ek]QC{'wW`sjw%@lvwN~^45t/hai]<9~[@<ayo;<k/;0.5$p)$XPk^ Oe:nar	$0^wP//pG1|Gct*;,9\h/RH|R7:h[`ikW~1 a`u^/1aa;5iv:Kl2_VXh.,~EXtgur;b,]')mZ478k%le+E{{\4PNJgg(nx Yz6^\!%~7G6`x++K!0Rg	3ygC^JbEjXK?)6\z,/pKd<uzwyj	tqV6x$D[,\A	xe-lFa<xTouSSw>GC>OBw}{
{f6i;AP>ID6.>bw;H\&	8<j$6, |b0]p@6NWRy#^{QU.mvO>eAK#(:BR1+joDE-<yA'=DX>pSLk.Z@k|~me|RI)8;R~r>^;(a{]Bn{oBw^^"+)!	evUV^<tt
A1pIAZUD[DS
w4-gqhMgQ8Y(DV9\o"h0fkaSU `g<.c0a_&(pD8[18.<|<IC/JJqmy-/mYPw*R&`5a2<.</a C1t]IB4Xsc<=?4b^ 
.0P0F\-F#t]p`|2O(|pI]6R\fh3(Y~aYsR-\Ja)Pj}$E&.,Z4@_x2p^i#9\0:~cie	B)_|yK)9Om1E=/*=a/drc<*%a-/6bm.tif6u6=84/'.n~q>S4I,Ggzq8< jpkhECLa9aZ6.p[	6),1M{Vk.iqheesuM]+WPh"zm3jwxm?O?	:oy9ekzcVp0~5S\%dPpYatta+[!1ED{08;Sva:}|+5h$=&8!:~r.M^K#'\=/A]P0Xi?7
.-c CvNz_&|-xC]a^Wr#gWNZcgi
h4j,{x%qglYU.4E25X5]0M:_qt p:W|bXHZk \h7}~WiX1Q43h'9lqm	Gz[p p*2l]pG+E=/Wm\[{9-:tKsf</]^_B09;&pf>etkD0=`g2`TwBEFd2O%Oz|&yndAq\I|p]X	ZS:\zlF`[^tW;K]iS6)-`L(6XWT&:D2t8`;~&8tITj_qc0g:bs,R7;m2T).7z]fs
d?Wxhb$F/
T<bHeLxe:;0Azqho+#y`/AiAp
1xE>+W=0)*`?OS]ApGZ`Q0|:%T&ZK?PXL{dlw[-6_mKN=~i>@V%NS=Qm'%K6D+
O^.hV3fe4p8O?=fAwT^JS0fpv~]vPhpO6T4U:Bir^v Rl4\SE`5@.a7YiwWK2Gv`a!
.+urU _4mK?
@AN/whQFm4N=Kv!pOZCp	a+@Q"^aBuS<a:ejSm<l "l9;>L.E(L;^`*e.bOX y	JpsySIirHbx2X*Ne>Wm^ajxHBFoyORomxFzpz?q)eH
	W6~v#^Y~^ a\txH
U5^wXSh65Q)+?'5^g#O
C5T}I p3y!6sLcw|{xpI&FR}J5|ho7m@031	P(eGT2uuiB{*W..SgppXkK@;154}PG%o3up&LrS*xO }buwrKpB|`8&/! ?|Pf[/ w!2 :cqY%GgQl880e~q}?C_|v*E<I|zG58np t	.x]g>^WJ+^(t?zck4?,`z14h:1|)iI:\vqL^%dKi6ox:)qn{aM|aG2@%s ?bBaQwP.`3M7xe	w:Nd57vs(?heT6 1.2li x;.Gk=~2zRmt>&B=u}>FH5v?.oWu)be(A|29 n^0 g8rn&xJ'974i8v}>doRfYnr%~W6*=WRl6 rB}^~p	?tpKujZh	bxI}q:4A\hm~A5x
5x7T]d F.iGn}CP,;|:3n
T+[X5Ls%84]y-h(v8uc *`P}CA>E~[.1y]P	:8-$y6yc\Yjp9|~a\q!|-NwWt`
hJQ~PdR
p B;^]
N]fwGH/'EuC;jM
2^BsHO10xuB.o?GgOp^u6\}-7e*$[{2]Gepdp)G' ;/` .mR]vBe\p}YA]*\x|Jg8Jj$jC*k =6z.?eWTCuK?m0Xo5^l	~A\X:'\S/yp: L
'(F6YmMWi&Qzz`M4W^E<?_H:+S|83-n	jp9kr1k0a^4D[?pIg\/O~$48Wh_Q'z@]Q{C`,<vv_zi,]$;eP<w0R)5l./G~K8W9vpO)0XnS}-txexw5u4x~^Y[pO|4X4(~NrPNs3x<0|SPE\y__,|)Ser<h,]~I`J.1PsjM<8+)Voo]QT%zpo Rz;{7^?^F3Cmc8b}	Mp.x+'1^!:6r6]XtzOx^.>3~0QLK/n=N"*A.l-1-\8h{D+k:"D754LvlYaqoG@}{N`d#(y:u<m6BU.f 3wd)vW+jxw<d	P}|3i,P98"Gd|]|t@ozh{hxJ?:RGfMPn:uZ929cP{auR\x1!Ahxh8j/[K
<B?|*I_~qk*j$jpP%=p wSMT2s:Cpu%@wPo;|LwV G<Xemf_fbjarGK&^gR4\=:8I`*x3T:1m||,C5T}JfS/Hmz+{/}8	,]DGjp3	'@}0a`Js`ZFyv$K&K;vb^4.	6u)]Nb;Tv8z1M/*ciHXd+PIt(#jR{|kC+5y r\GnEe yg:8}z>o'3,]l|K@{zLab1~t+j@K7axu>8a
8;X7})K3*<I58#Px$.Sqb!o=	mpk1:4 K-^zE.,,;g|y7QA`Eo\>^#@~x_PanY:^93&01]7rP1~gem_9U>?4xPiJ	VTY_'/X!`8H!9`X0Erhp.]-N""t^*[m %gw^Mn
H+;:Cps
tN3IjMn6wB|Bt@[OytEeBi$u0~2:|2(;<PWq0g30Z8]^hw_ri~aaA~6d(P6|;|JH)3CTDf|\JItr-o,ljh;v>EhR@8ta_A{KTAI s|h7d43/XWf5d|vC5hQp5h[O~?>/Et9ctI[Gw(9l<-?fG^JsRX}Qq!Y |//v5.&CK1*k	-6FQt`**X5[%:\v(fS:<Iy5K<q/#-u>4;gnZ|;.5a223y5&
WRM/_p8;(NE#c8 +D.+jMVeg0;0{pkKW&M`s%TjpdCf
mn[iqw^@*@p"gIF".}wF{5Wd?0c^qTT6&>5D:k0SqH{5`M/pKi7:JnZt\>74 0v^h'k&1<DW%l.`BoO	^t
4V1IF;[&0PYEzv{wW &v|1[Gt>U"8>Yz9z+99q]z7^E	jD(`t^wzkx/]
W4s8<-TFg<5'E?.Fa]8DMv]s:Jj0nxk]n *S.lp*Ia&N'awF)|D|h%Q8j0a:k0<&|{g;qk4&Uy\	zk0O0uY)UP}&?4h079)vgw	v4|FM
d)pI'5>
+bN?EzB"JEN;,;u8pi)@kc^zinT.6"@e]\h/1{h0,Qd2/~.(#E~5FQIjpdY`wnXg-O04C03] gc@58q&5k_z~^{#P&n|PZal4kh] @4X
8`hV_IJshKgNElE{i<!q*/*OQb~@iF:^:t0~8n)cvNA3<G4|/a\
S|28x/6?	Rwz!@~oy(nQ!0=y*kxC@F3fy^OfRwiBEK>`>oT+wH_=t<Ss	/Fj(De4>wwXq+hp1nn|$-~92+:[v`zf-.79nRcOPqha,x%_yh/g.%|H(C-"KC[px@\q1U(KpxavZ~yU>N;iRM%5d^@W`kq|	2Sw@*1<3W
n	&`/F%*pG^f+QRvz+ftI^wD;prd<}8Zy9BV${Rhmk%b48l:oDm|5xN
G<KqexAoDp9zs~92+o}<Dy0X2^t5p`*(TNc#zR:y<c}HK,<KSx9	XA+Kyroq]T_PyD_7`A`bS\Rp\p8*\e+)7PdXR`I3	: 3 A
8Gam55	lGM[y!^C7$PG
N~wh@bD\ic=9?lW!p4=iya)#,R}OqoEyodjp$d[
]7gvMLs`13GW4^E4hF*#l9n4Gq`
\]qR Kxd(d%Cp#
nDpR{./60#xe*cZHW`I^
p|*8LTZlhA#/,0x$E$u)4$<\fvspu 23	}ff6;ku	|3^FI]G2p)D8^0~>|C>6n]jpQ%YZAE+/x	bU	aI|Ih)		8{t9UT
sHwB"^CH)wi0v@?C[ 7#vV5Q"x{ol0\F0
xxfcC0l0)-~(nc 'A3	.wL15TcRsGZ`d`GmBC_Zg3@siZh<bpq

BBNEesC;e|_\X!Ci\G2g_.ui2p	,cvK^frxw RU]%'3jj2Yv*jF^M7ge3K'F/~HV-dCO:G;m-Sqx "l&{`dN/R6{>{`8D#5x?|5QaO0zVXt4Q_@FX$,]x '@o-)Pkre'{&TFR&(Jx4LYqQ{z@,}``|	,xLKeYDY`p.-ETV,93ty!Kex%T]4(_ [&SVPE]"R1&^g yMy(S.)N.I/*.#0^`>7	'W:~Ow~~Vm<|Fc(,ZIEq&`3{Fy3I{=Vx_CxoC"LJC^8`.].0k0e.\.0pn7%pE:+7R	 eS:0d8@K=[lx,#^Lr?}NB].=|9c:<Y/.pS@w>_u>~GNac+xr>- xL5H#Oe:-Jy!EQ-.u^Ez".'?%m$JG:Rj46/ elQ?9zjTMigXhR$_BF HGrN. Pq
*0.q9	Y1=t]`:Qs
B[F&|"^/X	^0I/-ln}8e;Q_L%E*bKX^J>L*'}SQy^K_"kcUjK	>64whv /l>0ZT|4Z4,)Kr=b	;YhU
_RR1|EGa29RQs!P`v	hpK^B:HT)aYqkN+Cu~wp}Eh89!pFPECR+|{]p\^7	 w~;G5L|CKu)]a +%9~#p/,X9AWGrB8^1!WD/S_Z<AOs!dCMkBW.aeA6!LD/|g
jp,7(TKK`?!h,	jB7/[L<@ -#+xD@cp`<=nGkz)NM]Z([ <pSJMb;p%&B_V@?Owxh0/5^(l*,HRY).}n&Lf2^6K6|UoG?}R,?z*$137u/Z$89^(,K]OK8bDslj0=B>9_ji0taoWf48B7jC[:MKgcLB<
{QRerQ0_W;r].P(6=]Jc
ml==gG&]q5V,|>Hg9;-we`aAMaxiy>M>%q=;2OjpRhfO&fK6)Vf 	f.z9<4d4RtL+03920*E`H`<yjpvT7CJCw81/lCCe>l$c `<EcQ?qAxfa^_t(g!i0N)Wd^^
)4~ }^p8R9bZ:3b2_()_# =Gs)W|~@6j`'x7WcB&Nj8YkOe4C5\&r/6`EJoT$Q!+oGu/^oNk
@mT:F5FC8C1V^2=#xV]
G.	FM''C/&w(&IMyC,M@zeh7.Iksi7pRxX^\U)ogh@^X0S] !/aaW2@jj3;,Q}mY=2jTTA5_-vnN8:/jK~n2tqJ2hUL^F+7ouLF">_urR)<`c?+Q-\.<xwTtkAW.r#i`T{-w^.cb/2r.k{S52q\~4	]+)KS@A;CvR-cAG X_fG$BOW>g\h7.i^^
 9w>Fg2]{X*W?UmC/|s``&e)j5G@DN}!"NJ?BR0qr'uCt!g6g#I:\@ah<	6}8O#:CxakOZ.=PJ'LS!S9y4&J<O1e1^Gw!q5P.a2]cK
/	bT!rNO2[q!.w-_z&YTipqlip2~7{D4[TK;}/1Q9s[.yt`g3L"Ezl,pcS^,8:!3mhh4cA?AexGD\kp[S(.U1.#y>4\z@
}|F6xB(<9OGuJ"xLOR[Z`` 48+P=QukpG7>VQjC-;\6UG} {X}Q??lTp~wA=mu_>~gxlC]
LN}:LNqxewJnPc6?3vxS6NW"Y24?gnjCQ-j
\>vjE~cDhp"`+EQqP1Qvx8W~PL+G# #O-a4bF!H/0nK}Q5X(laX z)xek!W"=Sypt2
ul0bS|0<^i"!X+T')T=G&sqH{'E5z;1Q1,)i;<;.cy[~	Yz;/Q/k=u9jF9gl|ggz!Kny${^{C1u/y/>{QRBJz<Lk0F54JQA5G5zu/;z_.VR	`g_b)o,s'U_`G}3 wT_xuf,l4UcSL/&Vj){ ^<6'4(^q:^eygY: (L &R
B58)jpiptnN=VZvwor9r(5dT}C/(jp.,OO7	6ny}S`Lm0^n	pFmLM30J9njh_z|6lN#^2CR28,9f/<Ry %2`
~u]QOPo-&fcTL5xK[lyM'1g?&\)\f4gG5!yqc8X4n:o8ta/xSq})OyK\$ *J@a?(bBz#?X?T!* ^/$&(ORIQT0ueDc*n"Z)0S.FsyiE{u/;|`#)H_4AO;<{w3fi=|_}7oyG7{22sttdtZKpz]u4xyqn1n}7C4:RJF_LUe^'WR=~
N*\fGwCGFmN58)|q,`~T&4`3	*g'Wu"j3ClGtK`on7[<`)M25#m@H;>:Rds'J{^o{/F^l3O|b158xuw?p+|o?{QGii\.!}4gSf=Ynmm`@58akE5xJ"7@g0w^tTnog"k=8W&<2s.-;jzWwtK5#^D'4SF-{o=u0,k76A
1g~hp3(3==90XQ7a7'Gmq;nX	l[=|lu1V7VZks!hNF~|E	(wjHUE	B5JG 
	80p@[(9q-3dRW_F&z,uL8t2h9'|*t(*(^JX(VHyg>wPs2dR<(F.g<40EF4n,o45m(:mF-xZ/ul7/
1mH5{ph@>qe+{^}[/^ ;S/AOEWSj676H/f>U_(`1x1C.[z:vJmoA^z,F>%${|z~WJXp,,MXJw@3Q#w\<r@3ohjX=-E_{Uo (zuJH Q<VH56;dPm.(Z'8?QE+&|G2H	%Jmd4<%_8q3!q3'O<uidkkN U%@ 5C*-g{qBjk\7dh5q%%Yb8xM~uS<sT2[kbsw}\B	0(\rS0u9_ e1Tc,Txj,yY ]r%=h2W\~caGvSX*g>I!Z`V6;?D(J9Vr`7F<AN{g*J4>
)Rd~=\V4|V|Uh9vRR2H_#Tn3nKdg>=3s0NG5.2SR'WN9t_z
%t.k<nl,5sGyeY!wc_	Rt_1_6e|D0.ODt[7!w}yq$TKd7[y7}^	_zvgY	$W7KdrxfN|:|#b 7rTsw&`]s)`n.rp&~^\(s)%ke%qJ-G|3^v%IiO Y".G0?Z}KEn'7>Y5Kd]qaV9=ICOa^e8IxgsYJQM	K\9RV`/r'vr@^2_H/	`&
yZ6Tg0=+!@OfJ 0;x Q7tnF	G??
7<K]}9#4[!(J|
Z+	eSCV.0~A4&YwNrAzl<#5#3 dB3!EQGMW_Bj\&l&l0C1<CA2w`H%%#v+x@?XFl=<xhv{!3eVW -(G7;<a<vjDV\s,>{V{+l\xj5Mb~e&iw{gk~$sv_xDJ,;8:veRCz}<=gYRrbV'}N1}$x0lc?2KdoWeZxp8>;S7u@KdUF.ua7@2BA	D-f8J y7v%Ys/e^";XmlY0cKdE}^h3 zBn^"kv$7h](E2z<jM&cRAKdM<cDVX"Nxsy,X.XfOpz*@Ly WV/u]z@/P7$0-|0Fx#Z)5SQGyqpSq<m !C c	WYl@z9_)]+dD$q7,dyLTUbYih L{{aoH-)sosH<p2BQJe#8>#2CLU;KR\U8qb;38zS2HQ*BwN3IL\c67^a<=XO+Pbc|y{/ym3'>Y7=K-"dZ=R {[`enhEznG@a>Oi\;'pl>_	I}+/Z)e%M0s-&<gb,`}N%6GHdP9Tgvv3CGW[fqaR4q+R87>+-#5>\?Ki*!lYJLHLy@ GN$`~`^?zRJ\u.XL R
WJ3	)%s&|tg{9`c%J3)|o#{<c-!e!p/L=%N[q0"dJ0xx*!G<96N1Bj(32BF,0h0e(UA1:X\!0Zxq7OS,+BcDc=NWz-*e=[XQB5x0]TNh.!SV p+J"|V|:n!e~	dJYQ@sw=9h/=_n87e_|)Bsm#w-qoS%xRT&n|O<tO)c,%+nn6G/\Y^i	?h8z<gAMSB=7xB95xf%mX^{87`3\a<<UzW{x& 687Xs@CS>h<s#zn?WBHO8vE2<scV5{V1}N;,7z3ZR8VDH%w
!5Aot?s|aQo{!JfV2TY$NMAUe	OMFwIl0#|p?+hp0G'# $u}dObNO/hf{8}7
3&.NfQuJ|Gziyuio~?O?\^];Mpsb6Y6wzQ8S6}s0J/ol`w?sR82G6pK$G=NxH9.^i^DWlfKF/~by}kpue'E)_fk;1zF6h4Up:*zIp8?{gzg4@?zqTREwT0a,hJEQ
qats'y	1js95Eig{!L(^XHpQL7v8sO\\bhhqrv.q5io7
(n}l.-w"8M?(cx)7 2th|\ywi4c_E_=m/+n7rv_BE'&z-6}L7msm/<pXuR
BE^n^^GHiQ5SQl7Wm{.Dh6V8;	7C;oaSk7IAN>L5d`{86*?4&;n\aV#F+^Zx.WWK/90$?s7`X@58=nKzS^eJ=,\
@PW1+D*YDhtM4Io^nc4,[k5}xtGlFZEQ8r]qM+nZr|[~U^H~EFR!d8{yY
{^yAg RxEQfj(< p<EQEQ`EQ_#| 1C{-!V;!=gdRCQE@=7x7VJ<>JC?GoCWu_w~\qSkrR |)\`<tG\r*~q?2>xmbCZ9o<2;gP;eL<c~ <14&1q'fW.7\;ig3vvhf_WJAd<7x+SF{*G|/R"}zn0E7O`)%D5d!1yNc;H`PDo|t`o0Lqv4`>vW),<:	o:	ak5X.
HK)!LG4}/^%z>L2V9UTNU2J!/'%zS<)EW/%`0Y48jREQf18kD^^[Z\`u}sB*)(,<78k68vxlp4$k6xo6/Zvi`{'h6({Y+_c>/%S:c?cK{X5,f9	h68/f&}6(ZJA_"ks`i)BFxiZ2j}Qj z{hge_|`Q&.cC,]juZG.X@NYM>a)1NSwzhZ.sAM5U;vPmq3?T:)P/jdeHQE{GfPpxV_	q0`h(J0|(j(<!^.h_Y\.wK)OPEQX;<((2,tV7veD,+fPE?]p.<ry^\~Q'(A!Tj(8Q(O#=(JS{>c!s^\\`(,*%d*(JX
q},t,_GEQEQR5ROQ|NQQEQOj`UqJ$'wz&40 8~0)a
\7tT}MQa@o4	3o~\qdp~o6Iq	z0IJj/R.Ojx'>R
"6^~%k?}=U{zcq&_?2czSc0:+MuK0tqG{vV|#FZ2z$EQD]z{?)J (5chBzPGH	nDXZRkfHB`)[Jo?xJ0G<aD{3W0w*f=5|)u{KZ_y:lQY<v*t6 Ty5tgl&&&af]f7|Cw6LV~L|`R"%lcTN? |J`6H)-o[$ .(r75J>k6XQEQED5XQgIqBD(ch%e1alc EQeQVEQts4<J(&teN8xTEIy7f_Hx<t(8B)cEQe8i^K/kaXntH=N%>!}Nx)	YR@/AKd9"e%@}S_b%>'`{5TAd`=o^uh~Ga.h>i[{!nx)I}f%%LrYNDVW~iR@tKdnQ[hvVKd^"%Yl=Ais5EV$1/$AVE
^ds[|z|Kd%UE4<6PJI7m/((A+J><pVh9vg`3:L;jc:R\.`nq
0BF1kp_7v;IXVEoic24(2zC'((qnpjOHsswFeb|Uqn\	|\6U^+^`a|no G.X>ov>+?tBp8pK ;;`(a77k0:a1YSgC*,qoM3u>smNm2166Q{')}1uO|}
n4'-\p>O~<7X19{+_`58C".t.9tM&B%%"%T?>	F>@<o\x/ULj0AJO<4/?\}[C.<] kp,EQe}Qmf|7GrhET0dd8b<GjuT-ga==qw{{g0C%>{ 6{T<XD%=R1tG#{)[((4R_IOtO8C1,2`4i 0G((Owv#Oq:n)uss_H);A0P41<Q%9K!TS_jkd|G[7}9sw{;\xN^}ea'|1~7r3^.y7zI[D*l^X/v ,Vqg&oyynEsoz}>s7nC7W1d5&kA'|vf`~ 34:?#<$&zn$|Lss976}s2nml5lvNQXw=7BfoM/ =(J).:x?p`N?0>CMVb|<'Gn ?`?AGkp7dix&09p[=/9'(Ji!JfTT(FhhJ(.(A5XQe_{vvwihft	hFyA>;;aw?hWfAC#  Ih@ks{U=>o"3#I'<{#p4q@15 _87_\8Af:zPct_
nPP3	%C	78I_~_{(U*xdD9~G4`7;sF7f{7Kl.bnGGJM}uo9BsstuRrom~-t<i[zUh}5~-e.z>aY8pl{f8d7xrG!34u^7r@/wc]/>T~{KyMhck [Z,lS*ol<1uFNu.Dx|hG[o82>!"	wdRX7`Ir?Q#AND<4	XU'3Vm,P1vy5K_e;CS5Ar7Wp;yLK=-sm3p?OI;F VV jx0Fx40?>G1C|iX.A751OF
P7I &{Fz7XA*7`B&2OA%cl[Ao2%@A~m{o0(+gA5Z{&cip5+oE"{{)WmUpy~	~QA';O69]dA*!aWgb_12Z;okq~m vk {/ktavBawG{3km>*\kr;v<V)?`/KCGB^.8guX[{6cY)gGz9%?_.y[=Vrop0O7``Ah@zAAh$M&,'PS;9]3 hM`AAhp_.t[4A)[K+7 ,l,-U'8-   G{{ak:Fk44z+o4>7`W}e\
lmwWxs`u3k1`	>{8^t^`_`ro9?'lS{;W:A<>l_{|1*s*eT}H3"o/:40u|%O?%Esjx5s9W^M_UVcZN9"E:m}k=kS2
f.TN#}N83n_Wi?DA4B4T;mo}OX^=	hG{vnnxbn\;[{Wy/yr>IR~x/+j<$GTJC48>ZO;ve;Wo?5Pd`58TO[Vr/R0
n<Sr*x?cG=q5M@<l.9{U uz.\cj?Jo,M4x
 gG~, k5*3+[K+[+Kg7,\ZZ_GP?:NvXbVkae~q? P' njV!77LUZ?B}m<?ol;vnz''yaL;;W_	BKzU*&HoxrJ?NO}{|ADz=D7zo'k{?g}g+y>uqA4v7?g,E"Hokw3UL{X9g}.	!|Mx*O]T9`7yamo'9r1|Brz/xc:|U D"XCsmk(|y5+}s\\T)x-2
sq2+8h]y^_7	[`ED"l!:``_No,fG>V&y<&
/AB AAh0~N6B]1  4'xlE {"S~gfGgVPsX5)JPK!FpihCP`mW+ A'O,pPekA`eL&`$T	C4Y*^N5X<x$0x3qwA%2uc4dSA/8C;c
u.5q/'iUAH&zPcM}}rXwsOv c'UP.'>l[R_jc[}m BKVPD_}5;q5hA9?AptA a:UFh$$qPP=vHPon?Y~B`}7X`AA"\g{GC;0QhYy];x$ "g#B,T|N=wO[Z+$}#$/5+~]q6.`lC|p$Vw
W^wP2Ddd09)|Ac
Nu-P(RW'XY P<fp2g=)G{7ng;Vxo*fy7nU{#$~W ww'OOZasy
jl.-5GvXy45f;$V&At7<*E<;//$1:CD4>BA-#^)GXyi_ Ah4k[;/mCxKk`%wh`ZRjM0caC{A; 5{#!o^\iA7yKUVPc/v'cChMZ]K~=9<f \AA/A! C~f"n;1#i6,PF#?8g$c0: pD t7oe<o]X|9TG+s#0Z@}qKvPcM>}?AA/W<1tYWT_ZZSa}v8VDAX:tra)w4A(+{(zP{0 Dp9GNT7$2z8>g?YWiOPL@1<^MxjiiOPB`$'|g	w(AghfR`pP8uG4x:l;h9z\$)5eOFlLk">8@/:
}jA?J;>}Mv BM9uNdOa&3O@xw#p2<O6yvw\vZ}v~I VwJF<  _~o\jBQ`;s~W cPSN<~u
/O/
MDG
taqY:l,H>!#=Ds{SPEOf
 BKFHp*hZ+qpTqm;xN^'\y[W7rPpDg4w/aOy LG ;ivXJ7xl=cav4\@rjA
hG`GjAZzXp,A:oF3]ocoA]AGCz2dopj@p)g~5;f&uir2,bci
jjXE4,.w>'6_m=<Vd c4AGCc@$ A>,djVA|GLQE17PN&x7 ?(x*GxqxXGAUv2_	|,x00 L1^	J,AZz25M3](zBEY2.c=|dd5v?c,AUH|VJL;MHtCc	qVPGvAWbv A$BQl&\:5Yg9iME4Jmjx1_J/M!S7KA$p4@!1 wn;ol-=ofz v*@rP `{+h?j5:XO!>;~7x2"')LzfWDjyAL&#d!LB\u#! 2wC^a{tHndMG'x?jpqy* Bw{a/ZP_cB'0!we\{_6=k{x8%a|5=~-0	(zrV_x&IZ57MiP99i8qac&K:}j&A>oPsLgg}A.nT9gc&'g}4.GZ6}6H;x>Ozn}Oy|<1XR;5w`VgkL8-gPmJeB$J<wh 'W_<~<uEd6y-Kjt`_6=xeee:Y ^gz,$s|/Zj[?\|t6S~}WW}m >Ulz7Wx]}iN*j-,m;g"og;g-%M!y9CK0vkycJNiJ$Xk{lR-OC{;lz2I1T3#p<pNR)V|RA2)c5\P'}%W6^Z^Q`zw]-3UBR/GdY }amHHxt%tXD><=|RH?3c93n,,-w:=!E ]zZu@}f;Mv B+hpW'zxj m,$i5_Ao;BIzQ'$XpcA+W66,\Z^_XZwXA9C87qZ^3B_-*CI9P	`:qziusqy}|x
+ >W^	96 baC{Aox+l.@XqA"g5 hpIynKoM%!Oc`{2AKqxye(<E|@P 
7wwp?5Ce
j <"&Y=O8#ttGdqGd%`gd2H1@'_mj+oSS<"YiGdyq!J~O}|0<}qnMF_lv?m|HY	}*eZO=jN4PMUEN}YwY:GO%x*N~
p<"H:O_X{t{AW|Gd<"Gdy#.v *E-\(]mK%Z!KEzD}h~hCg4=uq} &V>|QrQ_;W7_	jj@4m[~o<?tAa
WY!M_A/IuEeEUh0#{o64[@h}\q~9t^wA!Q^{C| V9Dq]K
P>svs[uTxy`?y-tR^&<7](LHrt7A B
Nl]m5Pqf.
j=aLG>v_8ew'4~0h':k9{PeS0G	/O:;mc:n=0 BL\V`)8'? ,>$/.K]#|u/X;.$8~_~t	0?5* X]-.._rp{muGPCGSxo0xz;wbCw|m,8~i/%UlzA~C>t6Rx=4W?j4|
0MLU{s}fm6LLZ>-U-
\gBl	V:Ng;>0)/;o;8xi}#i5G|v}b|^%v2_sX<tt[D-hUo;/%:=vW9(:k*U8gW)hTL; "|VV/+):`'/4B[e`0rtsu	s<9Kuy =W!VsXKHC|8?\9@=k7+/d~cx~/iu0<[Bi':p*no~u77Op[/Nig16pSKZ@}.',^uhv[9=\~y}rR'*Esmk0gXsugq&\Yz<pv^-RWm=dh]y^#gb>{o~`I{+gSg6t0[~ }=:4";ZN7X}SKE7?h>^B3rzs9?
 wu9;44%JqKu^Qv`#ViC'F4w|`
7) p|7x2aPE80	xn:8<J`<qX}
a
4NA6!`IZA{
LuG4\X~-h;XX[Z[XX\ZW:5!x_0<Oxs3	BP_d[TAA(WG%^^e: cn-n]a}a{EswxYGxLAgx1;0jAe}?6l- BVX>+sC48y~Cn.Z8a5x}qpj :v^0F9Z0G~Vj!2?_yuV+K0$(	$=9(A-I&AA&A457R %Dy5>%eZ~`p ksVN//o,oo]Y\!1`v	s[vxP}~S
PwTh7f8;~78^SvY^\Tt%4^g!{  QIDATH}VYAT22Q_ Z, /o-^8BzCxqmwWpr;(p5Gn8HP@0_1YvTPsBxp~sN$2&`AB<YveA}M7&fqm~
j0]z-c\kw/H_BPcxG/3<A*]_0jXt]5S5i	OpjP
~|/!bn!ufNyXb]L&qPqtwz*F
b;O\rLnFoF}+K3al7v
%AKv3{W1"gUlr!t<O7)/_W_xre@}sO;S}a\]z<W%D4v{o',>z0_,>&rKv}j.zei3{d>6Yy\w&8ZS[\kCl7B1l}v^[vWMoc7NG}\8`t~7+KS;Gh5li%'%ub_'y~u8i2zA%8LX-qhlrbc#,=g.@<O/$x]s8|iTJ99I/?VsJ3^_^ZXXXkwNG
M(/U\6RsZ~f}KVPj7b!L)] Spu&Oj #^o@$PR;X/W_uwK|"3_!oCczA<LcM8/A}3PwFH\o`Oc\9qt.]w$!p!5+)5+*"WxazHP no{ZVc[8aS	&XX<K*Q?|E8.|4$VxO (fAM
jTVB<5
?k*Eus?'o/~zoxuO}{M}U%B/.`z<2nuy
_;WNWo|1kWU?a
uL16lC{irs>_nuj[@>y/`kfYI/}-u?@U*cHI&`67~3"U=4k++FkM?snkCv@\W^{/xg$o_xUspu)nJsceJOqqb<Yj@Y:u]dQ[ww1<VR])3G!|.?voTV	_T'.tnm`m=r~%sbwXpnK .akOngm&[]Io _';~}8" G?d4@b21 aq`}vqPc?	'cSoa_0;BB f=&`.w39<e2iw	c'hX#B^RPc<2p>0^-XjjEL]+i Tao_A\w/u
qY19cV'25";_;/Lh``(Gy
OBkA}qSy,5A2;oLFa4LFtL4iiO"gJ ;^&B-mVsyTSZ@jX.u5p&]HWC	cwp!, L&<yp<0rjx^\}Ww^y_'3DdX{dWPs@SGd/C5DL{CuW)?GdM}_YQyR|'6olo6D574o;sWns\}5Gdtvr!d	z9HO}\6[-,Po'f9cX!` S6N.Gdv_FhzuOb8+k3#.ci7?!q+0F_7TJ!"J@u~.~XT#\-a+gO1.}UGd~V9	^!d/5xk?qy> '^rPcM\E.8&~p<h{_h*9XjP&cZAqkb
 c 8<vQ+< ^oXa79$A
 H+pW`X48ivS"c:['B"Gx2|7#akGWm	4ccFz<RNCR?xd/=>D7A(3'6Q^kT~tO&#E\	.H|h""8x[gO-EoW_
/E..Ee]~/>dM-!|SV+g\wn:w|N^4++md~+u"^}k2@	+<!Tvqy sr|"~w?~?{K2V6S#}F=8Rfl!Lh=y8	p{K/e(O9_`5\j&E{q}T{{QCE/jpxotyNYi0&yymn=CD48a/ey`3Vaqy% +whiW^!~dEyK>}|K#f@G_ kp^!Ml4:`>1^$Gxj?2`]C4hu_$7>\@5=L1o;x8}4zqxAHp'i^tB,Tj`yc`&`q_&VV0Ypwo=7:q{kp20xr<71v'd^1rlTuv<Y=B:'?SCRmx9^>h<BU[;)pO<2Im=i`pnoh|3wu4?q? ?c!w5Q}agf)x)
58Kxw|bzPccn.eG`27	S<Fn^|o;8d?s|(epcn$L}hNs^vq_
\(=;[EChmbp0>c8M  O#VqkuzvPRZcm!P6@hK>T 4~HC
08<k)m~}B(\L;/P)]GxS7y|a.5HEWx2>P\XP$)#lz;9j9:7"+eYCgFR`CpV`~g+=8w[SmO>o_7k.?!((:"];xEpK3Tlb\{w7c{
?o<T?$5s0Uh!uQ l:oB#|[jbXtmE(ZmdFd~]Eoix(+8	7Y{LAT
Ew(Q4hT(E=K7%')y}HW~}~Qt~=/7.I_'=??Sb<2FN&WD+N%.32^	;)A=RBo1t1nSi<z-$$h2-O2b%po}[SkFR\&LC~]#^(bA|hz,mX_#"/=~bjCLCjR@J+~4UcG_X1v^UCPUg/^+y&;F,\;*:Dd44C/4>uqy26vP@ww[Vge?pN
pZBc|5
6x\"DZoci~7 8sQ;<G=ZX&7ecJnKhpD^_:40mi{g1?_}wWQ>yno-^hJN`}fG_%gmeUA4AD @<! 1N.cvoVx5)$B{fY&WOB5/c p"*h 
|'1,' &!,v6<FrsiT	w#D7=6?]iScP}(fO
p!]j!,[IX48
I	]c(IR~-^`~Deyp'N6Apha`~7G<,`G`qamN<wab \=B<*F4B4XxXC0|41V/1Wk/VAK	S9'&2iU0Hp#$^[!Np~wWn~{7&qcp&g&NI64*Yj*	rX&T*iK=-QYjF`_>4~ \U,*k?E29.[4S];W4(pm[P*"A{91ddl!9`Y htctO qlUaU;TH$
8` `Kq"$4B'hb`lGFodq04`'norx&7&7&af`kk:|bb
g1t,vN/vN-tN.<|{}KWRi/a+]-
nofXY]3Zk-;CO|w(aZ'O'dc~Mkjz4Z=Wwf7^p+7(lR;nfl6kF}cvk^kaxZ<n-[8 0C^,"+X@3@jatgjX7l:`b *n\kicNKtx[&pc1CSNu\s `j Z,;xXAxAqduttM>/!1[d`N/^~=[T7~5 Nm3IKQ<?Lx :H<~/'b{cwAcj8'xq{%s63b)85 X#54-^mwZ-=cYmz`|a:Wj<QMq4F8`LDgF(mP{ sa5K3Y1ayGn.jzkX8sDVy#f@'7O/^qQu`-o{aOIzmaXg{`//9nlBzI#)X s"[Keg=A5_Ed?s
^ =wo}m`Et5]Z&(t%.'#Vj]7:i"pA>%uwCF`*6FfmctQ$0RD f2b.cBNcPdjiOj7x/C	wF.V^c$*[Fn'9@;gN	5']-MO[mvy3jUaw,	=P'Z1f@ q0v_JR=X
]2+4ghJy =/+z`Fw7L@zyp2Lz?>ybr"o.6+2
i0<? 2L0c.\6%F`d~,+xB&Q`&R*fz.S]FZs1V_J"$0,vB:p{ka8WY[jsv(e`@%LA.h3p4brG0.t exujRsI~`U5C%yLRE@bL	
j0kS8@%l5ISFRZTpN1RLPM.hF:![RLDREMt|Jn!0iJ?]7wMs4T(>6+2;0~v<Ec\SX85{CA0 LMlqxX~dcLh`/\yBM6npQ9$a[m=7.|-M1=k(o<.BWDwqziG+p	+P\?!I]G.X*d{*d93iA<}coRu\7a0Zhp\D 4?SO5/[]4x{>/t{k~[IC4OwTcJg?xi


1Hb5l'c:.SRWP_
z0'
POON:(Q%$jAp|.hq
KOFAR)+c?CY@nV3Z'ug; '.O,%yE|u 6/>il&
J
+ \\Tn4	{f7Ay$?F|RtFs& dA	O>DGuL?a0R~gqn67"xd?s:[^go]oL+^91p`\fDB4A5fpx|YxD}y)/v`g:AT)URW1S>;vkPb)BlI%zD;kN~`y&P;&l=0fy;![i=#~.9O	mn}mM'=><`:^`sZK,[.go,.(m3;nJPL-Q/^^V\Vx[{Lr:f0qV&X!n4UMq
``Wl8'|Z {#2hscw+9+x}|fwcvG-.X?)?{b{0=(}dxC5`k9cI2.&2_vS]c|Q_j~/>%\yOeXY5F'h[4*
*V"8(yUwPAvhMt#b
J`dQsU*,@ah>?;4dF-kNhT{ifhJ	vP	}w_xb||'pv1xh4 Fwofyx
?Xak20.W17@LW<'F&8bLoER O`ca@kk6?TL14cpfZ[G 2bHAAjb\ V-
P&UlAw0s>LU,14(v30nUao7l3,Q8q>P9`1c YU
1AUqx$?%FilU@zC%* 7sd>HgKf	0xjD48.YiJ!,LE4Am4Xa5xzzkh}*F}!jp4k_ma :jQpihT$h v]2axY  GQ{a	>TV4@#KV}\/XBM*NiR_ UMMcy> 54GW9'>G
0Z&k15TbwA=WTpnM$*])uoeB5G\$]KyBz*sOi{}!a6	lv8[-4YVzG4hp\
`	UnlrSkrvP~i||wwx1>N`h0Fd<wSyC?y%5_FJWb"uM!'eR3tj9dSo5H.XpDiv[	HcP)ifj[r3ZInDik+S`0%g1dV\57I	H>M|fd
7zi<x%?^{7yx/p,jJ5F#)JRlZ	"@V	tQ=7TS2+!Y1(W+@;64E_KggxOz=,uzd7UN^U!)Q5:h7hH3g[o]WyC}~81N~:_{gpkw<KU:3A
~^eQxg{WA@<R93X?sF-?qkw|h53LLg7|X2aR*L>qVz4q,qpbY%|}s&p!aR:~&G>rne!qFi&9P7'XV){G~_fc:LX)$w2lf:A|}.UoJn;k	kT
kalryA@EmDB<AGpZC}p%YxvSy,F(HtTOx@d8 3-Eq$HoH!|hq^tA)`~<%4sRP&U>U[G}/jiX\\G#1EX`
)*%0e&(l3Fcyi*&`O2'?`taXkT\cF5g_QCfRZ% ~7*dgnYS?JcJ1#5JOC{0e9;!T*&w!bNinwM5Y1U;r>|:>"5J$ |Z$:.|xHChh0'/..bopkN"Pg&n_
9~`<St!` >E3nU+V)6^kIYUEb'(H=w'qL@sHZNVAi=pTiyIgu[g[[LNAEBvrL`l`{bJ0\*f~ {<2}-0&.wqO'9z5_2M1xaTdX	J`QITh`A0~arv~0$:;zn*=~y+/YqM+!O:=G0@:mtvhuH "(a5 sh{\Xz,|$
27dX;t {^h4?hskpPAXI8~bd g>W&shbE}J/]`X.;9^"`U#*(KRmRBVbs!Pe	5	'||Gg=Fma`X,WfNg9	aqSa> 0cLiNQ;61Q b&p9p]iWvq{> 	eHqyO}cJx
^+;4Mkn'68i}5/Q48Op;%T$c.mv1W"$FjyZ+Nld?v(%C"h0[I2)`hk,<?Q?x2f8,I>9GO?_;YOc64LJ{s;cE $8a:,8j`q4\Wcq`~PGx]$\i86`A}a2ZlD+?fa{s	LH)J7zTRw43[`eTT5",Oox@ciZfOc-QS`W_(cTyJP50v"T JlIhpD^rf2?H(K.f1Y*TSWCjXtr0
;gHxhc!A3rFm4m9`7^J!D3L=$Y486i0.$`/A{KnGUN,oFz[GK#t`|goR^2`8r`g''jc Npa6N#(*c4	?!W:!A2#e2jm?c2tO`~.k=c;<?d"4Z	K<pf`XE Yc:90T	[y.U6D^j*iLXT.U^Z_'0xmb8Po5z5pHYi)Z_76saq	7@0BDhNvm+ZX%DZ1J.`BjRgjKjq"gR]~{+kohp6yh4f8Wx@-:N6`] Y&>nw?}S-!m7.~`+`so?EcE#0%K0cCd[7;'bH&b5@3B*3ofJP6S-IjM6Syx$4?%%PSc	(+Icaa	5j@qRw cur $@}wo8oKK!A+@0jS*Z@c8A5qDj(
PB5 S_Z\8JB+%SM4~9jj%yWF +^hs|R@Jky<.I]	b{f5?u`6^bB4&sL_,_
}{Ok2<w%(Dz3/7X$MIVJTS/QQh:vzQ?d7\0P8&L>&SB`0?uWU9A/bqy@X0rA/*5M	Y5bnQi'L<Ce0MJrQ%\=mu @-4Ui_Ij`a2PV~WxFBc0[z _md3=g<FPD@	ISl?a+if	c7Jc,mqe3|\*AU8}b/lFRSEmK'jKys8Kg&87'=WD=ggJJ ZB;NZXhi\(UDu&5X_3XMf=v0OW'Igm]94v 3>6EK]oTCe6=eO|6LBRY\X8Zh,(P4y43F0 k4&0Q:hUj{7'}w=4LmEAKZ[3V6'Y`knD1|r9C0$TK	Ci;XLuN~&Cc2WTY(b!c<S:fQKa\T\\6^*Iqw3}

b{U+HQ`Fz}'1
sb-I\D	lXAa2lAp*zwipr^R-60	+{	3sdLc3%8F?C" Ch'#=oaL_r:b!`JhWG_x>urT:GEZQn4F28s_ZM}(Vku94&D[,6<B=+j*"$O?7$dN~kcJX=w}gZt ,N:a7	f0J9Vhf>If4Vi||)Jsb`ce}[e]xk@w#\L{\K9bZ6n0L,Q	#i<,9>mc/a-eo+'~z;=LM/.;fz1yr9c[97m^L Z3sw<9;NJE#zcV_vF/%@i=nn?ZV)?fO.9C(YZVzV.R?Z48p7jp 394=<8^iXx*_
?G:i	SySk_ 4.;0wZ$p`^)XVr`C0(	Jq' 3d<r  oCQa&+,SZ: G]u55Qi0Q&%/4DEC.^*	c EDxxd}/@	$R	*1GR	S*A,LBb`fCn0rn8gP=1<c'gkGwpB;qZ	u9.CpfK6!tDcs>73UnXqX-aViht8f9J!%|OfU	+<jCZT!m/81,h9# ;W/cOz+
`hwxxR`X\b5Ws&;y'1o
$Ce'jHX[	pnzcCj{]6:KFBg

Mj'(\mW1j;`qJiiGj*&=g{%JHK0aJ99d8Gd{|}$UZU%1)'Rm8<gS1sDsqEery2DmSoaJ{j3kK1a
TSa$q==pH9>F_;Kp
$\/SK,k>{+jc|Wb>(*8HH7*{
crNM&jpeDkp #Oz>!
_`3juFm;vLh%]-	..1
<4Gn%?4C^QdM42$\b1Pn=4>|*_'/F]cm677mC:rZ`C"/F0xY!djoV&$.XPw[E=0#,	qmm|if&H
^D20E=<{#-{w<lWamZ3NpX	;Om9dpN(rKT6J +z39jKMprh9j2'%{Hv7OYj~uh$lx?PfX	&Fz&}utVGK*Q9f
aT]y0'{omp:h^kr!"6n8/F"{|O60p}_<#`5Oq#s)DgAj 
&O:+rx
c!.u4L4mPBI
owo=ujB97
/2H4I<m(x|p[;&J%XIRj5?
19F
\z)Ok7"R0h%XW ";lxMLTO&`K1ihhxs1lX48[3h)F<' v$h1<Li2hxG4o<4Sv3_tnKLhh5Z0~_@B&f`<Na`{5yhlJqPjJS(t|c2Z>,:>"i|a@TXq	t+hmymcmX*^l13(4k^58A1T{w{40e4}ZZk?~@BI-xF$I
im*.OyP&8Wx7g361LmN3
3Cb~o(h0+>a}b8FbSc%fr04<Gj6UQ`D2f\5Mb?\$I,44S;I;5I3-v*g'Ek}wC/hC[
FTt8558 vH@hlFw^T^0C }kde[Y*UT\{~\<q,$FmW!O81;]-M
qN1zI_[N1:\4hIEKR?1a~6FjB3@ "<|/31pLQpmB#M3,,$k2LSSNm/o3&#Wq\X[ppJMJirs_LfVfA_6	GT{g3=;S&i'2M;V+P48.;CXS0avAi5cE+`KOS;>ZLS:C=NAza`7)5rSj1z_T1i0 	j01MZcg[c44}|j^'l+J3V0b1UN 0Mj5{p2cJ<~j4aiL&UWbcR>Mx69H1?<pB04a30;CeH1<obV6KQu6#3Acix=]g]=O>fmRvM"v9jh+]Jk3Q\AX>Wgh/p G:\MN|^xkP29oT8d.%UXG4D`_`8`}Ds^w>9^3pf (
4&Gi+1Wd,`k/!n,&mbqiwoW
p<Yc/@|"t<58({[0,T?_,qkwd7A2Q.B1&~Sq|p=/j\$/
}=9[Jhjcu["EC[e]7*kGcipPNLrLR>q<MK 	W
"_8-oMuFCYb'jNt
O'h=[%l%305x%1ksKE[lE48.x(>xQrgJ/#gyd}|ys'X1bp`~!-%t`=.[q)LI^f,MIgmYazqkE=3l116	cW4W`xu[COuUz35X,nB:?34_d|JY4F.?`!$f\M&/&SC4^tkgU*Tj|P5Ki5+k  +'dA=_iC9fz_u|Jv0
3"AcL`Z&`@VFg5k4bt0<	kUTI	*?Oad'9j7nx-qfuk{"mOsFZF%<c,Y|gv;vX1:p>a)[/-":yN8g
)X`Z|PK!+hMe fXtNJb@*lf ::%)NFo<4'iv\JA4;>A3vI>TO6	Z#~gPf co;h0UX6s}61aifZ[h= =6IqOq7y)A2\q:,1UK>wc0k0'h)WO@SUQM	fj
9[pwHp4KbNS&x&'1pJpc\;9]<8%<cjj0_:7a{st{Z5IkA.!Wp@i483YpmRBhpZuQo>tCw`X^6:KV:OsGn e|xH$1H2q",yh 	w
O),~|AIP'^XacE cp		MhjXkXb?v~I; 8z`kW	#s RMT
-XudUO3W8?o,f-&Tnq_-
{ZU6Hb:5MtTSn\5)YA5"J6 5!@6f`O G41}'MS2SaWyl[9c9sJU([Zhp4Y}.cR1]Vz) 8JSL8`'x<(3jxzG`&O`x0jCJ?xt(K	:UcC|$E`.h0<l-QyHH^V9*2t,fl*rZ$}oxx2 _8{-q0A89'WUS5hk%NiympqQe,d%f.AL5 w:|2JTr5<_i\o-R	sB-CtUX>P2*SaSsuXXLPVbeOkV	1KVB5Svv`_*j
jrQ$.Ky&+a!$y^%|{;,.
pIGmj0A.8l_Z!l8N`&@'ucr1<L;HG x0|6*	c}x2s{[p\(N!NbIz[K'rh0Lx

:OY.eNXqnhX{*A5lK>iZ9J?olkKkjV@&19_}Y4xW5q9$P	40rE;kQ;w)Ff2Gs?

fU>a{xB1	Tp84_18CPX_uM4b37458CV
[y~1,KUfc:uGZR1mXZ3Z]27bC!S@!!;Hs	| /wX7e?]x;0],& A10p-Y$4`0T]z!fD_3Ca#=g,1n(!Vk5_=B[j4`	8`@ZN+E!AsO"KsB>sJL1Wo~E"Z c\<?c81j>]/(os@q)@mR31}8P1P!xha\Vz`+O=PS^oQR]An<o1#!i59V0Bx[PryeQ%tk0*AD`q5l58J'! /;g'?)#^*\?{):d{$8Pd#]|*GD;q\|(4<5?3<<i~'P$Q-plP[6R0`8k#6am+N4'<x_8i`Zk~=FKct}6v{5Kc,ai0{t]l.Y1[/$heZLc]4!g9<&%?`,|{	<hjvLjZ:\I}H	|Xufc%~wLzVh!'`NP6sb}kp;.J`qYwAcv-x?1r$fC9M`^?vy2j\3Sh>[#I'pCxS(l>mk<9`n&J)-	cIxJw=HpPhC Obel0D6A`EGx4F`a:P).w*,v3%)cyDWG 9a 'Qvjlws_Cu<L
H(?@i!L`D[g[+P~{U?R{6c9 tFMw|`c21o3RC
riV@5&t%H`=?MC4~D#uQ{aY kS	i^3OYDNX]eGK7c-JV1$Chw/?M [H-o0WR	C0Tc!Xi HjM8Gmd;tu-R p68N\xR>m;bbiZai291>^BLcqv/[VabO4A`&rFMZ )a^/Lu+{!AxmMuqsv?"| U'88
xN(h`(W(Z`DY:+^qYmB mCpLyNVBAl#!aXw_[O HpM+s#	S0	j G*Mt$%1@0Tw\jChAslsZ5Cc`)TnXn,g0|C1iZ7-|8Cu<8jXe PqVvG->:r	Ogy.
p]$-V-@R'Qip<V%E{c7I(A Je[:<j]xle_0dpqt<fJGNtDQz?1^nBDBSCLOSXisb;'
s`xTX1AC\;;#|%oj0x Y-)?+ DAZUtbZML
t`u
'Z 5Xoj?sgbOw5qg`[Ft91FmIp ukpJwy`L)PQ0\V6 1n*%*zV6?1p3Q(Q5Yicg2E e?:SS	yo=ChW1PB2P0At C#|_n<AosZpWC%`q_f3"Y!&["&}H!#s_O5_K9S?sw!%uipXU?CX]c `+T@${NYdvj0`Ht8k|/.|X0'JDN2$x	c|N{0~o +>A*-MX3F_1|xs*O ,:rL}O^
c5c01myx89qI@c'8\SV"W^E1YioKEahp\+D`_%qjX[i9!`t"x
OmpQB-qQA%P=3o48V?p~r:[	htxO53kp@T8CE3#4?$j]!|rnz6lP4&.-2a*%~PeIJWTV\&`S3AoCJcSHpt
BnpAeqA_a{c{0[r92L6>Y_[vz;*i'N  obxM!H
fyo)U'Es!&mm]+mZm>`U?t)o"1=T3K0,J(B/-&71DJ7N_7E4V^2c<Rk3`8qtb5	O E1H`^J`<G3@;Ikh$C]t@xh~V1ojpb=~y?T981zbu_H*QfV1A.b:
q4Q%vvm	.X48.3|Fiti D1Zv(hbr":M
qcB[,zI	 C<oIXiG]=;H%x`8BJ`K|"{8!Xc(v#94pfY$^hul[J+6~,	LG41(2TD2]
nFyo00n\+Tp;p?+Qf[B'* '
U2sP&3xnR)9k/Msc`7i48?1^5{W>7(jv@H8???\fX4X<TN]f#)7 H!AZ^]^s/=!\	{4.~Yyf.T3s"
`Tarp`=%>`>gA-v 1^W` i7|e>cXoln.j}IX4M2	uy405Z1;c0<AJ4X<V*q<&m|%H&pJ(bU0s8oMO}/kpkLcLgz|gs0|arTN<:1L
cJUik/pzhmm_Y1XwFq{q*1`\DUCV?m;_.rc?a]O;U6="`sP?#C%TOAXPZ~d
-$
ipNbS}
UqV1 sb
8dt89|kA+[K3rc`748?0.K8p_`r`w&:*!g$ fE4(S>	Q60P@9gUPA2|0:|>B|`,[?"")12kp77k0$Wa>@5-vL)}g16PYLBbX9|t?J_Oz`jj6f7Z/ik*U4"(Ktq;+ZU'0^=SDUCb.~+B);(n.&Dll;(qu^r`	8(Y+/ 63_B Sj1G{jg31:@m^o YBkcj0Ym`Ou"n"48CQLqN`JA5: ;^	17U6%0aZ2R'%Dh!v.a@1bSSw(PavRsj'm4I3'\R4V_3[H<U/7
\ikpD!-_T\3E3'`52?XL81]]d	2q{0l5Em(f;i:ag{b\Fqn48_~*CO+~;-DUC58^pwdst+'0@mLHP*K%aAq %sNyX/u`/U e4TB8qD7voTMUfK<9_<~d!BB$0C>K"Xeuc`b3A/)mpW8YE`&eB&ObVlSR1vq7n,DntN/@,E;hphC	<6%AC(:fUzu2a*?\hSRB.LyT;7T!O}N"grCWn`9dU*qHAM4X|5N'M]~Xy|J%+.^eSa Cu,I	L0Mt#RCU8jiNWZs"[Mq[dz_~GEmbi+A$k\7Fr$a
0Pz	/loQ	NPJ^i"ux~31[`W3+fJQ9q58\zD*
0Sz<|Ho9.`mEd8Zhp+e&[[IX]\pkp\MI}hpC	rnx@J\^rg?)'$%UubWVln,	J0SB%_q"	KoTz@z'5`MC-WW}2C7Ilz4xG.@4%Yhp`~o;0Pi.aw3`~oL5s}o bDs"zOx1n4W	<M`~z7^6 j@]e8sc,OAWl7a\u2R
\5{RuKYUM	Hh _$k5<'6158\tT\b@G4p5	X-/Gu+q4X[qY~c%w$W~uBjN[c1h];pV*u:SRQ#&@u0
0Pg4PNIV?oU\]b2oWn,58DR&&D{+~dpzrz0PuB(D ,^kH#ixf->):a\Xu%PL_7?6Hb&&/Q487
`@XN+A?=r>kj\%`PRip&e)Xq\bO7x}wpnol/5&\DH1z&w^YYTYx]` qb_%b"V?1to9^j/@[jp&`m7R48qpD"29j0P|{]z-NcikN8UuD%AyjU6!8pC:-DJt*rM0a@d8ROa><+N4YP*{5E kMc AmT2S48.Y &# Ms``V_$\w	L2&&\3BXUO}BrSTJ\]vQDkT6Si?;7SxMt(X?EY4XO[WKz60PE?LV;u_,3*Ncg*^fU&S.T||adCTiNE:X!!OS,d1a`WdQ7D:)5xEN@J 3Oo}YJ/Tio\M-l\-R4 |sBLN	'VZEvm,
Xr`/C+1EU+JEV<IX1J[}u-U`K[/A/,G*^JXEkxEV!&lQ?	 1mp1fuT*Dwa;W{7)V	_&'kpxu.m5"MuWbbu2( AeR.+m[ `e<
\d<}=C|h`_:.))ib@aV[p-i&i0 &03,O5M6
 >v{BE&	b[;T u[qRd@Pe{}Rf}hpDb/42)n2'Oe~]k`$%/Zj0 &p&Q@B?O-Xl7\hpVXCtRuXclD}%#KUt14Pf0^%1pV}2yOm?J4"WW?1l]{*mVTK58oM@ C ak	3R`en& \rp+`W\hp(
"@(jD)N *EUj-CX(^MK-p}<2[DzhNJ,\<37TM58 0+%S5npgK&fU*nWPnPu\u~~gb3,WAV@5z=~Zjd2Ym\qj[u2TbRcuT}E,!D&:*b130oJgHn^2`]}zzO@H%Np+Mb -K'];0P6I4zk04o&_m[<	^s|c)v["LXSF:b44Ul4RJ8pODl3)mJL8^l6."X:
)FWD/:iN1<[K66iFXQU80 i	U)@1xi<f0P-.D}	/jN>[m+mkpj!^K	\r=1LD#a@dNr&00[.*[YM`	+B8Jq,58'3M(u?	G$	Wl-TAj"L\'q:QcUaF8"32Czz"LE;fD&'r51aa`o<)GF%-*ZC+HV\r+NU;;NiT*h  lQJ/Iu47>96oD-**z(UT Jl1UbEB6n 9UzEKX4b1<^i3%&SJLYq"+]b(vp-7Vio?T#rC:c!Rh!&{OnlT	lTq5GZqaEhtEJp!Gpy`	ps,7"":6Tu]'(%a=VO`@:]UhtWl"&BLRK9W'JB:]TBs`
:R*Hh0sj>?(3[w	{P	+RHGrZq.,WA'cW2R]#nr.am	{\,Y_KKB{G:3`
:1y^KRjUk&7*jmM9D9)BL
Y_5(^bi_uX(*1j	wC7XfL8KNdDh/3oJiD0L^D}e	:lu`/bcht't[q rj3m,BLxXrMO1 h(f)rt,fnDP3*1L	qDlJn! "jj0{@d8ME.Ns/J(q3o34db4WAa!yjn7+Er5[+NnR2!PE._|8Q2o9U)V,O8WTf%N4VW4pMk*<A|8~(7'rl. W5X6?SuDiSp8Apirip@q%jRm,D3WJJ|iH{2+N[qTN m@x*;py6:Cnc!&	^uYdx*pxpORkET0b<Wi%G?R@&\E@J1aJDJOL8
B6a(s)OT0Q\qAj`@8
A\u]K5<)"QeUQJ 7$B"{S3!jpV{o;n4GB)
XQH&M	-Tm..hp8"q4Gjuh0 #"&2WVB18FQ)C[qV[8[<s/(B4hBpbNNZUjRP=@V\@<|O5"SN.l/M53}VV9Oc!2XMb4PW(qtdbn?;jD0rt,
vmrm,DvW^L8b%%gN:%eLJC25>Ot%L>#0t7]L8.vL#ebX_VS6(ZWd\?O/
"r^ML8.);W7WxzE. 2ll2+hZ(\V|g_D;"!o!Qo_Q6D"~\?vqEBKunVu-2d+xM([QTUWziU=td+!<~ALz5L]8lF6:	h{L	'@L8eSWN2D<B%N@yP17?wFC
e_o_AOv'3X!rO4\N@a^W(q
_F*L5@8owU*Lo.>qdTSb"&Rbv!>V Hp2
n@rb?*#S6:W"24R]D>oK"&BL8AF'9a":y((q2DmrtQ?_`pym3A^'&VWzs#2	><[N(Thg?.ntr-fq4'&A}iG`@L81s@b1K>\	_NC8u#]k@\+e6A8z[bi%b(@&W3NC]}8F9V{?rBF!N[B/!\uHpD_cDPfS_BT
*Ist7l#[\#D/epz}0@,G	WntbY1jO?DW	ZrqUlAHpa&r51ugyp*A'o%.Ltl]7,LU~?FG8=SVhp!\-NN4$_iFA|8=Iwb~:qUBe?A:&DN""&	MkoM>,2p&*n\DC +vgBG:@?LSkIDa
Qx8?-ut7
^?#S&`!N@L8p&	gEUj\..aNr3azeHI!E4x*!D~bY!23oJXx>ih"z03D4x*9pgH~-6$KO=|8W2?
~gu#(%G-d&!Qr-&!bq6
bP~.F$7u#R{%\ghp!\m1lWE|xVPX\7gnl3&lHILb#(uu<X!%Pb`J8pG  3G/iZiDgHnFD8s6%IhpG$^S	A_If(qTKEZE8DdkJl,E	AZ`ICa!/%[h0DKio.VY	pNTVNOF!Aq5u >%l	a&qhxWt\9:bQvX<:eht(x*Q%&jp"!:QFGU\!bQ@Slln>|8>'4yAnoFD8'fju	q6%&"2)[TM7u%"_54x}DB,sM5C8WD#AJGTb
nD|X\7s%V:c8pJC8oDjR"|J.`Q\%<Zo.\!!.yanNe*41UKf&%+' '|%m+lI8pM6,u		q2\d@v1xpMx3)~Q/" U r*yLp }x}(:n@|8W*h8p1eBxsBNp	a0.'B\%. Q4DlS,\gQH#\B*$iebCA0Vaq(q@o9_C&1RCkBCX2>a3kQ.f*q,\w%4bL.Zon'\'i%T>\&^TK.YZhpJIHGd0,gH}`c8FG|Hh!`q")1$?0[7C$;X2f(qVSfbNO~&,&T!*>|o\diL-~[C.LpOFd`2o3<\7
Q".lmsn,T<Lj*1C8:Y	pmt]Dv.XT+*_%LJCq1.W;o;X>,KQ/`Q5LxD3!nm	JgpnvUpU@SiJp&o+2&,2K}&gE&\f	1x]w*Yp]7
rt%7KCv(nQH$>+D"Wfo1Y!2<(>,X_KkxW^EHJ~VgH&5PNgpNaqLBl_mnP{ghp@2yELxMunn%6;
Qc++y;iWUkaU"-31ad	2Tps\w*"VVPo%Wji,E48[`l61R~NeB|ZYPSipy6"<[D3'	:13sNy2B|Z6z(q40BxHV}0t.T4D3GLx`w]-e\eL*+
*ipV&#8\-9Dz}9be Vtn3G:H)qe48}!8pFX5o@d. O{(U$DJ\Y99e@v&(EL=pLJ$V!gr_KBs\\>oKDCL8'a%ywFDd8'KHR-	e488py.	u)C	go
+\,LJ
<A3Nd8py~QfW1 &2<Y\0D#1)5fj[1$J\fS4xgB4<j_geU1a\w*wF*5S\,\"+>\*lJFqR!\*;X!\ueepvhqA&,C(#>\*
h3e`q!\*Ar]pSJuBd8WU4Xl&XT_k@LNt-\)@Y	[=t7
e#W.."Q%Hehp=(	ubnyps7qHK(V-1zP	AtE_%!oDKFD|$k`r"UqK<LX\E.'"Pa1L.'5XneE\kC2u b(/n;TBnp%qj u]DKp$k^U Axx,\ftJVj
C:f-n8beFd"CJEFd0K3`q2@P.	uu 2\fDwXo.34XODD:CDJ1#2>[1.9+"uRq]i!2\rDa'2pI(ZO9-KZhp2K[\i!dzsB5XLPyDD4`C8ep]{;R"1&]|+STK@VtQ~''JPf_F(K(HE*AJZ.ixp]7&,[$bUE[apM,vTTe	.yn8&,[DB%5'XA,T@*hL(C<<RB
FXgH,ZU6BJ**Jt ALBgIkpzHO`I,HRYB4xVCX\74O<"Kj?"G|81x>,Z9)Wkn9=B"%U	"M@|8.kUJj!<C4iNEdZ)U.&XA8
kT0ReC4x$.v^83lPwCQUfpCryZd"TL,Ejr_f`%p* R3>lIooT$D	_~&t\p]71*"ZU<">"^V2TsC4G"Y'`q#&\Er"A*n$a@|cI4r*%
Wi)I	o<tw%ih#&\Q0f/7sbQ	%N)^jp9UJ$!
EZTn	`	Ew#"&\])m+M$>JgQ)4u~]}8Sjn&	W*Xo$K>\zaoFD&P9JmdLg! &\icSl"e o}@@><+&'"3Do)?i0ugpM55;2#^hpV2#\u*UuC8VJp$NG%A|)qKlNdEt+8p(W?!MpZ9+	$5{4<"%dZ"L5@4vO,g<43:>5}|mCANJ%M(XsL">4OQ\7"K*9+1 }JITW4G`qz \uc2_\G!&\DrAJZBci7+q$!.) A4X,#R!2\*S4XNYT)I	EAZ+'pDzC(i8pkJ)>8J@h 2U"GXp&!5XNWKt)^uIp}*?w:!R|0P'0C`q!\*"n9i]5P2!]	w*	YRuBD.J=w*+quCH9!S#H9rX!B1>`q!nS5xjdTuaB)fN?I.!Wvh8pN\7`q!XSNkEI];Ez,\KD#RBe~]-:em3u7tR+ZK@ZZ*"+/!q`.!I0 'pEfTjbiIu\f0)CuB.\4QL:d>,\[jqknH$M+KN>l9o,B|/I
GLH/9ypKN'Uq`qd(/IJp$o\L+>\rB|X4G,@gSop(,IS	z#;N	a^C|X4){hpB(IpKo"}X4%w];*%kE4	!aJRBdW*4$>\o,]7J ,X+pq&$u#A4*	I=1& {kdJ!\+tMu70+*Wn#gB1;|Xd<WWo9W\7D+t:wRYAL9N)kJ|PuF4BHpcun'D^JT\,]QDKAZ8nyi4.?YIe5
]\|9Gz!+b&,f!I}5
1FQf9e}@48cru :p]A4ZHpWnnTR$uC`q#\9CLNi	7DSV\,]ND)q<L&jfhpS8!4JKSA|N4Z+*GI4X\HDp1NL4b \s{
jr ~AA!PpjZ-Q}4"]]zP)?crBRP9mN<4XHopEd4DM4wiBEbPAt`"\QD %./?VI4X\7:Q4X\W1aF"&Xdgi,!{-2\3.PBw`q!\]f@6%j"&ddWj,KW27|_P#2\w\w46|w6mBcRBh5UU"sDmjPUPrej NPV r=&D?6=sI,/ePu7oz_PHi-'pdqhi fL(Z\7Rjhp:UCXpdJ:aaFi'_P#JOs\7q`A45a9b%T@IH \+5Gi !	
jA':>lmqx<?YAM '5!O
"!'
I A65<f.4r
j`Aw{S~,&1a	zPf3 'N@Ei(i",0oB2C8TJ2r, g.&orrt(Zu5GizqA!PJ&=|' ' ]Y%5
T./9..L
jr`Ah.bALX`D5i[N&2,>C]~5Gp) eT.&G?<P	1a	C=i5	X 5X\HW T},Y &,XAMh:R2LghA!Pz\k5Z'X:1aQ5A0b,i9lQVjshAfnVPav	:(=	4pz`ZAMA.2GLXpQias $Efa g`.CAG\+iwRIbSj5R5e8?}0P-`A!P5\k5pwvR(_%bRik+iBQH2tKqsbPt\/heVcHL|X$>BaDVwgp|yxzPr#U?pa2,\Ru/[fCX%bBY	H%2uPF\AM#!,G$^DjP/rk	dj %a2R}A-WjBv!=	B3J+}8}00[ \AMCX1a!Vv=THc1)e@Q5YL:k< ?8_SphpU*zPCX79:GTA1SSyla=}XNAKt9iBaa*9Od&D&RB1:,eNKrAB9AM.
jBj2\PWDM&G4Kp[zD&La!
"9U:+|PDkOCA	/$9[d	Q)9|5XfB=XgB}p.5M,HDoJu~5-?B9nfrU
UX5Y""zS<|5T(la7Y0@EAt	HP06b,ZAM&50D@&G;Lku9i#bzQ@d!dr+EP\k5YLJ!,&Dl}zP@WHpC`^1\c\AMCXh"6XwVPA2a+ZAMH0+Dl >s5Mp"#Ed9duY?~fD+Kt9iPVCXH@:Q DFMp@/nG.,E!XgcVPHa
qanu;}h2\+PnP> FB4Xh
.	BCwRuje5A()y!"M#x_AMhlpdAh*| DzCgIjPF7(pNXh
rPFd!,SN	%FjJHpQ7>,,T ZAMXCl2H
n\\op7J
   Bi>    IENDB`PNG

   IHDR         J  IDATx}	6A'C2dc(T)4SNC"CTGhM2;feLzk{k^^;<^z/|g~/?wyw^./~^{xE_E/_s}|W}y^^^^]]x|7}'~'.~///|ytz?"kb_/+#>#.7Su_u/+|E^?'~./r/w'|'\~om?/1syy
 oFoty3y)OfSo-oo?/_~vy~w|w\~G+~o/O{.//~u]~~_;_y{^.^?{y[/|}.g{W_y_\U_k~/__q?~^ajx>?
 
//

Wi*r_5ww&@c^cW~W3\_%?|'x7x'}']Wu^.)ry~]-A %!n??t\_z2;2++]%j|.yy@__~y7}~^FL	k^U<f~|}]Y@A[?/{5GG_q$^%^@A"{y?E}d_J>z|~9?>"aA L^^'rIwu]}|wq) @{5*[U3~~Wze` .~?_5xo]Cz^LQ$Hw_x2
?Wmz>>PN00/g=_]>>j5Gz<
/^mj)/7522/2_!8PqM._~5O2}p?'/k&x/O^JM7]~
Nt$}W_;} !!W\wqO$Hi%WA$?@.IWg/jR/" q{bsKfoD$Pbq_L-K8P~#A;_\
H}_KM@Bb:> JB$_K<+|yyPp$@r$KPIVD @B2
`@O)yKHN}]U~2xVA+ 	3w%(I\IB||~5P&o&;} K zK
KK>qIxO~h>s>$I-pjA!HP$P|4> .FjHiqt 0g}g]OO/E5_B|= R^Pr_$P8E;7%IGtR'v~|k 0AA$;PzHt@	^_j6H	 > J~6{#)'E<"%'~Qs(Dzh;5/jk+F!K8Qa?\@$> _Km]zA'}D :pm{F$/VL&ta^r	@ #5_Bt]}#<	Jy00R,EB1H/@"T^bRG C4A EI@?#?B %!CI	/i!] DU]w3/)WkP	Hd@BI$&H4PPIfk0$H2y{/y"%/}??~ !	 @pBB5H4)"NBR3@ Ro>I40%(
E.?R_:" TDSh:/#=+I>'13AGPjD:/ Ht@~(yg G$: > (	w#JNX< $=aX)_r'}fI_9(h[	P@(A@u/a?K'I/SOR_N|D?hG	1($Xys&TA" @ RoH^E-8Dx8$Wz)t^@+OA1'=]P"$q> .Fjd.9[/!=I'Hz~K8$%X-A>!i*R m3&Abry 1$`(<qIr8%~/:"L+}/)8&@427PTb9-B$Z NFA> J~6{S9'n>@< H.8*P2$KPI0J@)@*<(5RF,> \IT .Y{_lz) vbHQD<$EBAH@J2d
xHc7ze/6W~7/}s |~|[<v+_=v|%=?^7? +_~ WK/+7 	 =y a P.v +T.|y
 qO <j 711`DbiB}H+Vce-{ 0 < ["9 ao .Rn jVy Pv,% . ` h0|M2~F hQ[@ L0; sK @  [Esv ([iDU3^5V3@o5@! pbD;@ )'`s| p]@g6Z9pka@  Z,l( * 2
Wk  G]F:M# d3X  IP'i"&@ F V Jm1V	=[=M~D>%kdQX vk J
Eh%*!?CK%
`h.( XZ  DF7XP+ g]hO	 
 u,F z?(@ ZRg 9jd n(
` #E2=Q /2+
` 6/i	`(  j@eVFFM P32  O Q hqGH56 [h<( 8:;&
e+F  eFk2  KYhU5 {)^G 0u%X/$ nx-" Z| V?2 E   ``UCb d8LU-oV5Z /9)&@/ RqkQVXVZ69Ipim]1	5X9v|KELhd{>iFOu+ZU~0G=? `XUN W9/y<  _w g:| Rur7Y_zU^9>~<Tr)& @N P G R.BEcQ2mHg6d	 01|1V huF umb[=	k94#cgw!  `&0 Pg V5L*\>RN'xB:4eYt-@G.	 3%?z6\GB}2+ :z d3f+k&}yaP]d% nJ { XJN0ffZ/[`T[?Xt 
 Y ja@/Yi4J'0FKkk9~V[p0`6 x## 0Dnt-Nha}ju \kGt! 3 #&A45$<k Hk, ^U @k6u | p<HV& jur:. Z - @-W\,y  rz  gP(@d|Y4
p :@-gYN@`@k&`m=duM Pj!*$U ^gZpZrlfD`lI& T F"F=FOO1j&Ty 5vKcW1P d 0P>+uDYo H@Nm,{K RKWy}  lg;~kSD}	1"5"<O NM gxQeb$Ax%@G  }22	`% = (a!-9 s"@j1=&E  Y+k'K @j bjDZx9{aS-@oZB /%70 3`O& rrYQh&`$
2#q[rX`dhDHO@ko_dH-W[PK7D(Yr`Xo![^c>
5y# 5,1 >mY=|e9-h@CiQ X5)5'LH 8G9G})>Y`TX9hf5sV 0{Jo\Q)
 (BpOy L  #Y Bz^b p Q/~ x0&Yky [QJ/VX`(W?@d #eOz>9wS--bVBo!<}l1/4s!V| ^fW(f>~7z@x::{\<0\:G`a0  V`= `5L<{oXfXa}feEZ-  z YT#[V&; #g-l]KV2] >j{`f# ii3? RW lH[uM aZOX!g|$d-:n{e {uYjg}jz w;i	Q8@-<}q4YsBZf[9@, `o5 y:X><&vZ^4XpUYLHwxG(l*li&T@	4>-{^ 5&agh-AG-n[ `i  2 KZgu.n 8Ce#>XLmw5'a H=q(@K^\ p<( D h I~Oe5`g g@{Mi=g GK*p	0&< L9 r   Z=IC RV&[5pSp,y =v&=!|S= o`CmC+ p x?T@#| #K  p`wr`Ol	y`A 8Q~ ; >g0
M 8Q 0ET^{V5,'<  T@)p9 WZh89 < h- |[5 Mo y x73@{#]|J ~ u(_j  [`?:2d5" Z 3{: u Dqh -<. qE k}< 5y {v5 `wh}e?"! b}(0m{8g?}Z}kBN1,#=> ZE{_:fflv8G? +7@/M wxUcpog8k9p  $D"H$D"H$Rg{I
 {+NZWr@"mx>O}o~wC   %/vj[
 {q= @ =d$,,j;_YC&:<A:v_ @~sq.v :Sl%iek!E]Y;2(`g=>l h}xZ?C+AuYq\tWu5P=_YXC/>| -Y @KZeUVU!j3$@ti-s @# Z  `W*(#!#z @@y-}PQV}Sz| Y 8; V[% 2c xWt.Mn 	f "#FZ{4oD	P:z_~j  tti `4% F{0d  r0u]+ X*5UZH(s ze.@	 Zf m_2 "Y&M7oCh
|D a^uV`$X UK^  E4 {B"0 "{G~sMFSGg< (^)z5 1{/ D # 0CBiGzU1Pm04N{4Mh[2>5 -,	iXf J@:7@WsP"Z 2\
Zd}j~EeLM pHt;fBNL k0o{`tzcMh;4 kh`$U@5MxQLC[<`b_ eI+[	 {&`L_q@5S k[ ^ {}k MyEt*D
 W	9:H5 6%H$D"H$D"H$D"H$D"H$4vg1n@Or{g3\c5x\=/O/BP{93kt/U(Z~x`yv4g = \{	R @v=ZCW H7i}<yZ3$N68nhzw3s25;^k5zv=i+ @AcQz>  (v]g>4M@ qhtmxK
xBO ywkkKKU	3@ EwP[|4d:PZ[w8V_jpb3F~i Xj83A@O  B 4	ZJ0Sl*Sa=KGNYy``+Z V"gPfHa0FeQW+UPS =0fGjaCG5*|z@ZP^Be'V4bFRJd #w7 >%  VW2VA(<tsN	^f V>E-CgyZLh Pn-k<;	"?K `gw* DG :lULNdPf0Yu* <k) 
 <T^kZ$0 

 X_BE<UkaI$D"H$D"H$D"H$D"E=pkw ]/{G_gAw,?qf>f'akx$X `L5EqSm}(/ &W[ #lMEXkq-kQs@}k#,z}]\zFDj7 57J 
 (jQ( h+7jiI UD/ Z!`t`T 1g>Q/:"v-d|B(cXYZwUl}-tzZvj ] 5CK^ (C`sz.- PCk/ZiH	X3V(e"G^ @@xYB [ j[/^s/!gT/y Dd22:0{&@fQ` , (lZ
 CL-:<, C/ l4  >$ @vi @3LnyVWff@	9QMX"eI3aN3=> / n	4''3 5(^ ~ V. hM pv`4x<ZJA 0@1bY]Wj 8i5  v N	hAvf (jEP3YxQYg98`N}(> 6%[H4GTK	18:2@{ `9H+ XfLUp +A6 $=WaDT+ Z-D8dd UZ[?XkM[{T"R= =*_(P;Q<:	gjU*-%:P<<LKK jG7	c{ 2$rB/+vtPJ_}-!
 -22\syD j #bk@#I	VIj-Ko3qZ~Z 
iCkeg4u UW  0jz.12#Azdh YEB6gYVGhL'hh ))VCH^y4y9]SXGl/vI&=h6lN"H$D"H$D"H$D"H$D"HtIUL*#m?HuF#&0rMe%.=8	 v,RX39scg)&~w-W_;jZm+pgpYw \	P\j&5D P}^gaj}fVjCX	@KMsA2MV2B90INc	bV*w,R0<I8@`W$N@+vhZ%)U	KL\fih`5}#vy. @`e[rK@[>5cmZ&L#svyz|.s`W^zlL@ J Zg	,x3zcWAO91I`y/VichlH9,a~8@~Cz;TRMf1k`6V;&1}-X)0oyh]}\\1(zAo]lcU|+\UBk+AG5'mN6C<_h@1P26Wi" m;3%pa
,*Gy^wM|Wka)6;WF#zLEAk!5]q;jH D"H$D"H$D"H$D"H$5g:>Hw	 G}wsq.Gk Z{&<Y3>;SSn`O%l.Ww2iU[vO6X@;zWg4w2 9{
;$?:X$|v=,<N+3TrmGze6I@9McBA3jK7`	 H ]5d4`GD69%{rFz(hj1Dv $4V;Yx94cgEt3U7S2Jv*A2CVCyX/
`56<  ku.5!F-vucA@/ZwExZ|3}lf Rqf=$u93AUW1aD!z_@ 5LM} V}@5r!Wd5,LM@+84GA(oU9I3d	f</l>@=O	fHC	x'+h	<:Sg^1~;mGz?5g2ihI^%qM -Eb! Z-	DgWn&.	]v=XP5] "NGd4G
U	V#<0}'y	{=,]ww.:M$hghr'B'i#@"H$D"H$D"H$D"H$YPjZv-grzmXRMw3NYWV^5(rcvozE4gZ D\9Xp;].g1J` ^-%	w-3@yw]P3s5]nH^s&@jM@U>|5 yj25ek@gBHpC+HOEJf`2^x+ZuV  e JK|%qqHUE}9Z	wj-i5 M$mZ  Vz[l2a}y?b  Th#7EFTB[f?;
QOlM[5Ks&2s kxjm`3	HA 2W"xFzv~+Jl6 `& lY{>~1 @` :V3rqKY Pz8zoQ`G<#Y, ={Y `F	UW+ XjeN~>C9C-@=>  P;> B3 |&>Q@-HOyJ:;pS+}5spO`5 lO-,;mfALP+&4'28la	?Y#/Y(K]Qy&c	XzWezY L@rbd4iXAv>6lCt>sWdhj Y hE@PYZ66EvdE|33E!Z2~a,Lw/=v34bEfBv31
ylK!H$D"H$D"H$D"H$D">CO&nItZ:-][\C`G{D*vloav{i#kj 0Z?B_UYMY"Vt9; )*Ot@TK=~&{neC9kWDKKhc+{A{@>-|0{;&:"l	G.E{N#mZO9!'>{}}:L4AV`2Tl	sgluWzj!AxSS2v]3gu]-YC]``yWGwvI5hp_ 2H ,F_"j1pwi  "MH 
e]&: o 1uo pWh4X0f@ # vK] =tM4jG5d wV4l&YA.,qkx8Zsf <CgNh<3^a &oa pWU 1V8Fj)=[LT|4`pgLP\[
{2@@W=_U\R9g@& nXo!b# l84qvc:@= `1}l{l"|wNB&Npxk  p j6^`=V ,O}^3L"H$D"H$D"H$D"H$D"mdsw gnY=jOyGGrn@q,]M# ?sv\ijQXsy4A`tDLT2Uud(=	LUw,rJ4~;rtD()fB; u/Qho3bn4=6K(]eVY_,~kUZPg$m>Z[ t[){[YYCdY{RX3syh(-mzRuo y	#U ,@/> }h/@-3  2 1i&%$f3DGeYSLUM3`$, (ID% ,g]$eV3GBftfYq- ,GfoIL @c[}hnIX{f/R`-	\vuSjFf>RkM i |ubg'=mdEo_*d@&kHD'dHYFGKYOZ*(("'b
@Lr4  ?$	\Qh3}5#` x% l
i0:/ {h@0u(x@]@0[BsZ f{c2Vi01HkkZYN bf  "R^@Z 
Y6ssuZgeDZ(,uUXU#s
 ~\sHz'-Y- F}O	2e| ;} B3`z=|Te9Uhi>hYS:gpxacZUZabSz4V~A#Gx29@4p&#"%<` X!IK TL+U`R$"i~6#lHb,@GL '0=@$u-zqvk Hd%Xy U=@k*p"JfwZ < Y Q,l?i-Z\>+|8<DzcgH$D"H$D"H$D"H$D"\pDtBa|e~F]C:35RjU9bH/#@R_xjdQ:4>]!:&q.z7@#f-&@XW3"1w c<2C}dVgoH f6I`4p&D3<s#`LgV+z-( hYJ[}f2btt
V
- ]?:~vG9{#vNT;ud@EZbmGXf T 3' w&z"Z8-{xLXmZb	6CiTSI hI	}{Z@&I4W }P^ |FwhndFLTAH e( -id)8e@XZ@N]Vt-L =3"(8bj=Ew3~W='l	Q k*!+^&"F8nDiz M&E3f puZTM+ X{ o | I3fl-.-R0j! ,5D yO+} Ak5, b-gL)q  [2 9hfK_ %S-3= e =@KG2Z(I* N:;  t6  jVbF3P,J	NuYWT @
i*Be9*rYLAdi] !v>NDRQ#'Tv) t83]SMsg)YZ3"O{t?dK$D #fy=.+ YZ L	/^ 3C/
>	WL_;_#;@z$^)ZU> f}A!`kh3_g8"6WF(Qj HC;iwa6II$D"H$D"H$D"H$D"$D;K&)+]nf1ZfToqvX>+0rlwYTyA#kxg@&[Lv>vd GGcF=>Ky	@V%VQG%eSD7Vw!}ux-,lA9dI@-wMgGXQ[x=/![Z  ;Z4  H
Z<) iUqD_khHr uuj  wk "*	boBQ+& twA 8 YkB`m`SP,gIy=UODoho@}l^K{ k",	lcDo '7R#SQ=n9Z1 MER!i  Y 5@Sx3o@`ci )~( dz 55lchZ@e- YQ3 )4 Hp _k@aYi ,?2Ch%@3ehA.zK{lQ | @~g"!04	O'` VK*% K$ BQ ~<3S36jB # ,42,[VS-M CGf @Mk[@SM  i B/l 5  gfO; b&x?dp"Cs"3  (!2Mf  )Q`V2 Y:a@/1;IZPYZ3Q`f Z!D R"w?PmJXE):8vXZ><|/	4`}9YJjG=:Z*|^KY@3?yNL @ bgGAPsK{TSP(XBQb C*V[53%M-#Rdbg`Di>	Av90BdZ\mAK
{a}1,#f7 83Zc{vX@%XM%XoB^V)hv=n' <ehp?#D"H$D"H$D"H$D"H='N29sXq.gI3ns/[t~+,f?v|v_;<_Y_`vKb)=z|/4~	?I\W0EMWnj 5
2R?V<+%Mwb
inz P#%'j @_
CCP)* U&@|f^rP/&A@W?3ux;>J6gqVv^X(gWeVge<h7Zf4A3^-JfF=JMG_WiV<ZA7X	 5-F/+!z9l	 QOe'KbN&}{@.}%#f\aD{6u4#UfD4n>Y4	lf ;O Egvkocz&h}tdO1zO&p A b 5 s>)jN	P8J&pS8KrYBov6sy;{V	F	DgpL!Yjg*[NgpJvjbgP 3wH$D"H$D"H$D"H$Dsjc]m'-[?36
O(xg?\zD(i(-<hlWCO3V0:[2nPoQjPv4:zgU c"M/>GXKoLJeh2Foo &% *Q>t_dh_4BR]`4oEYyF @@ vmz@j }7r?HjgFFmVfj)jU~	P  @  G]ygkKi.- =5{@`;l=|}Ld#t:56<XhD <8jmZ-ZjAc2B 35giEu"@zI{PGAH <A~F=w@elm> 1h N (N363qiq^3`>N!#9k9  1#>bKmX!l/ p9#vD2d8fj| Cl	ag&==!:oVwj'{7S;hBgnkn9@Kv~gMYm)C]HH Y& FZ;v Ve{Z. If9Y|R}3%9
P!P{vv!i
>2*}g8{Q5Ueg|tCk 4Zfr^?EP]Y/r	bE;P6ti4\?`B]C\Ze39]w%+q6@5^!fG.6RA=-i+*0[F5kj@s@-Z.q*\TfW+4275}Tf{D"H$D"H$D"H$D"H7JI5\{?~] ;<-1?3qZrm+ivAXooN%^:Lcub[`ur Wk@@]Zf?Q^_9P% 0kL$sXYW1mNk=D\h.\Vk*TX{e bnm~+v"yleS'jRaX;XJK,ExH?k Kfg4/8#)%YsP&gK	8:X%^.q5 tF/@)qmHCZMMtj d\ .. f8.>X"KFjXfL	Zhmfj j9w0FGu,FQ I	d$s|4#K?[5bX&4m|V^OSl E/G P.x=w6 UZ}# Kz1{@w>	R-!5/7R1mej lZJ|E!h kB)u,RVOg"0hd18Ey&q_K4@K1
De;, np	 QL#X&!bV7,?()@ H1 h>egxvCaLlTedzZSm="- `<3uEq ,S!Q B PYmZ[_3+3X8Zj [	X0z{Zz<SZFV5P, -IHF:W?#ZeHI [Z@4b5cdp WZ35&	{#-3zADGZ W-Yxh:qmL(d {;3,0_0X Xi"~)@;y"VxZ2!{$WK6#" }2Ag9" Z0cu
C  Wh^o4[UB]hT*	0h FP3k?Y!XJPOfD[G@~5)Y	m%FN9#nTxX^x[G2j C==DA]	8 4\ Fb]soaOkC!!Z_	tlo1"gAj7LH#=y;D"H$D"H$D"H$D"H$1+g>ey8>j9J-y@7mZ7{!Zo8~
ly?kyn3\}9{Nq`Uuu3bGg+#(QY|9#uhqfUZU3R>?ad$W[s*3_{G jFj7qVLmnX5hEf19@P;&3A1;j2!r0 Z"'.><}D 5cz+3 keK^ :~kjl-@oGYvG-j,CB"L=(lm
 3% P1 ZrE[  u  no90X1dhmz5y>>b~K~lQREfBjvv3}hFt;"WY[@ZoX^ [Yfm"[Gh`!9w:5yy2@kB7&f6#&O	~?21<[CPrZ7? { Z}Q@K|<Y5@b of( x=kOuVYq M3 hJ@DNWW[XD:,sMA,' F^ x(N@m{xx}KN@o-ef-dFS z(C	ZCjP`FM\B
@4V{kFD <D mz9HZig$_jQ(-t*gf*h n98Za%<T`-[33Q*7#qx /BZlo(jff,5s\Hr[?aP~E&LvYbxdw4<JfpP(#Z[~wR 1"r)C~T3@k9<@8D"H$D"H$D"N@ROz  2Z[an<5jtb{xUxVH@lddY`j' BlPX=ajJ<^se_f'EDsQY.EUpcX5 aTi	6CJ-( zz}=	>b -,}6' zZY6k6BF$N Yix92@Z d-Z?G%	%j[P2(GJSd`9VZOf$V>~phqI0VL \lqLceElVdGh @O2v{xu2@DYsf Ou QK/68	WwX6yK#n0XSQJTR#1cO :Q;vtIu="09"oN=>G/}.!-^dWmB#Z5 B2]H@o56kD@ hZMw,7[Cdh =sVkzF< mTS hnEd5C%4D<fK[3<gz'Xkg H}F@JfVD<T 0@&}\o(b
\1saMf mOMI<z 6RQih<.fZT2A F{.Ef>!0FT kXj[2xi(T]k5o9j& sky( $A9hh0~HqyF PEbqo+BgZiVo@k /D3AM#'i 5MxByuD]O'9$-L/o{MaGv"e$'r6"P
%4#@B MCX voA_BYhMLQ}XXb5F:(ieLj	knQx4(Q+D P]sj a9g(w=3nI=B#
e05=X~&z)o=w)U[  F[`i	4 (2 _+LEk,=Q*_sZhh9ju l FoZ}b XZD>hFT"y)V<=h,
XDF<^JN@ f~<CVYDVZ#]@	^:2.|(z+"Jj ^B+ X&Lt&R[6'/9^k"+V?@@fQBKwMzaIH^M^c/YWj- 6m RuS.8V%dGPVB$oVEykyQ8
KF`Iy ,k`30fR^S` PbhPlY;z5v6 Xp/$FjD3XjdG#= cVb$UYE"hq^@HvFm{1zn! vc `IU q[&@yX?z/_CHK
Tit l~[gx	U[Zj P3( 'F>FU["4x5%oCl S/ x&L ikod<*
MdezUR_"}Dk @^ubZf
Xy2- b0f-PFh-I @obr 2Ul[PY9/^esFrBzE rdd{ty5rp[MrO9+fR/h =1(Z*aD#H$D"IwHwf#gD.cy8fzdtyrbZx6[A*6^a5^i}1 $gN<CMQ{zs g{j76SWhc1?=_ZNX z =@!sXy5|[}&gG4*@= z&"G[! V& ve2Ch%S84o`5:=U^;W$VxO:e P4-  `	Bfi qmLPN'^Xb`\EZg ZZ>3VG*u#TRz[mVkmF[S{N}.N1:n$$d
 @'cyN5Mmb!|2[kQeGj7APU<S\k\^_0fAOYra=~=h-KFfG$5#%i}?:
d X#35HH/nuZ#-G?;26V[F~S /ptQ'oHV~R A1dj*5 9'? yMk Z:zH@]Km	M6dX:km!h,0| E:F QS:FYF'@fW+D4vH6R~X5f]k:jXQ.eX5WhMP`D63`y-iS+G rX5I0Nbh([6"bZ> /*4m(H$c)k8HD2*xOz#ZVNje4
V|c9[k8dk<@FBh,sZVRH1Q_v)fOzZ|XsmDf9FY ,cd.dF&#[ZUP %Pg4cr ,U?kBYU+~V*% tg+e9sp
JNj4z(PxHQTYjNZeO #+ ]hD/cW 2[1VI$<gU Ts~eNC6\tPm9F\(=ANiOI%_&yO&3 *AF#$YE+Hf"y^j2,+KOD]gZ63D5LE4G*&MG[3V-{ o<=2QQy
rX?slMlFg3.0skuDkAl?;+ STVSgj:^u"T{jQ-WsH;SDJfsVd#]%qn;ukkW$D"H=TB="oMT#x}G4.	L5 Yy.uOFStrE*U99I#Vc[/ej#VJA9-"UhGfFd^g@ii7tPkf\oD3]z&E}GRZh4=\F^ XRzb-4?/K>`O[KjO$fD"`] j-`J%G 
Y_,>wu*U~2z J9V{GZcr2wEog+t	=]M6AJ @AR$Za<[-g(Rf0JTj H:oZgG ?4T;UL58,GnmZi!w--$,iZty 16be9lrNVCVB;{4d? %I;V} Pg+UMVO3cX`f3 hFe$4X| %Q3B^g+.ucf6ScD@R ?@SG4Fn@ |o:4r j? , z `(~VurQd#-8	] =?4ai<  M}fXLYN=^Q-Lg+
x^&R6 ,/e'xw<hTHjel O?w:4hpFb_@&kXN@{I?-7Mdz 2"dEkZFdZ}Q @V|"YN;	G]Oe%xL{2YK oE,"5e"@dH"NS%2Z_$"kY^l n PrHYB~	G&!CMe8[~kT? `ylh$ SV0R5pz@[>h"_IL-gP2z(nw3|$:7c`EE= QVp3M=&DiLsK)@;(@XFbnkkn($Y ]k{^hDTA Q 4Y$x *FyIBk1w- M@{%MX[,QW-3u!	XC4_OVjDGA @XuHD x+G(2.ik( Mo9=hSun}4WB@Z4b5Y/fe,SP[Z=+PMYgh'v`Y_6#DvV>@wTE,-{1Dhjo1^Gx~iVz% iaYi 4O# `D~y(J(AuDajbi	exf3fLL-FGD{ZZQ+Cz|eAx5<+;{ IpF:>rUOHtDHBE@kef1C j+^l]eSOF+GaYi8<t*[Z@e7^v)_sD"H$6u| p__\Oi[5>[.]Z4WN>kOxs{%I_2g*e1L83 w@D8 @q/;P"P/` J  p,o~L+nMv.[w}i8U_@xK>C@qj*xq<d/ah?^@`_VT-@f*d  `u{}5h
wo2)q0AHyy<r|&|~& t*5Q~ *;b pl z:~G0r^@,  )AT(^f{AS2z_2xy	}HG J} 6  @W) P#	>/t7Dl?#lJ^k%  4pEkxzqs`~5U [?D/1;"  e1 ~#j{t!-@K>zGMz[E  094OW/2u"^/u|5'`=]& xsKF   yr>z/5d'=!?]Ac^_P@	i5Uzm
wk;{QBu |s/Inu ~N @Y]qFK@uO'=uE
 7@Fo-1$Y(3@i(i1~Nind:kDl"	1fZ-}^oh=k_s h5` Hk`XSJ Q qV'+gX"Z^LD+ 4' C/I#NR@`iHsft5e  pb#d_KyE(5 e&QIiZk q:~:
5&G>oMP-f~
=M4 %(Q G\F4y}dhN>3 %E*"@ GfE `([@-Kd9f `!h ZuOYX odf	 K"#ZW_,+1z[o%[ 
w `f!8Vg?J?@Ag P+.sn {
P~BEK4hPGP02"dB494G5Q%mx^(_;43ujA8~/3JB~V H;G><J$k =].[P2f tzkeYVVY-Q3mk.IV:<_o	?/:`yQ`Of`e|(T7R$dJY22<XRW0am;h	7 o94jm@^j-1m @<~VckA v`^~!HYJ cy=(@aDHKr^kUj % L_jzOI 8hYr p. ,o't\|Y:5z<H{X/d_	 hDla/=xv_OTk^ M HHj<iHA~ +5iM" /L&}s	XoaDRLTHpT0: W}65dx{?h
t{tyG h?A;8*vh( U4y GAF?	7E
f@J@BD&@}[~{Y0#@A9YMPg<`D"H$)
/u9^g3+VnA+^#3OzzWz'_~O~Rv~0<>O  >`]/QCEktR?W|s}s9]f2\Gy2bto^Ol(~ \! 8^2gf<! Y+sg1|G?@  X.K *? s_ir _~Wk:5o`r1 (5VC4Y!J/A` <^%Q (^Ku\2|'~J?^>L(x7Tv; Z>>;\Z 0/j	?A/IT}0g0q-%3fz- c[5]P6% @`5?3S()LHfY@cHFZW>  1fR~eRG$&g!-??^^%r\St[]_5+?jC<G_t|)FK`jy	>j `1!DA[o dnv6D2='_M];T  Fbo  Z-?V 8TfvkgH/m|@v"z>/ h/t'U{oyW^ J{-h2?$b- pq.?o4X M , }dR} 9"	FZ&WSE Q,`P_ay h~Yj V@3i!N=;" @~5POi{h(nIm9#&@L^9"/R p0Zz+U}@dZG6e,3@;e|if/5+  &G32 aLh(4{W:,=}oT@&L@_ /~M 7Z/, @/S5X~ `l+} rMd@d`3=Ji_6Mi	qIKh0tR[ JfRtk_ rZ%x @>oQV9;$i?zXh?@T{ H/- P5s[RO8k Z$;r!"Sk s[M	$hV$},pg @7lk+:hu_Kt@#Zu^/R+iLF-#[ PkZ*L~&Azf(EG@$c~`T;#kPz.S j=Hh_?$96"I@G| GT1
`Z3G!'j2t(?x&h_@g=9}zq{N=G)D%Ck[5 K?9jrR@`Gr"U_C~ T(GqYk5  Hq[	 wV _	 eDtZNuVP2j@ }_CTJx+T>PU	9n,r@Scf+
{KFu -!YI 5DS)Zo#%%s%Xj>^GJBHMG|m}5S~[YQL5+7@;0*H;;^e6a Vg}0=O(,kj= (Uh0c1!	(k 9D eb[! Y3 rL?^(taNGL}zQ_^EF}#^s:Q+j?@1)X:(#@` J P22[*?PloY#
!`h:k Pe 4xxE8(P,ZAaH@	 Pj "(x P T`m:H@+ X	>k?H /m&@ `UDr. RMShG@KLyghD@DG4Z(OK EP&X PKek 1I@=TZVFwgHV :N?Z(D$/Tx ?  eQ2bG2=	e[38r! z.#ZmFAIvm&X 1EzMx~ j@uQ.,Hao?#aE+;^@;4` <?P2!L `Q5~t$uk$:,3jf^X	=W@o)
FL 	^Yt )W{dT20ol_(>Z7>wo-],A nz5-2N{L "J&uG/mQiD+fAAb&d%504:tPD"HzG9WvYi=sf<?}2sd yv|/#O}rkIQg>FZ<-wYwHG}C@WAf"F?=D" ydcW!"k8 ,>E"-FSql[B}f.C,$t#eAM-i@]>Ga@#^yy5X =lU}7z-@^-2'^-G Y >@Sk?Y^DOM hFMBZ5  pEC= -@/ j5^o^i=&=@ nB$<5bw E	lqeHC]Y =L@/6K} 2C#h @<^)U <c rlpS!-G6Bt,p	@Ye K(M}Q  'E~ < ,Mb~pA} e?z&D4-?XmzZ
@ Z 0<TY7O
/xGMw?@(`VE| =Q P[f"zEF>R"=9@P{a o8a[5d&Il@	`r\ygdEzDu$')zZA<m5A#[3E("	K/~"'6*	#=~<CuMx~'f="sGk3zmkf1Z~g3'H$twQ{}~uzJI_-^Y_^pyf3?W:zM*>bh=heVP]>yt>}Gr##H3$[FpYW{a7 6biJ#|kB-0$$h' T<3pm-oV]  G$d| lo&GGJz#HZ-@YK-@+ DVXtc7 t
R#P6GJGA=+>~cSD+" p=@ HM$He	[gDZl@${4 ] 5UL+{l )J~GA3$C PkQW>%"j%YR>Eq:;} ^(hEgkKk>6jJ
 y =ZQUu1V3F-| -ICwDZ*3 >	8?	x=~l_kjFDVf?0zZOY=To>v{`u=kwG 7{8y4/|t_}v:e>&H$I/s{nk{eiey{~ss}:AauE ;Gy>.$~f-5[g2gmm}z80 a:Xg "Fth1WoQ:ytfMBR "BT&EEzn*.- P{K^|uz1{om[L #9@}o _3_p1{op< QZ_(?@' qQ~f n y 5FMp"1Dk h$ 20:7u mwk&@1h=QU3 P2r$FFk:f[/Do-aY Pj[ F0`09 ; 81L"( x-@02s]lL:k5Gcj}h4TT1ZgHZgF*3Hp&I[)fimF"D=30_|O__:5tL_;=zG	4-g2cW8OQr@=~mAljyG_;7GWPPL8lVx(4IPklex]Nl*P>Q@Bl& _uV @IjrGRp=OW#L[F %D &5	oQjLXccDt&  j2y DU<0Wt{ezv IDM@B([{, h-U@f8
 	1a< ?g@ zQ U.}= xc :Fl5 ptG zp&Bm51YUXa$y Le0GT9~	A=x jA^ Q!bt2F l3j6mB=>8v& U3i13L u^h,'Pcd-I1 gb =QzD*kMy=<!+  &xvdOG]`2`
 ]>~$/z1 3G!UAfJ w~u D8>CTt6Veo8FT8YNB?P0 b?!_|g>iVj;^BZ1NRy<WY9/VkVTh[kC:^yTNai}q[-vlT-05hhUC(\}_{mCc.:yF~o%YRrcGhFaX	E& 	^7`uD_tm1! 	, Zk&j~4}hGVci G>ANUOi$DY dikao Z%y=x+ `K$`B1k0"#dIZ%vyk3~koUw-={a=/ P5FR=K3#/T,(ial?:`]ca~Z% `_ p+#s3<_W/@t6gj ^aX4Z3dnX y= SmgrH#FlZQ x PNmsu@@dy~ 0K Y `%}QSTZ& 2C %u O   4r{_ "%L  :~' ^(hn@m_y J$mo5j/4]btk>$ 8( xy;yu}5^[V0 XSVfSM<a4~@mi@h  Eh ze :Ow(4X+oy5 |ChJZ0  4vf @y"C`@k# jy 3iPKz5 (4^?
 T,M $+I%B/kbpFqV(+@ bl 1[hA	`	'a 5'_I [z63
`5 Ouk>'ev qzs5Z](S=f0_-LX= 0x:`G%hir]O7jp#: x$l 0  ~1N& xaBd@P  @)g#gJ@4	",&@^ #6"y+L' @I7  !t`0
 C	Zygp$0
 NP9 	 PTF R%Lh	)U0eX%XZQ :
g `$* `$(
 { ZygJ  + F2  #hM:=2je&@V*p ,_@D }!8j Y=&@f*pp 9	gFVvI-|g*4)uf83LfF`wVpW9razT`6aC6yZsE|7k	a-zFB=}#=,%Xj	`VSC@61)h[m
ZzSA+MMAkm#m##m#g yHm[: zGf^xmGkD78$s0HV 2["a=;$:~978$4$:	Z& yY7eWmXhOc`[zCo}8
cAZ%mGFU=x9/nd<8D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$D"H$kH    P                           `$"    IENDB`PK   BGP  	     docData.json]o0+"61m7mU M$~S]n"?=Nd?l6-C6&"gLE#-ts	y:Tu=U?Qesnz`!NWnE@oL>{MoH<kh7muxW%4]<6|sEvS v\G3VgAcMuRi\~%,r1d<238jyVg4Qeb9d tjL,V.1Ig)bPD,O#}TP$">sPAg[Bp6%4OYJrIKM)hp/yli!=yMJ& C8e"s%Q>cP+D$"	"
o	"3G9s3G9,@9,@9,D9K,D9K,D9'9Y]>IjtcZg]on`fwmo?u:kM;Jk7XL_-7 ;^Kw}e+,Q4%DN<~_j7!0}8C@n[g\!7PK   BGPs  O  
   layer0.png|uXTQ6')Q@P$G1A@iP:$B.%a{{]{_Yg:&HKC @$ -^^(UZ HW{F#Qcz,>K9T%EsY1(<%[PCYCC}?P+$52~p;mmkmsbKrIlBEubXfvYqSV^KVwwY~$W&/,6uAqQeEkqmkMeOMpxLE.`qhx~IdsY"'2O<Z$!Mx;snrJ{"iXqxM&Ct<bs_S56ln\aQ9eJJ+hol8P8ywO71&{MM	CC"E#AX&&fS_7~7^x@c44G^,9gr'}X*apm5R!N)n&~!ype~WxY><NG}&a]&^?JO&&bGg"qX{Ei ~}uY*a#3g111Z~<V7s"5"42o~C_X[}Pqc[P&u>lRWe2}8sn;-X	ZyB!PpQz*Y#5~9t'@9tM70.&uc{6Sa45~|n_1.S.
J#r`t5y9_3iy^nhhyz*`darX52p-cK_ Z{UoNs%4/Oe-,!_;'\dQd_91l^Y^!pc@Si%_2Y)ukk7lot#3N9.=#%lG#17Z9gt-.SVjzEK1mJHLK51#kZ[kp2'2'co|t;SYX^_;5xl{m/RLR	|B9$N
J


?4&UAc3]3DHDV+?%Z(25M1Z=Gh_4MXu=oE/xs2?3(qoC'UA93W~MlceYKp</f.".dtfZ)CibD9'GsN*%T?$=# ^}U${v|{.N1]1j\UrT&FPgF(,9xk8}0X3PO[oL,}_'/h	{yhxzuGdzczs'jGt'3s-	PJ+C~z9
vE{J%N8'xL{M`zG)T"Wy@Pn\U)faXpdtw-1R.O=\
Vx@k+.C]T*a2tb567r[rm*i`1a6gm4Z: ^Y^!t|R,mWE|S<!nD	K++[M0|19a
<0gM$`o<@Xg<A*JJZ?dZNs84B|5]eV5.[GKe|:YE4#&Yx ;os W
yI2&Oi0<jv4FwW;H 2}:s| j2w>syzvrU.;r+R6HOs= G5QI[qz#U2\i38`Q	Bf
47 D:MhzMc{h#*2C6WK?4%w37-c
:+]\GNh1NL<ZX_::Cf>a#~+Rp'L/?H>,

(/Dl8Ut29qJrt9Z>*yZ?\y|9C5QIu&	87,|?izz|[x*E&bC,]L-Jc9J$=`Ua!3NeE?Y[y{<3;3XA_PG<^O$c.IQ>
6QLyKQ<IUCV)R,1DN{Y~*:Tj%lm|8!#_m\dnBy_XU-vW1'y70y.3,gS!&}:Bpou7`YfyI`rsK	R%\yg<!v8U_0L[EaQ/39Hb<muiHp	U.cJ)U9Su$" {9G*u'tvZHY5J_$0%(*G(?k@	%LsP]J[1rlo9	8?w	3oBKHT^|=MM\;yqrpBW47\i-TN6*kEHEs cW`vu\)LT.q|uKB|^i@d+Ibn?j[M}q~|3F=8]uS
KB+t,G`KStK,~95J$9y0YTs	0XwOD@q+};^3kWqHo6%9w2ya1~q,\yfz$	& I
h:F^hqq84;=Z
,cx8H?2+&14iY"*z1X~q*3{D
4%VjX`M|k ci..CCh&voShz1Nc+8~ KQJlCJ0l+^ J+Se{qdj\ufG<71gf
0[ Gz&>)hw(q9<W;Ca9Tk~u3:548_~["(~]E5wrqF4Ir&hV%eEWMA]Mr)jt^BmA	\YA3	G78z{BP< "th+hmRkmn!O&a*xI++]ER]GwB|&u)g6>1$8_DS672Lbcz|Kc!:r,@O`7*iu!+Z(a
#`^pJkZrQ4!Vqr1-nT.n!g,A:`Y1	o7]wIAvC!:yC!z/zd B-8n\}S S#
EhR[8"Y{`y\X
6!|hq>g.=(r qjBCWs2vIB5>-[>b.zx\GNd+txMg^YnK 'l-si3t^nHh#2}pJ[MC:jMlM]|i $`!=jObmf^ol\3q3%SsC Ty4CLZVp`;mirqDSY|*z	Nb4a0XBi0 wR NGIo\<?FcBdOnMmN~%1LNTm X!Jk8|*O=j0]F	X. W$q/twSOA3hHaEAp$(g*#Tq
13PaQBj	ra0=1(fV^P;H(9mU8:mQUaVP+I hJ+Gc Z\(,1B^& hJmK}#V]q`;Vl_Xvi7Y2+d_N[=6ZF\As{
$:HA;BB&!kK=?r?i nSDkA"|TZBGGTgS
>Q![{iT>C!g'y%7;gEe^+X9l,=U<$CmJha0P=<!O,;tmE
2>k ~kS.ld^$!ho<}D2QiU8$yQ=qYIxw
;_Z vfAw'PM3qgA v?~iL?uYz40z.? 9}2QP_I|=QAkegdGP	W?[B duA &Qra{Q*P%(uRR3h};EOd)~0~}>}$zY.7E<6ZTC	#-Z!"9df]>~pXDQsD2Qt\lZy|Ze<^'Wzvdqs ?%=0GP IC{74HuI:@W
E<%9i)2$2W !NbA.oy{g.p\{{9DA!NxnTS_7&^5:xMu]jjK1.q	4ScmPjbia1n5H;6pw=N,ci/>k;$&>l('d	
CwjgH&YWz*SH`}P0W]L7&@N}x=zLoMqy)
}J0 3K	d(cPx_
{1MTqM9jZp"m9,vuu]3h%A6Yxn+~$U}.	pwv`c1,ko2Nj`{tl]|)"I&7
1U*YatsNPGSa~?^KWwLfPQC^BEEs%aKgw?PySyp:WKwww*+r)4<o~*m^Z<Lz	)UI	"(u*ZGQ[IJ<TRnP!H!0#mgP|L{om)P\Lhw@e]8.2Z_dWPF(e%eT?fbDN)-FikFkiW.Kj 7lEPr\:&!0K2%]A;e{NH]T( @G /37+CP!-{x=?Jxmb"e;yi*XU[hIza*DDaPAb+ck~$5?(0xg>%?c`B[lHTVFf]v@(
502Jt@<Q8C#:&WYPp)Z|us-dua?).{66PUiSsl)!O%4q8<XP Dz3VN#l
LJ7zh=~>R~<	MC[Q0>	/=A1cvO _Y?\KB+90+nM"$;Rj8cRA>mBRS?R7?_0qD <s&[F@f|bW	+2`3GD|WG@rYcMX]1Q/{XXMP&RCf;ckTBf;}/!Rs(g~9R&iK@py
ERb*Mv'mf]/.b-:/weIF.~kiH{r(AW t|sUgA1@)jRIj}95[
x0}	$cdVI~9gNTt	+Q/ u3iJYu@:l;w qL)n-/SC(nfL7\#!yZHv#"CnSu17iEC4#fK$tf9Tv==Hu *j~J 
uUIemD-x+h-@%CW9\yx^;2~SaxW}f+%#ikVGI`_5N }6eo|7<H1yitp]Ws"is!#, ygV86P
'!d"uP}]`C|a/ol?NB[',%4[fB$w!Z(5Hl:c/0^' )9.t{,E2sN+~EQz>;ktk(Z6jzIN_fS&v}f#;5g>S! GrhuY;|5UY}+h8h)L
;"8V#U1#I\}J-<-TqL?V`\#7(d;Mi7>qH-J]qanuS3g.FYnpm{uS]i'QvUD#*E=M]'~"#!"x(`N+[1YCW_hK;\)LH0\Qf"TEhs^dHK&~V2NUVQ\:yCZ^!fn51Kac$_@7 ;Xa}lUfl[C	6y\;dpC#FQ }r{,%B<us7jo&OTc?XR!%>{0xmQWIc0cDj&2&,,uH5OlQvtWrP^Jn\_e-}T!
j\hEx,e0s??M	v&\+eH.&W2yl>17h[]fp)tPn/~l9|dX >(!"oETHIOm4\{P%([~Uw}.=v$1nDM}Yc.wH2\PVO_RitO;Zmxx%UmC"S>%tEurR'iX+xtwD:<Wt_furD".G-A/967^|w5~=&a4nMX8AY}y~077&%U)BkOX/B.V<DgKqd4!]/ +1 aMux|TrYi[%Mi@#0{F!)5_uoYrtV}*&	%n%t 0!ER[K&65U#v*>+BA2E.QioCk3@V(|MLRQuzZ_mJ$sshReDn}cki?c1E3;{mS#[l>o9V,f}	l(D@*Cv#lN43EW,llUj$/UH~nP }+%}gHRuL~a Zj,ynw}dy&/8b#I"|23!/9!.ycDhNVI&%EKm8T*3.GZQ9y=v!T2'ZHlt"9i(-*"LR 6T-=z)a+F-F.y('75\"
><y$W	,OUn@nrb:Z_d3eo!/@'VOP6PF3FiNx{	BX6#vVC?"/S^/LGZy3ewL=lw~jF*"ooBnE	>VH1s4C~tD~#\sBS@n74"iU!x
 9Wz~J9>Ct(_Hvnq\
:O>eZl7DP_vfk*nm1Xy:z2@O~h)\-<y3p3CZ54lC B1v<l_f]q,;bvd!\XC%D-&P&c< T0^<pfe2v7>EtC*33HeUyf3
h!3F'$2obNYXG[]A/F*TlE=V.M[,KSM
>h$
qe-]1{u|Byut,w[6Xy^[QV%Ref4=ym1}23t4ABu0gFGZ
_rlXA?#	|.?RG'7sV.kep E!>kt;H!$q3:yrDkHR:'0M)1Prf2]&Sk0~kg
^v+N^"\q:uQ!C3: 2yJ CyG&N"Asbvfn;">in{8G`az`R F$QA
%|i.T	w)3\5U>}Ao}urwA1k!I}&ND&D0+~<}_+6&_hP\LP0nm3qIy	fy^9+[E(Vjw.hY0t V
W`SB>t",+mx]&
@Oh%*+&v\'&(z0\NISx+~Njmq77w.M7Tuy8D5RHr=I|+- &VX7d"UnCQO"~ifI\vsR1FbO>a

dd{@K'`FXa\$NVV+X,u2H;M|.\`DbSDR9{JgLgKRjK1$2:g#r@/9O]z |7<>"U^a[iq*<]icB"+)g:{vN4T5y]M@vjG>HB'|]}+c^]Du5f}:C	#6o*BZLAF:6 YjxBOQUm
 8v%T>:IoB< Z3FzQ.<^{uXW=w-}#5v	[{w|HSwGu}:FV!/>	c-gYRA?%TXWV=H{l^"C_>Jsn	u|IySWjY\( x-N=.-=G>Bg|<]PodPG$ZZewt`BZn}o*uW_`+~|}w@uU'R#tquNs&7{Qf=!UcC|YNGDelgxq{})?-|R!w|5vS N4Gv%<Zr{>',,: c=3.kY_(t >C$]i.FTmf-hlslSn`2(sAO(G[	8LlpP#:v/J zT6!4A)["0cZ[N=4 8J?Gg(22(NF6uv.v2mSRQ-z+@7S<MQI0'vK(LZo
1R^wt11i8[11yf}eGPML+qDBpuWor]t
vIp"hO.EufJH%c^F@1wQ^!o	e$~='X('P(Pt7^m|}i*CKHl<L[~2u/=G$Ep[mEZ^3?*R.^%
{B!(i961PQDAzv$>?L}if0~l_XkxMF	f][#.,NM\(}e@-ykc_>s,n_RO><M<>e[SBx`[.OIL(wUCq=;V/W'2E{[SMyVgfUnpO G:,AmIoKs}PI}En-yU{t)3"cm?y
`FQ-nOtvy;u\	*(%$TzJF+kd<uetu}~ht]Zpy9:nf=rkDF_4g&9#(e	w3u\E%_pP`,sya9<EvQ0YcCn$w(FzbZ

InY\52].Js3~^9,jJUYDqlMnEj4F:aP).XtFSE@z}?,?Ev'WX uLSK		t*LH]& PpxxF~xMHyGItes(:5 0=72E%@; 02m(DF4W[;}4dTdX	Cz)P&
d7*fy=E|,S+JTa#yB_nT!j~vKGGSLX%y@Tc	KSnHql6zi3;c XF'_bCS:BID6.{n4lHX/`5_|^Q> V#Wp	q03minGf@g!g!/|7;w\ PkU}VoMSV6^krZy|z=!:UqKv,A+n.!#v5[M&`_IxDXf|Z,rljKb*+bCKvUY3mZtn,1Q%t7]:S/)>%>{
?">^~*Qks {flP<h0s3Y}L#<TA8@C_xhz,r1hf&0N@k\tM}3gRYBtdRDY^Uk|f$X ;39wM*	 GSI
5NQt}A#
#=y/8wi, _~JYw' A}(qB
C<+%]vfZRZ(,iKpqDbp^sVPHh{o}Gn KQK-hUz
3=>-	&vP%~Xzye<W$8$Wm8x':-Ub7fF#o<_*EeZr{}{>~hE.N}_  B4:ji4yy!]=	u5|],4e 4Z22v_/AdF=eke>dD_^-k'NDU0zvG/Iy <E`'zyE?v/Yhp}Wd^*?U(1Y#-bn.hM,4qIz
2ecl~O;@maUj*fa?+`hl=6]^qp?3p'^f>\w%/\fnn-bA=U]=_Q
f?+*
AZAe  T@/#iAM$
,h%R+X[tBi1x`L9 v!6)+an^NF.25 tleG	:: >((%Y4VZ6_D,(Gj.\=1ElKw\xTq/?.j*i2yK#C$T,L^cNWa
-$Er_9}KeQ/X_U!*b-vV(C'iI$7w-~<vM0:{Kj]kn{6d9vO'N7_q7`[Q`^IY?D$>H	2|-3GL'7"T]#~T Mog9z]T!Po-6|KfA#{
8*BsIAt(z @oWjo."<3lg(8m[|\ff_)X<uS]cA*JTWEHG3a&	p	.
wzs-\rpfvI`,0^HlO"_
FWbQ33sMlN*Z{LX*+G}i^D/A?0|M$8kww6<K7N%Y ^M&hmJfS_5Oqxs* *B-UoYII:*zV+p&C_o(]u}GA|
LXOg}Y"/7;gd[fGK4wj}
5WaFUox-1#w;*\]o&	gPJ;WzBt4x"!>"{Q'Qy2'`r2`[jPwt+d>W?9=Ih4V>V##(HGjq)ey =Y'Uf8qVzm=/uI	BucWM7K{[H6sG!>+Qmpbtq:[q@fGm{5JZ?$B> UW[)f]ms5P]}&jN59MMWWACF}JdWY.KcYcN"
c'&P"";1,e=}~\s}i>d]:\2Gft4Hwtu1_?0	&uP4 :>(^1|2AgZ aTXqTWUu C+NzmYip+(pP}5e=dp}n{i*tBO*`WvE4%NuEZS3BMh(q8&-i`f[KKTrM4'aJPko:'U7Y$"6:5N.(EeD-9A!4[90Pt)ZV--#^VroM:_Bxg#Z!H$YLcl1-hPXcQl6 !o,A.+M<XhD5Sp_;	&/SlkTajC_jzQT.x=<hIgH\.{n`?(j0Fl -jcZTgQ1&f<WeT!Grr1EBs*%,a+]ai0
"DF|z%=p@e dL8{-:RrA4.`: 54R<f	Ls_0q66Nb%z(?#sg[*/ eA4(;eHR*AJ%rSxB_@F0"&r6Q;;Hdg/]tPP,&s&\at4w`O"7FbAF\}aW}o$gIsa0^M)Wz+~mtNIi
iUZ;R[uU$AbHe>5{]g	KUTO=A__y:&>bl"~`*mb;MC#-}z+!4!w6`gpOOyy/Det|NKVEuI~X@PDRq-VS5_t6=8Kch74\ XMiNofn9a}wQnk_P/4@cXw("$5`!*pRJHrUBSYsqjJ7v"^#XtJivz#D;+Pu<0_r.;N}RpjfV5[>~lWp>v'V-B``((%FM1fE{svr%{=x&=QI:#a:
[x"oEP3}(=3(,	*y3J-S~TQ_c\MZmc&U~uZD^sPu"bjQ&+Rm0(ZFmi>*"k]!o|b7i*f"a<2wnv^89
rn(U}F2kf N&I4b77\Xw-6oP"Gkl|p|b~^GEu`
f5)RB.^:/=iZ1i?&oV?.
>4LFzm)QvGJ35s<^ciJ;wyug__uS{Uy2DHf;8CYQqy	;)-5eB8}qo7b(H"@ztl,O?ta5:>Wnj?[>$=y ]t&SF)tkV$U=/I{5F2{2ZUssJt=$%<2Uy R5EHVHek
GGV9+0M7G[N/rV}Ugo?cdfFi>ejRWUi|i\c0qvvd ^[].P8*k?&D91/x@S+b	xt{!kK9k|8
*MU,zGj[x.
2>Z6	Io@[Mzu{tcC8CkT(va2Dab(e|B z%dZo k=?z5v.-~{e|[I2#^Gozgum4%fwSS_mT*h-K?Xd-vC=8r`|8	*Yy+<v;}@:Vo)7D4Q	.rQJ#Y}^Rs9iBjA]^l>CI?6=mhK:j<|V4Nh|HO?3;[q\7U>Y;)v	CCC5w*Iz?<9V3y=rp{}">=t(l^ xeApH#<>'VUhfy:qTp5A(b%Ud{<doA?wT--3C(:z_$ON*	BX'	,`!2;,;<o%m}0lZTsLO_E}_@ Q.L lE|W[Oq!P
g,wE%?osRU6APNJ5
	c"4L;x|J./7|Bg{._|>+f0cT_XnV]m[qM?5r#*8mSR|otf5.xx0%gq.D:nPtny;4W)#N|#vinq^TiN3Gn	^%fx	^iIoM.f9l<pSqZqi\Lev|fOj6rFK!Q Y	YE;j$3U[\D7+j/LY hr$xGe&8.|S|U'UZO=u[jO3x~XrYa]O2tUe.SX
k4C2p	)>1#N/}YKGMa,u/c#cC~?3j@_T,}89"d2~@cXp@
NOq1uKetTL9VR>'UQ|&FiS^N`tw:Orm!g38OLgBN
D`	x`wy9/Z%78w-  39{}5/TrXUZ P[^Eg
j,?",ZqY
J[['M8?E5#HmxMH5mjREdC
-zAFk6&0.U[<Thc@9hO`tvr[vqLrJfAo;XF_k_]a0;^;o$ _`@j\ym@+Jp-!YE%?pXBMq+F:(9:<6]<ZReS_ZoCZ'%~m{zg_\aS1D>)1*rXpI}>sz/M&$Wk>	^[=}OwHPtE<DWBw:s& 8=9;r=a&!|O%52k-MrbW:}jL'9Z 8
w% aiNo)6o	?NU4-/:@5b-E; NplZjj35/,6UB0a`C\Q;tlT$5jd;N}/Pa#{>:~$K8K8uTF\[)HS6a)
.}ioHz.c|0<7?hj!v9A|P8gV/@T'n?(;b}"8m<[P^PkshB$wC\Mq)ohw  K^O_+ms@u(	hC+kVz -ih1V?2 T.L~zuvi=4ce`);{P=(V6bBC.!
Il_dE{|RHB6+k_	tDmOSB&i3P'PJi9U-5:E\RWT9fKa>KSy9L6QO>Z#l[T	>v>}AgPR8@x!=Shi4lqbi$1g {cjgn{lX[XC|5ROlsGJ,	 ?;kR9SSAsB5X%;}ePBWWK&{Ynm8dhX^C1HhX/Tu>fg}ki]uaf=3B}c$VglJ=tlF>CX>'D"DCo0hG& G!,^\SV.!0rB?`]|^FgRP!U'	\L?%Uz%$e3#P	o._W)l[3tPVMk
Z nz(8HmcHcFC@Ps&,u 9'~nP@6If;Th2(oX&?_#U3`,Mg$]H?~;IE=#|Lz	zJ;\@StPf#&eNT	SliH_}^I-zrSXET+[`'WKz]'ji::u NvFPk X
<?8+x8^O"I	p^:aL[K-\"Hi9Cbk@SVT5Xq\lp*$NFUyID3R3T2	=y LZz]""5E|YE>A8FBAYFIRsG=
/p63a"hqA-x&M!};n f3K\D>X'^&.5epvxUm;\RA1}X-;AR=CX}_b>'.#Bz>"T i=[\2NZOO Aw|TE(v\Wj=9KmBhOL4\&L+qb~t 5D"m _zxoBF6S:$5R:Z\z.I*<VfiMGM?	,v$W~9
&j&C_nSax' 1XA<6yb(aJK{n]~ENb`a%$(Nf?fcHuTGdoSByZXyWlM>k$m	Le}N
H"jyq9hrR@H<uL	R8OJ8ZA .aMq}iUz<I<hf4+ijT\hVe!Z5vh%=6nU1DA{JKB@Qw-u2vG^#l2gGk,	")KjQO:WRzy,~)cX8q2'BTvy| _!N-iGA39j'n#1-Y?Zob$hb\[7}!O	3	~, 1hEwl7"d!-n."o*H;|OSv'nU<p(Gw!2lQu&bB45"c\{gzQ6<.Kl3@H"06za-P)Ri3?L^Wkm.aVT0uSY@|:`.TL(C>UO;G2>%fn Hb|f^eJ6j-]lc}:ZQ#QQ,'BJ$E=2BT@TQ`,%Gs*>rr$jcq||m;7}MJ(%"E)QWap;Vk}zZrRR+|s^J)[	C~qOG,q>Ri
l*v0s2C	~WB%ghXZ^I>\mU\p\>9oR6UkBiD$i7\1eEsTf9B;_xI-%X%Q%a-+;RFsr3E4alhw{O'n@|2gK6\$l8'_N	j*D	md"XA]Xm{F|@E[&Rg=+ajYvQ4+@)-cS&~cK}A5?Bum&iDs*lj QASU>oX:eR=f=lV}Q=J/9i-uUv[	Bk
%7k{ n	K`mSzlmkGR!KKH\HY15ZH?pKlbcAhd'tNqm4re"uq~VdaXV6NW2.*HWVD(u\9cr8XK~A[ob2d2d;\!EQ8Jo.!#)o."^~s
!aXx)z^Cr:/is~z	448l]]F2	[Xr8u1]*(z#q_^G?.B&JMMw%^R+cZv
T-?G7 .yb$A=<qs~9=@Y<cL7w}$[;aQNc`%s7!^z$3\.i_2HFk`)Fugu>2/m1<r(BWaIOzbv(5a_
eU~5_Q9wn%pj}$Vx<q<HuL}yOQ&F0.t8s?xp&\XX)f%"BVG8AFeEd:>x%dy.UWMK"AI\UP:_wq<X;w,,C~Ns }VjBWg?|mdT]nIp=e5^%J*P[`GksL	gr*#=
	Re~iO_+M xf)IBS[tej\*[s%[B60`rbyVNb;^oI/
m|B=l2K:f<Ac-Kf72	r`vZ[T0#J]'+wg3zv^[Ry`SGXS-:-g[E{;k|dz#$5)+%$76U2dXE5,QC2VGe6kKc,3R65;vQ6ZN%i^_C3=J^<6	iC9+qc37"e@$1Z,PxJ!TT*uue<w@-_PG;TFgB5[(BYX`TBsE|l(!9l:?yTk.*!m|e~Zjd.L<|QQ1A/F-fyCKty^	#9PO1J;kvRPa.JKC5\P8%IK~oe`NjWNh>O'UTfqTB1CHWw%q{5yjuY~\%J*@pN.}\@,+	 =&wLwMOZAL+k:NhM.qA4Mua\W%7pl e;qqj	gM[TYJ(o'kNq`@Ue\FzA3]&VmcE@gGngw#&*%Pr"j4!(Q%!0TO[X5(@(?2?0+YLz/t-hy%$hG7>{$G pt sU!8;fu)~	iNU$>XQsiOT.Vl9pPx3BKPd'ss.TzMx	dU>se"E74k~PA7uAj5q1)|s)AAiAJ
H
#^4iYN7xlr|A}oE+F-/fJuJz}HA0	]X`Sl4tj
}$QU&06 ;5n-d:@,\K#omNO(oj\r&sib|R*b@i~&V5r7:y}D!nVKAtKo|q7Br]Bu6#]f(Ia8Km pj~J}B!q4|Bgzm_e#o*r!jVYnZB/W'F`?K:o1ZHE@zN@s0 (!~h+G1=P3v/jbFXhW_#_e`kD-qI{pUck7N2~wSU <=i`	_4xJ6!57q )QIUW)TWrhrFG
Q|FhE87g__*tP")RNY(RT{<]h_
_5Y*
9fA_"\*[_&RC6*x!7V|,X-tcqk~K7 $uAk hHMA{yvMD(YC&7Rlvy[b
!
QnWt%9}pb?hEfEX:~%w:gX_%9ty]#v	!yBY?Q+d )Rzl'nw;gq4>*>v6eo02
-oIoNb0{4Qphks &M	]\"j"'v$skVU|dOEp]Vh}lZ%69<%kFPr/L|i;WRmfo;%^W<g|xq#y!Vj}~Md7[ON#WS^$l^@Pec>(~'6[RsTjlLvA9E]uCsq8sg>o>b3Kf2t)y5U?Q2[qqz[yxpU,`@z_EWSNXA ?1>h=\n" 	ML	svou*Dz\>(@,H~EehTSt&rF~-@j>g?7P9q8~ufiTTbv?p=8WK6;->RXm=p,p>fg[@2fNW3!e7n{"gUG!i+N{=Q*}` a}A@5R2B9L2b%\/o2gN<GUciS*)fcGi<)e1u`t)QWx?H?<QcpNM=;K5,UVbje8Q(1R.oo#98XQ 4Dr>@hv2",lgks!@z=kz[xO`4m~)$FvS	h@@"'QB(-5QK Mx}	{}udJ^Q0d9K-q3Y~	,|3wf[$ h,GpqWGB9 OB]T:{p4?$U;^:ui$RyKqP{#LNy]k;31vzs_(ReqFob1.chx/!:?r8\bO^ZU`N	 R/06|JsM%2jD5\~urA9"!dlW&3	[WU6w\f+aG5
8yaHk/KE~3~Huu:O4?{9g{MqYj?x?7s=KUSwv>*jZZ3"o;~5yOh~B+2~!DS$#hGk|W!M55
}w.j)?/.EUd~SM#y;05	Eg~ dT[P Z%#HS)qiK
b{.AV;Tb&pX s0[d=bkj=;n/Ni8u:
0>8(~]O~V!]
=6Qi,ldz%k_<qxY&tJ7!+D:Fv].ycrK'xK.3f]"FnW?53P!1`Iz8q|$(|{RRV;hddee!>hY1[1x(;AO=!#dJtrYl&bC&r77ed:1!`(>=t6giu_ETss?{c7K0Sq_MsJL,9rj$ <1kc< ~ 
X65'\$ko@0iHv9
A!
-knNz5#s<5
N:c 1b@T	Vb _W=T8S{NTV-Nzp9=P}?m

qjuHLL\nJX"Tt{ENAg d/asmPG%}-cSm:Y`6AGOGgi{j2Sco8xhu;-^lUY=?D>Ebiq2#G.b67{#ow8Gk`gQ"0d/S2kf7X21Jp~CT	d]&AgDs @Q?@F:<[ds2V/aZ<kJ	(rc,8Q^c]Ka-Sh\s>u174:Vq*=v2{g.>G:B5f#W}*hgnz*"0cPoJ5w?~@``yUDFbrNN`{3Q_M=d YZGk`YiA~Hqr>r(U,7#?5W:qZTke[P?b
{9.AOgDUj/
 $l(pw?POWf*7edZ: Py(C=g]$nNB }uiI/7
e
k%+DrH(/ N}P6w]|!"4FV1<;wq<-6gMvw?IanF8)?TL7.+a%l	.(8'@|EE#.6>gP^.&@73',2<5b4CaozmT|yQ|(qc(8c0!{=S2b/-j
8hR[Mh']lFr`3'TY|0bU8T:\fdktol6U4>$aRu4~
2*x)_8wwVgoVB5jm_l3	NJ2j	ga|#<<v((+Hu|(ssf\]!Tvf.e;Wdp#A)]cMHBpb7hzp91}Db/6"&wqNH,
63av2x]Q{*INx?4N&\l:=	?|5>4e@E2+Epm5[o<vJ6b#LI\the**<[>I4`	`*?mZw2E"q
S
 1/uD9Z3084eR;P fl7NiQyp}^XG#Ym}1?|	Z@=ca(w4xEdkE#4I	aS[I8rOv/|-"x}Y034KUv1f#rt._ :OfteFQ>K7+7`c;56s`NsAS?q3}S0_'rTN]R=Sls,AAj]{Em#"x]Th}"s#9]n*R~\9oS%GDxKOSOeK"abmz2%j8:gh`{AkRXsw6_3BVUPcu,7(qFKmu@OLnTSOH_eOM09PPd(&u=+D*7	42w/2fJcQ
|v/5I 5!c	LVYWFP}yp2*h8DLANy:+.E9Wwh{X7h0,dv]hp[eN!fG_,:vzpBpnCp\JjJ1\]tK,[Py>ccZ Z07hj{c5$j[OY|S=cs(~@}u>~nV_0&`<8 |'{'D
7J!QRx	#PG>bwHm6uJ.HmL/F5Av7DL8{x\{zzdkM8{)>,uD$w_$ZaJP}[fm>;DEfh)R2c@yvq}3Qr^ms*wB{{ka<rSO,Q#web=<aj1	!F {	(-"Mcy36dxWHQIYZ(/o(3~>?<s}=\o{DV JZeTnZ|6/,`?<WT*&>j|;+C7V|tn< (Ci<3D80TPn)~tvU}Obsrkm3&UqGJr8-3ubWJX:_rv) .[{D: LAfR,RCWu*wk. SPR*:7mFpG[&jg{@Rjk'!xGnE;+^0tO:}F]6,\aFk0UC9gNIh]cRm[bm$M0Lt5wpRL>}[[W'NhO<!K,C8O487NF/H|qQ'Olt~Juw0oC][ #w&D&A^,]}%+s^P7:5b.BX")QOm83F`4^q4dy5C~C' 0R?3pIQ1Bl-7p3	
K^CtV<L5a2NG<<lPa7Z^2R%K>w?m8-_)S?F2bl	62c5O =\|frmW0by9.!}1fM[HA~%1F6B1nR;dvcY&'(07O}C}VYB'I_ #>d<hu)b:QwO[V,ETR\1=-u<6>!2ZK0;(\v{C;vu3%-UK\z7WZ2TPY
3w)	
2`P)FfwffZuei_"S[%sE0F\ceL8:Lx/?Hv%,sw3~XjZj
PIZ{17JxG|0(}+?+jy`}U90\1Ij!=U9+|7g!=; 5Zysga#
yQ&0uEpU>`^2g@1-W3#m?RI!`HUY5m3e/Ep#1x@!25+GIvf5/MYQeyaSL
%!=?)/)d[3FW[E@Z2$ s=5+I.^C%a
bFK
;RGR4\+T(:Pzx02N?.<{
0gCKTvqgv.X-P(=R>2PUdb0O D0%2EVNJ}S`w0%c8{SG{w*
wG$z'p74]_]Y_u	;cFU@G{p(:j7X{f g)o0=+.V\>yXGgX7kj1'mF;xO<RH( Hk>	o\=K2M[~S!aSZ^]VFxD_m6E>a$%5 xbE r,`:FWV)Ujk"pU`5!S(+]QCJMI5p.P9{fP	0 7_PBrA+?@n?0	 o=@|.C~d,(
!bHh{33'#".f"*wX>$, "	a['%jl%-!i6@Mk? /m?:/HZZhi=	LiTN`2BX!M/,6v[J0q=g3?KWvoR1/?^e-YO2-Ox<VZX5i|zs-+[/VDbC6s8<"[0"
GoPw_{6L,/!#=P#<b\ZB|as5qd>6g&;XMfA7O)mN|CG[.]E8-8   @DT +qrnjiNQ^r\)Z?6Z9q Z\oc/4+UA@.JvTqqj
N<uxZWuO#)ce0Q7m|o^Jp*"p~B_Jcd(aKb{-ED4f[[_.Y(=*@JqwQ$Qgp@gE2KHx?!7J!:}F.d+iM9P4};M|xx1cas/kv@G7"!9~bjk]P$NNbt~DUkc6h)z"=oh(Bahu*&e0cM PGWWV)3rG_XXb!:6B"leixuB
~~I#=#!ziS[c]4pmQUc;N_*D:Ld%`]cax^F]>GtmyO*T>:sG7W%	DL+Htb
;=^PWeJ\ (Ay{NB,NwFcty5\f+CO;|5 , rFNCV>"4U]hZ2UJ5])i :wo_L[z}BZ/R>~	KSa]GB}znz/Jg+l`lk[,~d\d{RG}p^~H*OqBW7J'^pM(GV' Z{b#40X? A|}v7(\=_X %4%3owaQr^()K:{0 FbHF[G_\MsZbM
x iF^"^rH)b^=&{"`|GbU@Cy aN|joe!8I]_otC]3KPqqEb +P*8
#E=(x	Qfz"&DUWv:M! pIHuJg.@\ ~EE_-,v/OVg73&:9l@,nyJd=Eqm0CwIVk_f\:{}3Yn%?;E )iPbp^c"v8.GrSEGd.\{R7ZIPJVvimp@>g|mncy0CMI R6]|PgC8f6\Hu
lR?}4au0v;%(n0 C|V\"Z5$ ;|OGfDm%1IfM@t)2/!}%t+Fs 8G[>P\w06cPxK Oon:`x-Wg4Kv
iRm@y/1,:,amV5~b2v(<>7)e#d,ysPx"7RCRuK-Z\Lm5[J)0.Hv<-D@Zg|*g^&y{cy	bZDs6 ^=,(*3.|&7HI?K[xT8nlW>OY;U~vvRDYp4u#y,NxW\7Q'3s<Fp~fE%	btyWb7ReE~ga{ "V&/{G{H"-edY _vufB2UaAAb`Xj$omsH^>.j34=f6LVFN9 tsi`L'3kY[;?PK   BGPIS   I  	   tile0.pngsb``p	b``2Y8WA G1 C/``<`AYeSB PK    BGP  	                   docData.jsonPK    BGPs  O  
                layer0.pngPK    BGPIS   I  	               tile0.pngPK         W    class SystemEvents {
  static Init { "sys-init" }
  static Update { "sys-update" }
  static Draw1 { "sys-draw1" }
  static Draw2 { "sys-draw2" }
  static Draw3 { "sys-draw3" }
  static Draw4 { "sys-draw4" }
}

class InputEvents {
  static Update { "inp-update" }
}

class MapEvents {
  static Load { "map-load" }
}

class PlayerEvents {
  static Init { "plr-init" }
  static Move { "plr-move" }
  static Room { "plr-room" }
}

import "architecture" for Pipeline
import "container" for GlobalContainer
import "platform" for Application, Event

import "./game/events" for SystemEvents
import "./game/infrastructure" for EventQueue, GameEvent, GameSystem

var sys = GameSystem.new("main",256)

var time = 0
var iterations = 0

Application.onUpdate {|args|
  var c = System.clock
  sys.update()
  time = time + (System.clock -c)
  iterations = iterations + 1
}

Application.on(Event.Quit){|args|
  var ms = (time / iterations) * 1000
  System.print("Avg. Frame Time %(ms)")
}

import "./game/input/index"
import "./game/movement/index"
import "./game/map/index"
import "./game/collision/index"
import "./game/graphics/index"import "data" for Ringbuffer
import "./game/events" for SystemEvents

class GameEvent {

  id { _id }
  payload { _payload }
  payload=(v) { _payload = v }

  construct new(id){
    _id = id
    _payload = null
  }

  construct new(id, payload){
    _id = id
    _payload = payload
  }
}

class EventQueue {

  count { _queue.count  }

  construct new(size){
    _queue = Ringbuffer.new(size)
    _handlers = {}
    _debug = false
    _profile = false
  }

  debug=(v) { _debug = v }
  profile=(v) { _profile = v }

  add(gameEvent){
    _queue.enqueue(gameEvent)
  }

  subscribe(id, handler){
    if(!_handlers.containsKey(id)) _handlers[id] = []
    _handlers[id].add(handler)
  }

  subscribeCombined(ids, handler){
    var count = ids.count
    var ctr = 0
    var ret = List.filled(count, null)
    for(i in 0...count){
      var called = false
      subscribe(ids[i]){|ev|
        if(!called) {
          called = true
          ctr = ctr+1
        }
        ret[i] = ev
        if(ctr == count) handler.call(ret)
      }
    }
  }

  dispatchNext(){
    if(count == 0) return false
    var ev = _queue.dequeue()
    var handlers = _handlers[ev.id]
    if(_debug) System.print("EQ: Dispatch '%(ev.id)'")
    if(handlers){
      for(h in handlers){
        h.call(ev)
      }
    }
    return true
  }
}

var InitEvent = GameEvent.new(SystemEvents.Init)
var UpdateEvent = GameEvent.new(SystemEvents.Update)
var DrawEventLayer1 = GameEvent.new(SystemEvents.Draw1)
var DrawEventLayer2 = GameEvent.new(SystemEvents.Draw2)
var DrawEventLayer3 = GameEvent.new(SystemEvents.Draw3)
var DrawEventLayer4 = GameEvent.new(SystemEvents.Draw4)

class GameSystem {
  
  static attach(id, fn){
    fn.call(__systems[id])
  }

  id { _id }
  queue { _queue }

  construct new(id, queueSize){
    _id = id
    _queue = EventQueue.new(queueSize)
    __systems = __systems || {}
    __systems[id] = this

    _queue.add(InitEvent)
  }

  update(){
    _queue.add(UpdateEvent)
    var count = queue.count
    _queue.add(DrawEventLayer1)
    _queue.add(DrawEventLayer2)
    _queue.add(DrawEventLayer3)
    _queue.add(DrawEventLayer4)
    for(i in 0...count){
      _queue.dispatchNext()
    }
  }
}
import "./game/infrastructure" for GameSystem
import "./game/events" for PlayerEvents, MapEvents

import "./game/collision/player" for PlayerCollisionComponent

GameSystem.attach("main"){|s|

  var comp = PlayerCollisionComponent.new()

  s.queue.subscribe(PlayerEvents.Init){|e|
    comp.start(e.payload)
  }

  s.queue.subscribe(MapEvents.Load){|e|
    var map = e.payload.map
    s.queue.subscribe(PlayerEvents.Move){|e|
      comp.update(map)      
    }
  }

}import "math" for Vec2, Vec3

class PlayerCollisionComponent {
  construct new(){
  }

  start(playerState){
    _pos = playerState["position"]
    _heading = playerState["heading"]
    _target = playerState["target"]
    _delta = playerState["delta"]
    _forward = playerState["forward"]
    _lastPos = Vec3.zero()
    _pos2d = Vec2.zero()
    _delta2d = Vec2.zero()
    _posFloor = Vec2.zero()
    _a = Vec2.zero()
    _b = Vec2.zero()
    _c = Vec2.zero()
    _d = Vec2.zero()
    _offset = 0.25
    //_posFrac = Vec2.zero()
    _i = 0
    _v2inv = [-1,-1]
    _frac = Vec2.zero()
  }

  update(map){
    Vec2.set(_pos[0], _pos[2], _pos2d)
    //Vec2.set(_delta[0], _delta[2], _delta2d)
    //Vec2.add(_pos2d,_delta2d,_pos2d)

    Vec2.add(_pos2d, -_offset, -_offset, _a)
    Vec2.add(_pos2d, -_offset, _offset, _b)
    Vec2.add(_pos2d, _offset, _offset, _c)
    Vec2.add(_pos2d, _offset, -_offset, _d)

    var a = !map[_a[0].floor,_a[1].floor].isPassable
    var b = !map[_b[0].floor,_b[1].floor].isPassable
    var c = !map[_c[0].floor,_c[1].floor].isPassable
    var d = !map[_d[0].floor,_d[1].floor].isPassable

    // left
    if(a && b){
      _pos[0] = _a[0].ceil + _offset
    }
    // right
    if(c && d) {
      _pos[0] = _c[0].floor - _offset
    }
    // up
    if(a && d){
      _pos[2] = _a[1].ceil + _offset
    }
    // down
    if(b && c){
      _pos[2] = _b[1].floor - _offset
    }

    // corner cases


    // up-left
    if(a && !(b || c || d)){
      Vec2.frac(_a,_frac)
      _frac[0] = 1 - _frac[0]
      _frac[1] = 1 - _frac[1]
      // left      
      if(_frac[0] < _frac[1]){
        _pos[0] = _a[0].ceil + _offset
      // up
      } else {
        _pos[2] = _a[1].ceil + _offset
      }
    }

    // down-left
    if(b && !(a || c || d)){
      Vec2.frac(_b,_frac)
      _frac[0] = 1 - _frac[0]
      // left
      if(_frac[0] < _frac[1]){
        _pos[0] = _a[0].ceil + _offset
      // down
      } else {
        _pos[2] = _b[1].floor - _offset
      }
    }

    // down-right
    if(c && !(a || b || d)){
      Vec2.frac(_c,_frac)
      // right
      if(_frac[0] < _frac[1]){
        _pos[0] = _c[0].floor - _offset
      // down
      } else {
        _pos[2] = _b[1].floor - _offset
      }
    }

    // up-right
    if(d && !(a || b || c)){
      Vec2.frac(_d,_frac)
      _frac[1] = 1 - _frac[1]
      // right
      if(_frac[0] < _frac[1]){
        _pos[0] = _c[0].floor - _offset
      // up
      } else {
        _pos[2] = _a[1].ceil + _offset
      }
    }

    //Vec3.add(_pos, _forward, _target)
    // _delta[0] = _delta2d[0]
    // _delta[2] = _delta2d[1]

  }
}import "graphics" for Shader, Renderer, Geometry, Mesh, Node, UniformType, RendererFeature, Texture, DiffuseMaterial, TextureFilters, TextureWrap
import "platform" for Application, Event
import "helpers" for CameraHelpers
import "geometry" for GeometryData, AttributeType
import "math" for Mat4, Noise, Vec3, Vec4
import "memory" for FloatVecAccessor, UShortAccessor, Grid
import "camera" for OrthograficCamera
import "gltf" for Gltf
import "image" for Image
import "2d" for Tileset, AbstractBatch, SpriteBatch, Quad

import "./game/infrastructure" for GameSystem
import "./game/events" for SystemEvents, MapEvents, PlayerEvents

GameSystem.attach("main"){|sys|
  sys.queue.subscribeCombined([PlayerEvents.Init, MapEvents.Load]){|evs|
    var playerState = evs[0].payload
    var mapState = evs[1].payload

    var scale = 4
    var cam = OrthograficCamera.new()
    var target = Vec3.zero()
    var txt = Texture.fromImage(mapState.image, {"magFilter": TextureFilters.Nearest, "minFilter": TextureFilters.Nearest, "mipmaps": false })
    var batch = SpriteBatch.new(txt,3)
    var s = Quad.new(0,0,txt.width,txt.height)
    var t = Quad.new(0,0,txt.width * scale, txt.height * scale)
    
    batch.setSprite(0, s,t, [255,255,255,128])
    s.set(1,1,1,1)
    t.set(0,0,scale/2, scale/2)
    batch.setSprite(1, s, t, [255,0,0,255])
    batch.setSprite(2, s, t, [255,255,0,255])
    
    var pointer = Quad.clone(t)
    var pointertarget = t
    
    sys.queue.subscribe(SystemEvents.Update){|ev|
      var p = playerState["position"]
      var t = playerState["heading"]
      Vec3.mulV(t,0.5,target)
      Vec3.add(p, target, target)

      // update pointer
      pointer.set(p[0]*scale-scale/4,p[2]*scale-scale/4,scale/2, scale/2)
      batch.setTarget(1, pointer)
      pointertarget.set(target[0]*scale-scale/4,target[2]*scale-scale/4,scale/2, scale/2)
      batch.setTarget(2, pointertarget)
    }

    sys.queue.subscribe(SystemEvents.Draw2){|ev|
      Renderer.set2d()
      cam.enable()
      batch.draw()      
    }

  }
}import "math" for Mat4, Noise, Vec3, Vec4
import "component" for Component
import "graphics" for Renderer, UniformType
import "camera" for PointAtCamera

import "./game/graphics/gfx" for Gfx
import "./game/graphics/lightmap" for Lightmap
import "./game/graphics/quad3d" for Quad3d, EmptyQuad, QuadOrientation, QuadBatch
import "./game/graphics/gfx_db" for GfxDb
import "./game/graphics/billboard" for BillboardBatch
import "./game/graphics/cube" for CubeBatch

import "./game/events" for SystemEvents, MapEvents, PlayerEvents
import "./game/infrastructure" for EventQueue, GameEvent, GameSystem

class GeometryBuilder {
  
  construct new(map, gfxDb){
    _map = map
    _gfxDb = gfxDb
  }

  generateLights(node){
    var lightmap = Lightmap.new(_map.subGrid(node.x, node.y, node.w, node.h))
    node["lightmap"] = lightmap
    var lights = node["lights"]
    for(l in lights){
      lightmap.setLight(l.x-node.x,l.y-node.y,l.intensity,l.color)
    }
  }

  generateArea(node){
    generateLights(node)
    var lightmap = node["lightmap"]

    var cubes = CubeBatch.new(_gfxDb.texture, node.w * node.h, _gfxDb.scale)

    for(y in node.y...node.y+node.h){
      for(x in node.x...node.x+node.w){
        var v = _map[x,y]
        if(v.isPassable){
          var n = _map.neighbours(x,y)
          var l = lightmap[x-node.x,y-node.y]

          cubes.moveTo(x,y)
          cubes.setColor(l)
          
          cubes.addQuad(QuadOrientation.Up, _gfxDb.tiles[v.spriteUp])
          cubes.addQuad(QuadOrientation.Down, _gfxDb.tiles[v.spriteDown])

          for(o in 0...4){
            var orientation = o + 2
            var offset = 1
            if((orientation == QuadOrientation.Right || orientation == QuadOrientation.Front) && n[o].isDoor) offset = 3
            if(n[o].isSolid) cubes.addQuad(orientation, _gfxDb.tiles[n[o].sprite], offset)
          }
        }
      }
    }

    return cubes
  }

}


GameSystem.attach("main"){|s|
  var queue = s.queue
  var pos = Vec3.zero()
  var target = Vec3.zero()
  var gfx
  var gfxDb
  var cam
  var cubes
  var billboards
  var items
  var lights
  var map
  var enemies
  var mapState
  var playerState  
  var rooms
  var currentRoom

  var addEnemies = Fn.new{
    enemies = mapState.enemies
    for(e in enemies){
      e["billboard"] = gfxDb.billboards[e.type].instance(e.x,e.y)
    }
  }

  var updateEnemies = Fn.new{
    billboards.clear()
    for(e in enemies){
      var billboard = e["billboard"]
      billboard.offsetXY(e.x,e.y)
      billboards.addBillboard(billboard,lights[(e.x+0.5).floor,(e.y+0.5).floor])
    }
  }

  var addItems = Fn.new{
    var itemsList = mapState.items
    for(e in itemsList){
      items.addBillboard(gfxDb.billboards[e.type].instance(e.x,e.y),lights[e.x,e.y])
    }
  }

  queue.subscribe(SystemEvents.Init){|ev|
    gfx = Gfx.fromFiles()
    cam = PointAtCamera.new()
    cam.far = 500
    gfxDb = GfxDb.new("./assets/fantasy-tileset.png")
  }

  queue.subscribeCombined([MapEvents.Load,PlayerEvents.Init]){|evs|
    mapState = evs[0].payload
    playerState = evs[1].payload
    map = mapState.map
    
    billboards = BillboardBatch.new(gfxDb.texture, 4096, gfxDb.scale)
    items = BillboardBatch.new(gfxDb.texture, 4096, gfxDb.scale)

    var geoGen = GeometryBuilder.new(map, gfxDb)

    for(r in mapState.rooms){
      r["geometry"] = geoGen.generateArea(r)
    }
    cubes = mapState.startRoom["geometry"]

    addEnemies.call()
    addItems.call()
    updateEnemies.call()

    queue.subscribe(PlayerEvents.Room){|ev|
      cubes = ev.payload["geometry"]
      System.print("Room changed")
    }

    queue.subscribe(SystemEvents.Update){|ev|
      Vec3.copy(playerState["position"], pos)
      //updateEnemies.call()
      //System.print(pos)
      Vec3.mulV(pos, gfxDb.scale, pos)
      Vec3.copy(playerState["target"], target)
      Vec3.mulV(target, gfxDb.scale, target)
      cam.setPosition(pos)
      cam.setTarget(target)

      var yaw = playerState["yaw"]
      billboards.update(yaw)
      items.update(yaw)     
    }

    queue.subscribe(SystemEvents.Draw1){|ev|
      gfx.enable()
      cam.enable()
      Renderer.setUniformVec3(UniformType.FogColor, [12,50,49])
      cubes.draw()
      billboards.draw()
      items.draw()
    }

  }
}


import "./game/graphics/quad3d" for QuadBatch, Quad3d, QuadOrientation
import "math" for Vec2

class BillboardProto {
  construct new(scale, source, zoffset, size){
    _scale = scale
    _source = source
    _zoffset = zoffset
    _size = size
  }

  instance(x,y){
    return Billboard.new(_scale, x,y, _source, _zoffset, _size)
  }
}

var BillboardId = 0

class Billboard{

  source { _source }
  quad { _quad }
  offset { _offset }
  id { _id }

  construct new(scale,x,y,source){
    init(scale,x,y,source,0,1)
  }

  construct new(scale,x,y,source,z){
    init(scale,x,y,source,z, 1)
  }

  construct new(scale,x,y,source,z,size){
    init(scale,x,y,source,z,size)
  }

  init(scale,x,y,source,z,size){
    _scale = scale
    _id = BillboardId
    BillboardId = BillboardId + 1
    _source = source
    _offset = [
      (x+0.5)*scale,
      z, 
      (y+0.5)*scale]
    _quad = Quad3d.new(-((scale*size)/2),-((scale*size)/2),scale*size,scale*size,QuadOrientation.Left)
  }

  offsetXY(x,y){
    _offset[0] = (x+0.5)*_scale
    _offset[2] = (y+0.5)*_scale
  }
}

class BillboardBatch {

  transform { _quads.transform }

  construct new(texture, size, billboardSize){
    _quads = QuadBatch.new(texture, size)
    _size = size
    _quadCount = 0
  }

  addBillboard(billboard, color){
    _quads.setSource(_quadCount,billboard.source)
    _quads.setColor(_quadCount,color) 
    _quads.setTarget(_quadCount, billboard.quad)
    _quads.setOffset(_quadCount, billboard.offset)
    _quadCount = _quadCount + 1
  }

  clear(){
    _quadCount = 0
  }

  update(yaw){
    _quads.transform.identity()
    _quads.transform.rotateY(-yaw)
  }

  draw(){
    _quads.draw(_quadCount)
  }
} import "math" for Vec3
import "./game/graphics/quad3d" for QuadBatch, Quad3d

class CubeBatch {
  construct new(texture, size, cubeSize){
    _quads = QuadBatch.new(texture, size*6)
    _size = cubeSize
    _sizeH = cubeSize / 2
    _quadCount = 0
    _quad = Quad3d.new()
    _offset = Vec3.zero()
    _position = Vec3.zero()
    _dirOffsets = [
      [0,-_sizeH,0],
      [0, _sizeH, 0],
      [_sizeH, 0, 0],
      [-_sizeH, 0, 0],
      [0, 0, -_sizeH],
      [0, 0, _sizeH],
    ]
  }

  moveTo(x,y){
    Vec3.set(x * _size + _sizeH, 0, y * _size + _sizeH, _position)
  }

  addQuad(orientation, tile){
    addQuad(orientation, tile, 1)
  }

  addQuad(orientation, tile, offset){
    Vec3.mulV(_dirOffsets[orientation], offset, _offset)
    Vec3.add(_position, _offset, _offset)
    _quad.set(-_sizeH, -_sizeH, _size, _size, orientation).offset(_offset)
    _quads.setTarget(_quadCount, _quad)
    _quads.setSource(_quadCount,tile) 
    _quads.setColor(_quadCount,_color)
    _quadCount = _quadCount + 1
  }

  setColor(c){
    _color = c
  }

  draw(){
    _quads.draw(_quadCount)
  }
}import "graphics" for Shader, Renderer, UniformType, RendererFeature
import "geometry" for AttributeType

class Gfx is Shader {
  construct fromFiles(){
    var mapping = {
      "attributes": {
        "vPosition": AttributeType.Position,
        "vTexcoord": AttributeType.Texcoord0,
        "vColor": AttributeType.Color,
        "vOffset": AttributeType.Offset
      },
      "uniforms": {
        "uTexture": UniformType.Texture0,
        //"uNoise": UniformType.Texture1,
        "uProjection": UniformType.Projection,
        "uModel": UniformType.Model,
        "uView": UniformType.View,
        "uTextureSize": UniformType.TextureSize,
        "uFogColor": UniformType.FogColor
      }
    } 
    super("./shaders/terrain.vertex.glsl","./shaders/terrain.fragment.glsl", mapping)
  }

  enable(){
    Renderer.toggleFeature(RendererFeature.Blend, false)
    Renderer.toggleFeature(RendererFeature.CullFace, true)
    Renderer.toggleFeature(RendererFeature.DepthTest, true)
    super.enable()
  }
}import "image" for Image
import "graphics" for Texture, TextureFilters
import "2d" for Tileset

import "./game/graphics/billboard" for BillboardProto

class GfxDb {
  
  image { _img }
  texture { _txt }
  tileset { _tileset }
  tiles { _tiles }
  billboards { _billboards }
  scale { _scale }
  
  construct new(filename){
    _img = Image.fromFile(filename)
    _txt = Texture.fromImage(_img, { "magFilter": TextureFilters.Nearest, "minFilter": TextureFilters.NearestMipmapLinear, "mipmaps": true })
    _tileset = Tileset.new(256/32,1024/32,32,32)
    _scale = 5

    _tiles = createTiles()
    _billboards = createBillboards()
  }

  createTiles(){
    return {
      "panel_a": _tileset[0,1],
      "bump_a": _tileset[1,1],
      "panel_b": _tileset[2,1],
      "panel_b_cracked": _tileset[3,1],
      "panel_b_locked": _tileset[4,1],
      "stairs_down": _tileset[5,1],
      "stairs_up": _tileset[6,1],
      "shaft": _tileset[7,1],
      "bump_b": _tileset[0,2],
      "bump_c": _tileset[1,2],
      "wall_a": _tileset[2,2],
      "wall_b": _tileset[3,2],
      "wall_b_cracked": _tileset[4,2],
      "door_a": _tileset[5,2],
      "door_b": _tileset[6,2],
      "door_c": _tileset[7,2],
      "columns": _tileset[0,3],
      "door_d": _tileset[1,3],
      "grate": _tileset[2,3],
      "spikes": _tileset[3,3],
      "floor_checker": _tileset[4,3],
      "water": _tileset[5,3],
      "slime": _tileset[6,3],
      "stars": _tileset[7,3],
    }
  }

  createBillboards(){
    return {
      "chest": BillboardProto.new(_scale, _tileset[0,4], -1.3, 0.7),
      "chest_open": BillboardProto.new(_scale, _tileset[1,4],-1.3,0.7),
      "key_a": BillboardProto.new(_scale, _tileset[2,4],-2.2, 0.5),
      "goblin": BillboardProto.new(_scale, _tileset[0,22],-0.25, 1),
      "zombie": BillboardProto.new(_scale, _tileset[1,22],-0.25, 1),
      "skeleton": BillboardProto.new(_scale, _tileset[2,22],-0.25, 1),
      "ork": BillboardProto.new(_scale, _tileset[3,22],-0.25, 1),
      "cyclop": BillboardProto.new(_scale, _tileset[4,22],-0.25, 1),
      "cheetaman": BillboardProto.new(_scale, _tileset[5,22],-0.25, 1),
      "golem": BillboardProto.new(_scale, _tileset[6,22],-0.25, 1),
      "demon": BillboardProto.new(_scale, _tileset[7,22],-0.25, 1),
      "blobs": BillboardProto.new(_scale, _tileset[0,21],-0.25, 1),
      "blob": BillboardProto.new(_scale, _tileset[1,21],-0.25, 1),
      "scorpion": BillboardProto.new(_scale, _tileset[2,21],-0.25, 1),
      "octopus": BillboardProto.new(_scale, _tileset[3,21],-0.25, 1),
      "vampire": BillboardProto.new(_scale, _tileset[4,21],-0.25, 1),
      "mummy": BillboardProto.new(_scale, _tileset[5,21],-0.25, 1),
      "ghost": BillboardProto.new(_scale, _tileset[6,21],-0.25, 1),
      "beholder": BillboardProto.new(_scale, _tileset[7,21],-0.25, 1),

    }
  }
}
import "./game/graphics/2d"
import "./game/graphics/3d"import "math" for Vec3, Vec4
import "memory" for Grid
import "graphics" for Colors

class Lightmap is Grid {
  construct new(map){
    super(map.width, map.height, null, 0)
    _queue = []
    _visited = {}
    _map = map
    _color = [0,0,0,0]
    fill {|x,y|
      return [0,0,0,255]
    }
  }

  setLight(x,y,i){
    setLight(x,y,i,Colors.White)
  }

  setLight(x,y,i,c){
    _visited.clear()
    _queue.clear()
    var r = 0.08
    var a = 0.8
    addCell(x,y)

    while(i > 0.001){
      _depth = _queue.count
      while(_depth > 0){
        // set cell
        var cell = _queue.removeAt(0)

        Vec3.copy(c,_color)
        Vec3.mulV(_color, i, _color)
        Vec3.add(this[cell], _color, this[cell])
        Vec4.clampV(this[cell], 255, this[cell])
        
        
        x = cell % _map.width
        y = (cell/_map.width).floor
        // collect neightbours
        addCell(x-1,y)
        addCell(x,y-1)
        addCell(x+1,y)
        addCell(x,y+1)
        _depth = _depth-1
      }
      i = i * a
      a = a - r
    }
  }

  addCell(x,y){
    var idx = y*_map.width+x
    if(this.isOutOfBounds(x,y) || _map[x,y] == false || _visited.containsKey(idx)){
      return
    }
    _queue.add(idx)
    _visited[idx] = true
  }

}import "math" for Vec3, Vec2, Vec4
import "2d" for AbstractBatch
import "memory" for UByteVecAccessor, FloatVecAccessor
import "geometry" for AttributeType
import "graphics" for GraphicsBuffer, BufferUsage, Attribute, Renderer, UniformType

class QuadOrientation {
  static Up { 0 }
  static Down { 1 }
  static Left { 2 }
  static Right { 3 }
  static Front { 4 }
  static Back { 5 }
}

class Quad3d {

  Empty { EmptyQuad }

  a { _a }
  b { _b }
  c { _c }
  d { _d }

  construct new(x,y,w,h,o){
    init()
    set(x,y,w,h,o)
  }

  construct clone(q){
    init()
    copy(q)
  }

  copy(q){
    Vec3.copy(q.a,_a)
    Vec3.copy(q.b,_b)
    Vec3.copy(q.c,_c)
    Vec3.copy(q.d,_d)
  }

  transform(m){
    m.mulVec3(_a)
    m.mulVec3(_b)
    m.mulVec3(_c)
    m.mulVec3(_d)
  }

  print(){
    System.print([_a,_b,_c,_d])
  }

  construct new(){
    init()
  }

  init(){
    _a = Vec3.zero()
    _b = Vec3.zero()
    _c = Vec3.zero()
    _d = Vec3.zero()
  }

  set(x,y,w,h,o){
    if(o == QuadOrientation.Up){
      Vec3.set(x,0,y,_a)
      Vec3.set(x,0,y+h,_b)
      Vec3.set(x+w,0,y+h,_c)
      Vec3.set(x+w,0,y,_d)
    }
    if(o == QuadOrientation.Down){
      Vec3.set(x+w,0,y,_a)
      Vec3.set(x+w,0,y+h,_b)
      Vec3.set(x,0,y+h,_c)
      Vec3.set(x,0,y,_d)
    }
    if(o == QuadOrientation.Left){
      Vec3.set(0,x+w,y,_a)
      Vec3.set(0,x,y,_b)
      Vec3.set(0,x,y+h,_c)
      Vec3.set(0,x+w,y+h,_d)
    }
    if(o == QuadOrientation.Right){
      Vec3.set(0,x+w,y+h,_a)
      Vec3.set(0,x,y+h,_b)
      Vec3.set(0,x,y,_c)
      Vec3.set(0,x+w,y,_d)
    }
    if(o == QuadOrientation.Front){
      Vec3.set(x,y+h,0,_a)
      Vec3.set(x,y,0,_b)
      Vec3.set(x+w,y,0,_c)
      Vec3.set(x+w,y+h,0,_d)
    }
    if(o == QuadOrientation.Back){
      Vec3.set(x+w,y+h,0,_a)
      Vec3.set(x+w,y,0,_b)
      Vec3.set(x,y,0,_c)
      Vec3.set(x,y+h,0,_d)
    }
    return this
  }

  offset(v3){
    Vec3.add(_a, v3, _a)
    Vec3.add(_b, v3, _b)
    Vec3.add(_c, v3, _c)
    Vec3.add(_d, v3, _d)
    return this
  }
}

var EmptyQuad = Quad3d.new(0,0,0,0,0)

class QuadBatch is AbstractBatch {

  construct new(texture, size){
    super(texture, size, 3)
    _colors = UByteVecAccessor.new(4*size, 4)
    _colorsGBuffer = GraphicsBuffer.forVertices(_colors.bufferView, BufferUsage.Dynamic)
    _colorsAttribute = Attribute.fromAccessor(_colors, AttributeType.Color, true, _colorsGBuffer)
    
    _offsets = FloatVecAccessor.new(4*size, 3)
    _offsetsGBuffer = GraphicsBuffer.forVertices(_offsets.bufferView, BufferUsage.Dynamic)
    _offsetsAttribute = Attribute.fromAccessor(_offsets, AttributeType.Offset, false, _offsetsGBuffer)

    _dirty = true
    _color = [0,0,0,0]
  }

  setUniforms(){
    super.setUniforms()
    Renderer.setUniformVec2(UniformType.TextureSize, [texture.width,texture.height])
  }

  enableAttributes(){
    super.enableAttributes()
    Renderer.enableAttribute(_colorsAttribute)
    Renderer.enableAttribute(_offsetsAttribute)
  }

  setColor(n,c){
    var vo = 4 * n
    _colors[vo+0] = c
    _colors[vo+1] = c
    _colors[vo+2] = c
    _colors[vo+3] = c
    _dirty = true
  }

  setIntensity(n,v){
    Vec4.set(255*v,255*v,255*v,255,_color)
    setColor(n,_color)
  }

  setOffset(n,v){
    var vo = 4 * n
    _offsets[vo+0] = v
    _offsets[vo+1] = v
    _offsets[vo+2] = v
    _offsets[vo+3] = v
    _dirty = true
  }

  update(){
    super.update()
    if(_dirty){
      _colorsGBuffer.subDataView(_colors.bufferView)
      _offsetsGBuffer.subDataView(_offsets.bufferView)
      _dirty = false
    }
  }
}import "platform" for Application, Event, Keyboard

import "./game/events" for SystemEvents, InputEvents
import "./game/infrastructure" for EventQueue, GameEvent, GameSystem

GameSystem.attach("main"){|s|
  var queue = s.queue

  var inputState = {}
  var inputEvent = GameEvent.new(InputEvents.Update, inputState) 

  queue.subscribe(SystemEvents.Update){
    inputState["forward"] = Keyboard.isDown("W")
    inputState["backward"] = Keyboard.isDown("S")
    inputState["turn_left"] = Keyboard.isDown("Left")
    inputState["turn_right"] = Keyboard.isDown("Right")
    inputState["strafe_left"] = Keyboard.isDown("A")
    inputState["strafe_right"] = Keyboard.isDown("D")
    queue.add(inputEvent)
  }
}
class Entity {

  x { _x }
  y { _y }

  construct new(x,y){
    _x = x
    _y = y
    _tags = {}
  }

  [key] {
    return _tags[key]
  }

  [key]=(v) {
    _tags[key] = v
  }

  move(x,y){
    _x = _x + x
    _y = _y + y
  }

  pos(x,y){
    _x = x
    _y = y
  }
}

class Light is Entity {

  color { _color }
  intensity { _intensity }

  construct new(x,y,color,intensity){
    super(x,y)
    _color = color
    _intensity = intensity
  }
}

class Enemy is Entity {

  type { _type }

  construct new(x,y,type){
    super(x,y)
    _type = type
  }
}

class Item is Entity {

  type { _type }

  construct new(x,y,type){
    super(x,y)
    _type = type
  }
}import "math" for Mat4, Noise, Vec3, Vec4, Math
import "image" for Image
import "2d" for Tileset, AbstractBatch, SpriteBatch, Quad
import "container" for GlobalContainer
import "graphics" for Colors


import "./game/map/random" for ProdGen
import "./game/map/map" for LevelMap, LevelElement
import "./game/map/entity" for Light, Enemy, Item
import "./game/map/graph" for Node, SplitDir, Connection
import "./game/map/room" for RoomGenerator

class MapGen {

  map { _map }
  image { _img }
  lights { _lights }
  enemies { _enemies }
  items { _items }
  rooms { _rooms }
  startRoom { _startRoom }
  graph { _root }

  construct new(w,h, threshold){
    _w = w
    _h = h
    _map = LevelMap.new(w,h)
    _root = Node.new(Quad.new(0,0,_w,_h))
    _threshold = threshold
    _pg = ProdGen.new()
    _lights = []
    _enemies = []
    _items = []
    _enemyList = [
      "goblin",
      "zombie",
      "skeleton",
      "ork",
      "cyclop",
      "cheetaman",
      "golem",
      "demon",
      "blobs",
      "blob",
      "scorpion",
      "octopus",
      "vampire",
      "mummy",
      "ghost",
      "beholder",
    ]
    _itemList = [
      "chest"
    ]
    generate()
  }

  generate(){
    split(_root)
        
    _rooms = _root.getLeaves()
    _startRoom = _pg.select(_rooms)
    var roomGen = RoomGenerator.new(_pg, _root, _map) 
    for(r in _rooms){
      roomGen.generate(r)
      addLights(r) 
    }
    _img = _map.toImage()
  }

  addLights(n){
    var amounts = (n.w*n.h / 10).floor
    for(i in 0...amounts){
      var l = Light.new(_pg.range(n.x+1,n.x+n.w,0),_pg.range(n.y+1,n.y+n.h,0), _pg.color(), _pg.float(0.1,1))
      _lights.add(l)  
    }
  }

  addEnemies(n){
    var amounts = (n.w*n.h / 15).floor
    for(i in 0...amounts){
      var e = Enemy.new(
        _pg.range(n.x+1,n.x+n.w,0),
        _pg.range(n.y+1,n.y+n.h,0), 
        _pg.select(_enemyList))
      _enemies.add(e)  
    }
  }

  addItems(n){
    var amounts = (n.w*n.h / 30).floor
    for(i in 0...amounts){
      var e = Item.new(
        _pg.range(n.x+1,n.x+n.w,0),
        _pg.range(n.y+1,n.y+n.h,0), 
        _pg.select(_itemList))
      _items.add(e)  
    }
  }

  split(n){
    if(n.w * n.h > (_threshold * _threshold * 5)){
      n.split(_pg, _threshold)
      split(n.left)
      split(n.right)
    }
  }

}

import "2d" for Quad
import "./game/map/entity" for Entity

class SplitDir {
  static H { 0 }
  static V { 1 }
}

class Connection {

  x { _pos[0] }
  y { _pos[1] }
  a { _r1 }
  b { _r2 }

  construct new(r1, r2, pos){
    _r1 = r1
    _r2 = r2
    _pos = pos
  }
}

class Node is Entity {
  
  isLeaf { !_a && !_b }
  quad { _q }
  left { _a }
  right { _b }
  w { _q.w }
  h { _q.h }
  // x { _q.x }
  // y { _q.y }
  splitDir { _d }
  connections { _connections }
  neighboursLeft { _nLeft }
  neighboursRight { _nRight }
  neighboursUp { _nUp }
  neighboursDown { _nDown }
  neighbours { _nLeft + _nRight + _nUp + _nDown }
  
  construct new(q){
    super(q.x, q.y)
    _q = q
    _connections = []
  }

  split(pg, threshold){
    if(_q.w >= _q.h){
      _a = Node.new(Quad.new(_q.x,_q.y,pg.size(_q.w, threshold), _q.h))
      _b = Node.new(Quad.new(_q.x+_a.w,_q.y,_q.w-_a.w,_q.h))
      _d = SplitDir.H
    } else {
      _a = Node.new(Quad.new(_q.x,_q.y,_q.w, pg.size(_q.h, threshold)))
      _b = Node.new(Quad.new(_q.x,_q.y+_a.h,_q.w,_q.h-_a.h))
      _d = SplitDir.V
    }
  }

  addConnection(c){
    _connections.add(c)
  }

  leafAt(x,y){
    if(!isInside(x,y)) {
      return null
    }
    if(isLeaf) return this

    if(_d == SplitDir.H){
      if(x < (_b.x)) {
        return _a.leafAt(x,y)
      } else {
        return _b.leafAt(x,y)
      }
    } else {
      if(y < (_b.y)) {
        return _a.leafAt(x,y)
      } else {
        return _b.leafAt(x,y)
      } 
    }
  }

  collectDown(graph, cx, cy, coll){
    while(cy < (y+h)){
      var n = graph.leafAt(cx, cy)
      if(n == null) break
      cy = n.y + n.h
      coll.add(n)
    }
  }

  collectRight(graph, cx, cy, coll){
    while(cx < (x+w)){
      var n = graph.leafAt(cx, cy)
      if(n == null) break
      cx = n.x + n.w
      coll.add(n)
    }
  }

  collectNeighbours(graph){
    _nLeft = []
    _nRight = []
    _nUp = []
    _nDown = []
    collectDown(graph,x-1,y, _nLeft)
    collectDown(graph,x+w,y, _nRight)
    collectRight(graph,x, y-1, _nUp)
    collectRight(graph,x, y+h, _nDown)
  } 

  isInside(x,y){x >= this.x && x < (this.x + this.w) && y >= this.y && y < (this.y + this.h)}

  center(){
    return [_q.x+(_q.w/2), _q.y+(_q.h/2)]
  }

  getLeaves(){
    if(isLeaf) return [this]
    return _a.getLeaves() + _b.getLeaves()
  }

  toString {
    return "%(isLeaf ? "Leaf" : "Tree") at %(x),%(y) (%(w),%(h))"
  }
}import "./game/events" for SystemEvents, MapEvents
import "./game/infrastructure" for EventQueue, GameEvent, GameSystem
import "./game/map/generator" for MapGen

GameSystem.attach("main"){|s|
  var queue = s.queue


  queue.subscribe(SystemEvents.Init){|ev|
    var mapState = MapGen.new(64,64, 4)
    var loadEvent = GameEvent.new(MapEvents.Load, mapState)
    queue.add(loadEvent)
  }
}

import "memory" for Grid
import "image" for Image
import "graphics" for Colors

var Wall_
var Floor_
var Door_

class LevelElement {

  static Wall { Wall_ }
  static Floor { Floor_ }
  static Door { Door_ }

  sprite { _sprite }
  spriteDown { "panel_a" } 
  spriteUp { "floor_checker" } 
  isSolid { _flags & SOLID > 0 }
  isPassable { _flags & PASSABLE > 0 }
  isDoor { _flags & DOOR > 0 }
  flags { _flags }
  offset { _offset }
  
  construct new(flags, sprite){
    _flags = flags
    _sprite = sprite
    _offset = 0
  }

  construct new(flags, sprite, offset){
    _flags = flags
    _sprite = sprite
    _offset = offset
  }
}

var NONE = 0
var SOLID = 1 << 0
var PASSABLE = 1 << 1
var DOOR = 1 << 2

Wall_ = LevelElement.new(SOLID, "wall_a")
Floor_ = LevelElement.new(PASSABLE, "floor_checker")
Door_ = LevelElement.new(SOLID | PASSABLE | DOOR, "door_a", 0.1)

class LevelMap is Grid {
  construct new(w,h){
    super(w, h, LevelElement.Wall, LevelElement.Wall)
  }

  toImage(){
    var img = Image.new(width,height)
    this.forEachXY {|x,y,v|
      if(v == Door_) img.setPixel(x,y,Colors.Red)
      if(v == Floor_) img.setPixel(x,y,Colors.White)
    }
    return img
  }
}import "random" for Random

class ProdGen {
  construct new(seed){
    _random = Random.new(seed)
  }

  construct new(){
    _random = Random.new()
  }

  size(s, threshold){ _random.int(s-threshold*2) + threshold }
  range(a,b,threshold){ a + size(b-a, threshold) }
  color(){ [_random.int(255),_random.int(255),_random.int(255),255] }
  float(s,e){ _random.float(s,e) }
  select(list){ list[_random.int(list.count)] }
  roll(chance){ _random.int(100) < chance }
}import "math" for Mat4, Noise, Vec3, Vec4, Math
import "image" for Image
import "2d" for Tileset, AbstractBatch, SpriteBatch, Quad
import "container" for GlobalContainer
import "graphics" for Colors

import "./game/map/random" for ProdGen
import "./game/map/map" for LevelMap, LevelElement
import "./game/map/entity" for Light, Enemy, Item
import "./game/map/graph" for Node, SplitDir, Connection

class RoomGenerator {
  construct new(pg, graph, map){
    _pg = pg
    _graph = graph
    _map = map
  }

  generate(n) {
    connect(n)
    fill(n)
    lights(n)
  }

  lights(n){
    var lights = []
    n["lights"] = lights
    var c = n.center()
    lights.add(Light.new(n.x+1, n.y+1, _pg.color(), 1))
    lights.add(Light.new(n.x+n.w-1, n.y+1, _pg.color(), 1))
    lights.add(Light.new(n.x+n.w-1, n.y+n.h-1, _pg.color(), 1))
    lights.add(Light.new(n.x+1, n.y+n.h-1, _pg.color(), 1))
  }

  isFree(x,y){
    var f = LevelElement.Floor
    return _map[x,y] == f && _map[x-1,y] == f && _map[x-1,y-1] == f && _map[x,y-1] == f && _map[x+1,y-1] == f && _map[x+1,y] == f && _map[x+1,y+1] == f && _map[x,y+1] == f && _map[x-1,y+1] == f
  }

  fill(n){
    var sx = n.x+1//n.x + _pg.size(n.w-1, 2)+1
    var sy = n.y+1//n.y + _pg.size(n.h-1, 2)+1
    for(y in sy...n.y+n.h){
      for(x in sx...n.x+n.w){
        _map[x,y] = LevelElement.Floor
      }
    }
    for(y in sy...n.y+n.h){
      for(x in sx...n.x+n.w){
        if(isFree(x,y) && _pg.roll(20)){
          _map[x,y] = LevelElement.Wall
        }
      }
    }

  }

  connect(n){
    _connLeft = []
    _connUp = []
    n.collectNeighbours(_graph)
    for(nl in n.neighboursLeft){
      var start = Math.max(nl.y, n.y)
      var end = Math.min(nl.y+nl.h, n.y+n.h)
      var coords = [n.x, start + _pg.size(end-start-1,1)+1]
      var conn = Connection.new(n, nl, coords)
      _map[conn.x,conn.y] = LevelElement.Door
      n.addConnection(conn)
      nl.addConnection(conn)
      _connLeft.add(coords)
    }      
    for(nu in n.neighboursUp){
      var start = Math.max(nu.x, n.x)
      var end = Math.min(nu.x+nu.w, n.x+n.w)
      var coords = [start + _pg.size(end-start-1,1)+1, n.y]
      var conn = Connection.new(n, nu, coords)
      _map[conn.x,conn.y] = LevelElement.Door
      n.addConnection(conn)
      nu.addConnection(conn)
      _connUp.add(coords)
    }
  }
}import "math" for Mat4, Noise, Vec3, Vec4
import "container" for GlobalContainer
import "memory" for Grid

GlobalContainer.registerFactory("EnemyMovementComponent") {|c| EnemyMovementComponent.new(c.resolve("MAP"))}

class EnemyMovementComponent {
  construct new(map){
    _map = map
  }

  start(){
    _enemies = _map["enemies"]
    _t = 0
  }

  update(){
    for(e in _enemies){
      e.move(_t.sin / 150, _t.cos / 150)
    }
    _t = _t + 0.05
  }
}import "./game/movement/player"
import "./game/movement/enemy"import "math" for Mat4, Noise, Vec3, Vec4
import "memory" for Grid
import "platform" for Application, Event, Keyboard

import "./game/events" for SystemEvents, InputEvents, PlayerEvents, MapEvents
import "./game/infrastructure" for EventQueue, GameEvent, GameSystem

GameSystem.attach("main"){|s|
  var queue = s.queue

  var playerState = {}
  var moveEvent = GameEvent.new(PlayerEvents.Move, playerState)
  var roomEvent = GameEvent.new(PlayerEvents.Room, null)
  var initEvent = GameEvent.new(PlayerEvents.Init, playerState)

  var pos = Vec3.zero()
  var yaw = 0
  var forward = Vec3.zero()
  var right = Vec3.zero()
  var target = Vec3.zero()
  var delta = Vec3.zero()
  var tmp = Vec3.zero()
  var room = null

  var updatePlayerPos = Fn.new {
    Vec3.set(yaw.cos, 0, yaw.sin, forward)
    Vec3.set(-yaw.sin, 0, yaw.cos, right)
    Vec3.add(delta,pos,pos)
    playerState["yaw"] = yaw
    Vec3.add(pos, forward, target)
  }

  playerState["position"]= pos
  playerState["target"] = target
  playerState["heading"] = forward
  playerState["delta"] = delta
  playerState["forward"] = forward
  playerState["yaw"] = yaw

  queue.subscribe(MapEvents.Load){|ev|
    var graph = ev.payload.graph
    var c = ev.payload.startRoom.center()
    Vec3.set(c[0],0,c[1], pos)
    
    updatePlayerPos.call()
    queue.add(initEvent)

    queue.subscribe(InputEvents.Update){|ev|
      var inputState = ev.payload
      
      Vec3.zero(delta)
      Vec3.zero(tmp)
      var moved = false

      if(inputState["forward"]){
        Vec3.mulV(forward, 0.05, tmp)
        Vec3.add(delta, tmp, delta)
        moved = true
      }
      if(inputState["backward"]){
        Vec3.mulV(forward, -0.05, tmp)
        Vec3.add(delta, tmp, delta)
        moved = true
      }
      if(inputState["strafe_left"]){
        Vec3.mulV(right, -0.05, tmp)
        Vec3.add(delta, tmp, delta)
        moved = true
      }
      if(inputState["strafe_right"]){
        Vec3.mulV(right, 0.05, tmp)
        Vec3.add(delta, tmp, delta)
        moved = true
      }
      if(inputState["turn_left"]){
        yaw = yaw - 0.03
      }
      if(inputState["turn_right"]){
        yaw = yaw + 0.03
      }

      updatePlayerPos.call()
      if(moved) queue.add(moveEvent)
      var px = pos[0].floor
      var py = pos[2].floor
      if(room == null || !room.isInside(px,py)){
        room = graph.leafAt(px,py)
        roomEvent.payload = room
        queue.add(roomEvent)
      }
    }
  }


}

import "platform" for Application, Severity, Window
import "./game/index"

var width = 640
var height = 400

Application.onInit {|args|
  //Application.logLevel(Severity.Debug)
  Application.logLevel(Severity.Info)
  Window.config(width,height,"Light test!")
}